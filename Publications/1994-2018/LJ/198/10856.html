<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"><html><head><META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>
At the Forge</title><link rel="stylesheet" href="../css/archive.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.57.0"><meta name="description" content="&#10;Meet the non-relational database that scales to handle even Amazon- and&#10;Facebook-size loads.&#10;"><link rel="stylesheet" href="../../css/archive.css" type="text/css"><script type="text/javascript" src="../../js/archive.js"></script><script type="text/javascript" src="../../js/highlight.js"></script></head><body onload="search_highlight();">
  <div class="headerdiv">
    <a href="../../index.html">
      <img class="topimg" src="../../images/CD_HeaderBanner.png" alt="LJ Archive"/>
    </a>
  </div>
  
  <div class="tophrdiv">
  </div>
  
  <div id="top_search">
  <table class="page_search" summary="">
    <tr>
      <td valign="top" align="left">
        <p class="small_shutdown"><a href="/.exit">Shutdown Archive web server</a></p>
      </td>
      <td valign="top" align="right">
        <form method="get" action="/zoom/search.cgi">
          <input type="hidden" name="zoom_sort" value="0" />
          <input type="hidden" name="zoom_xml" value="0" />
          <input type="hidden" name="zoom_per_page" value="10" />
          <input type="hidden" name="zoom_and" value="1" />
          Search: <input type="text" name="zoom_query" size="20" value="" class="zoom_searchbox" />
          <input type="submit" value="Submit" />
        </form>
      </td>
    </tr>
  </table>
  </div>
  <div class="article" lang="en"><div class="titlepage"><div><h1 class="title"><a name="N0x153c580.0x1633ac0"></a>
At the Forge</h1></div><div><h3 class="subtitle"><i>
Cassandra
</i></h3></div><div><div class="author"><h3 class="author">
Reuven
 M. 
Lerner
</h3></div><div class="issuemoyr">Issue #198, October 2010</div></div><div><p>
Meet the non-relational database that scales to handle even Amazon- and
Facebook-size loads.
</p></div></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x153c580.0x1634358"></a></h2></div></div><p>
The past few months, I've covered a number of different
non-relational (NoSQL) databases. Such databases are becoming
increasingly popular, because they offer both easier (and sometimes
greater) speed and scalability than relational databases typically
can provide. In most cases, they also are &ldquo;schemaless&rdquo;, meaning you
don't need to predefine or declare the names, types and sizes of the
data you are storing. This also means you can store persistent
information with the ease and flexibility of a hash table.
</p><p>
I'm still skeptical that these non-relational databases always
should be used in place of their relational counterparts. Relational
databases have many years of thought, development and debugging
behind them. But, relational databases are designed for reliability
and for arbitrary combinations of data. NoSQL databases, by contrast,
are designed for speed and scalability, without &ldquo;joins&rdquo; and other
items that are a central pillar of relational queries.
</p><p>
Thus, I've come to believe that relational databases still have an
important role to play in the computer world, and even in the world of
high-powered Web applications. However, just as the introduction of
built-in strings, arrays, hash tables and other sophisticated data
structures have made life easier for countless programmers, I feel
that non-relational databases have an important role to play, offering
developers a new mix of interesting and useful ways to store and
retrieve data.
</p><p>
To date, I have explored several non-relational systems in this
column. CouchDB and MongoDB are both &ldquo;document&rdquo; databases, meaning
they basically allow you to store collections of name-value pairs
(hashes, if you like) and then retrieve elements from those
collections using various types of queries. CouchDB and MongoDB are
quite different in how they store and retrieve data, and they also approach
replication differently.
</p><p>
Both CouchDB and MongoDB are closer in style and spirit to one another
than to the system I covered last month, Redis&mdash;a key-value store
that's extremely fast but limits you to querying on a
particular key, and with a limited set of data types. Plus, Redis
assumes you have a single server. Although you can replicate to a
secondary server, there is no partitioning of the data or the load
among more than one node.
</p><p>
Cassandra is a little like all of these, and yet it's quite different
from any of them. Cassandra stores data in what can be considered a
multilevel (or multidimensional) hash table. You can retrieve
information according to the keys, making it like a key-value store,
like Redis or Memcached. But, Cassandra allows you to ask for a range
of keys, giving it a bit of extra flexibility. Moreover, the
multidimensional nature of Cassandra, its use of &ldquo;super columns&rdquo; to
store multiple items of a similar type and its storage of name-value
pairs at the bottom level provide a fair amount of flexibility.
</p><p>
Cassandra really shines when it comes to many aspects of
scalability. You can add nodes, and Cassandra 
integrates them into the storage system seamlessly. Nodes can die or be removed,
and the system handles that appropriately. All nodes eventually
contain all data, meaning even if you kill off all but one of the
nodes in a Cassandra storage cluster, the system should continue to
run seamlessly. Because writes are distributed across the different
nodes, it takes a very short time to write new data to Cassandra.
</p><p>
It's clear that Cassandra has resonated with a large number of
developers. The project started at Facebook, in order to solve the
problem of searching through users' inboxes. Facebook donated the
code to the Apache Project, which has since promoted it and made it a
first-class project. Facebook no longer participates in the
open-source version of Cassandra, but apparently Facebook still uses it on
its systems. Meanwhile, companies including Rackspace, Twitter and
Digg all have become active and prominent Cassandra users,
contributing code and contributing to the general sense of momentum that Cassandra
offers.
</p><p>
Perhaps the two biggest hurdles I've had to overcome in working
with Cassandra are the unusual terminology and the configuration and
administration that are necessary. The terminology is difficult in
part because it uses existing terms (&ldquo;column&rdquo; and
&ldquo;row&rdquo;, for example)
in ways that differ from what I'm used to with relational databases.
It's not hard, but does take some getting used to. (Although the
developers might have done everyone a favor by avoiding such terms as
&ldquo;column families&rdquo; and &ldquo;super columns&rdquo;.) The configuration aspects
aren't terribly onerous, but perhaps point to how spoiled people have gotten
when working with non-relational databases. The fact that I have to
name my keyspaces and column families in a configuration file, and then
restart Cassandra so that their definition will take effect, seems
like a throwback to older, more rigid systems. However, relational
databases force us to define our tables, columns and data types before we can
use them, and it never seemed like a terrible burden. And, it seems that part of
the secret of Cassandra's speed and reliability is the fact that its data
structures are rigidly defined.
</p><p>
This month, I take an initial look at getting Cassandra up and
running and explain how to store and retrieve data inside a simple
Cassandra instance.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x153c580.0x1634b40"></a>
Installation</h2></div></div><p>
The home page for Cassandra is <a href="http://cassandra.apache.org" target="_self">cassandra.apache.org</a>. From
there, you can download Cassandra and install it on your computer.
Because Cassandra is written in Java, there is only one distribution
binary, which should work on any computer with a current JVM.
</p><p>
On my computer running Ubuntu, I first installed the latest Java JDK
with:

<pre     class="programlisting">
apt-get install openjdk-6-jdk
</pre>
</p><p>
Following this, I could have downloaded the latest Cassandra version
and installed it. But instead, I decided to use apt-get to
retrieve the latest version and to ensure that I will receive updates
in the future. In order to do this, I first needed to add the
appropriate GPG keys to my keychain, as per the instructions on the
Cassandra Wiki:


<pre     class="programlisting">
gpg --keyserver wwwkeys.eu.pgp.net --recv-keys F758CE318D77295D
gpg --export --armor F758CE318D77295D | sudo apt-key add -
</pre>
</p><p>
Following that, I added these two lines to /etc/apt/sources.list:


<pre     class="programlisting">
deb http://www.apache.org/dist/cassandra/debian unstable main
deb-src http://www.apache.org/dist/cassandra/debian unstable main
</pre>
</p><p>
Next, I ran <tt  >apt-get update</tt> to retrieve the latest version information
for all packages, and then I ran <tt  >apt-get install
cassandra</tt> to install it on
the server. About a minute later, Cassandra was installed and ready
to run on my machine.
</p><p>
I started it up with:

<pre     class="programlisting">
/etc/init.d/cassandra start
</pre>
</p><p>
Sure enough, a quick peek at <tt  >ps</tt> showed me that
Cassandra indeed was running.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x153c580.0x16351c8"></a>
Talking to Cassandra</h2></div></div><p>
There are numerous interfaces to Cassandra from a variety of
programming languages. However, the easiest way to connect to
Cassandra often is via its built-in command-line interface (CLI),
which comes with the program. Simply enter
<tt  >cassandra-cli</tt> in your
shell, and you'll see a prompt that looks like this:


<pre     class="programlisting">
Welcome to cassandra CLI.

Type 'help' or '?' for help. Type 'quit' or 'exit' to quit.
cassandra&gt;
</pre>
</p><p>
Your first task should be to connect to your local Cassandra server:

<pre     class="programlisting">
cassandra&gt; connect localhost/9160
Connected to: "Test Cluster" on localhost/9160
</pre>
</p><p>
In case you forgot what was just printed, you can get the current
cluster name with:

<pre     class="programlisting">
cassandra&gt; show cluster name
Test Cluster
</pre>
</p><p>
You also can get a list of keyspaces in this cluster:

<pre     class="programlisting">
cassandra&gt; show keyspaces
Keyspace1
system
</pre>
</p><p>
The <tt  >system</tt> keyspace, as you can imagine, is used for Cassandra
system tasks. It can be fun and interesting to explore, but you don't
want to mess with it unless you really know what you're doing.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x153c580.0x16356f0"></a>
Configuration</h2></div></div><p>
What if you want to create a new keyspace? Well, that's where you'll 
need to go in and change the system's configuration and restart
Cassandra. The configuration file you need to modify is
called storage-conf.xml. After I installed Cassandra on my Ubuntu
system, it was placed in /etc/cassandra/storage-conf.xml. (The
filename always will be storage-conf.xml, but the location might
differ on your machine, depending on how you installed it.) You 
can see the contents of this configuration file from the
Cassandra CLI, with the command:

<pre     class="programlisting">
cassandra&gt; show config file
</pre>
</p><p>
However, this command shows only the contents of the file, not its
location, so you might have to poke around a bit to find
it.
</p><p>
To add a new keyspace to your Cassandra cluster, first you must think
about what you want to store and then how you can represent that in
Cassandra. As an example, let's store a list of users.
You don't need to think beyond that right now; all you need to define is
the name of your column family. Individual columns and values can and
will be defined on the fly.
</p><p>
To do this, define a new keyspace and one new column family. Each
column family is analogous to a table in a relational database; it
contains zero or more columns. Each column, in turn, is a name-value
pair. Thus, by defining your keyspace as follows, you're basically saying you
want to store information about users:

<pre     class="programlisting">

&lt;Keyspace Name="People"&gt;
&lt;ColumnFamily Name="Users" CompareWith="BytesType"/&gt;
&lt;/Keyspace&gt;
&lt;/Keyspaces&gt;

</pre>
</p><p>
Like a relational database, you'll be able to store many fields of
information about these users. Unlike a relational database, you don't
need to define them from the start. Also unlike a relational
database, you'll be able to retrieve information about users only via
the key you use for this column family. So, if you use e-mail addresses
as keys into the &ldquo;Users&rdquo; column family, you'll need an address to do
something; having the person's first and last name will not do you
much good.
</p><p>
Cassandra stores information as a set of bytes; there are no internal
types. However, you can (and should) indicate to Cassandra how the
data should be sorted. Specifying a &ldquo;comparator&rdquo; allows you to simulate
the storage of different types. More important, it determines the
order in which you will receive results. That's because there is no
ORDER BY equivalent in Cassandra when you retrieve data; you need to
decide on an order and specify it in the configuration file.
Somewhat surprisingly, the ordering is done when the data is written,
not when it is read. In the case of the example &ldquo;Users&rdquo; column
family, you'll
just retrieve them in byte order.
</p><p>
If you put the above &lt;Keyspace&gt; section inside the &lt;Keyspaces&gt; tag
in your storage-conf.xml file and restart Cassandra, you'll find that
it fails to start up. (The error logs are in /var/log/cassandra, at
least in my Ubuntu installation.) That's because there are three
other definitions you need to include: ReplicaPlacementStrategy,
ReplicationFactor and EndPointSnitch. None of these definitions will
concern you when you have a single Cassandra node, so I suggest simply
copying them from the included Keyspace1 keyspace. In the end, this
part of your keyspace definition will look like this:


<pre     class="programlisting">
&lt;Keyspace Name="People"&gt;
&lt;ColumnFamily Name="Users" CompareWith="BytesType"/&gt;

&lt;ReplicaPlacementStrategy&gt;org.apache.cassandra.locator.
&#8618;RackUnawareStrategy&lt;/ReplicaPlacementStrategy&gt;
&lt;ReplicationFactor&gt;1&lt;/ReplicationFactor&gt;
&lt;EndPointSnitch&gt;org.apache.cassandra.locator.EndPointSnitch
&#8618;&lt;/EndPointSnitch&gt;
&lt;/Keyspace&gt;
</pre>
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x153c580.0x1635c70"></a>
Exploring Your Keyspace</h2></div></div><p>
Restart Cassandra, and reconnect via the CLI. Then, type:

<pre     class="programlisting">
cassandra&gt; show keyspaces
</pre>
</p><p>
Your new keyspace, &ldquo;People&rdquo;, now should appear in the list:

<pre     class="programlisting">
cassandra&gt; show keyspaces
Keyspace1
system
People
</pre>
</p><p>
You can ask for a description of your keyspace:


<pre     class="programlisting">
cassandra&gt; describe keyspace People
People.Users
Column Family Type: Standard
Columns Sorted By: org.apache.cassandra.db.marshal.BytesType@1b22920

Column Family Type: Standard
Column Sorted By: org.apache.cassandra.db.marshal.BytesType
flush period: null minutes
------
</pre>
</p><p>
You now can see that your People keyspace contains a single
&ldquo;Users&rdquo; column
family. With this in place, you can start to set and retrieve data:


<pre     class="programlisting">
cassandra&gt; get People.Users['1']
Returned 0 results.

cassandra&gt; set People.Users['1']['email'] = 'reuven@lerner.co.il'
cassandra&gt; set People.Users['1']['first_name'] = 'Reuven'
cassandra&gt; set People.Users['1']['last_name'] = 'Lerner'
</pre>
</p><p>
In Cassandra-ese, you would say that you now have set three column
values ('email', 'first_name' and 'last_name'), for one key ('1')
under a single column family (&ldquo;Users&rdquo;), within a single Keyspace
(&ldquo;People&rdquo;). If you're used to working with a language like Ruby or
Python, you might feel a bit underwhelmed&mdash;after all, it looks
like you just set a multilevel hash. But that makes sense, given that
Cassandra is a super-version of a key-value store, right?
</p><p>
Now, let's try to retrieve the data. You can do that with the key:

<pre     class="programlisting">
cassandra&gt; get People.Users['1']
=&gt; (column=6c6173745f6e616d65, value=Lerner, 
 &#8618;timestamp=1279024194314000)
=&gt; (column=66697273745f6e616d65, value=Reuven, 
 &#8618;timestamp=1279024183326000)
=&gt; (column=656d61696c, value=reuven@lerner.co.il,
timestamp=1279024170585000)
Returned 3 results.
</pre>
</p><p>
Notice how each column has its own unique ID and that the data was
stored with a timestamp. Such timestamps are crucial when you are
running multiple Cassandra nodes, and they update one another without
your knowledge to achieve complete consistency.
</p><p>
You can add additional information too:


<pre     class="programlisting">
cassandra&gt; set People.Users['2']['first_name'] = 'Atara'
cassandra&gt; set People.Users['2']['last_name'] = 'Lerner-Friedman'
cassandra&gt; set People.Users['2']['school'] = 'Yachad'

cassandra&gt; set People.Users['3']['first_name'] = 'Shikma'
cassandra&gt; set People.Users['3']['last_name'] = 'Lerner-Friedman'
cassandra&gt; set People.Users['3']['school'] = 'Yachad'
</pre>
</p><p>
Now you have information about three users, and as you can see, the
columns that you used within the &ldquo;Users&rdquo; column family were not
determined by the configuration file and can be added on the spot.
Moreover, there is no rule saying that you must set a value for the
&ldquo;email&rdquo; column; such enforcement doesn't exist in Cassandra. But what
is perhaps most amazing to relational database veterans is that there
isn't any way to retrieve all the values that have a
last_name of 'Lerner-Friedman' or a school named 'Yachad'.
Everything is based on the key (which I have set to an integer in this
case); you can drill down, but not across, as it were.
</p><p>
You can ask Cassandra how many columns were set for a given key, but you
won't know what columns those were:

<pre     class="programlisting">
cassandra&gt; count People.Users['1']
3 columns
cassandra&gt; count People.Users['2']
3 columns
</pre>
</p><p>
However, if you're trying to store information about many users, and
those users are going to be updating their information on a regular
basis, Cassandra can be quite helpful.
</p><p>
Now that you've got the hang of columns, I'll mention a particularly
interesting part of the Cassandra data model. Instead of defining
columns, you instead can define &ldquo;super columns&rdquo;. Each super column is
just like a regular column, except it can contain multiple
columns within it (rather than a name-value pair). In order to define
a super column, set the ColumnType attribute in the
storage-conf.xml file to &ldquo;Super&rdquo;. For example:

<pre     class="programlisting">
&lt;ColumnFamily Name="Users" CompareWith="BytesType" 
 &#8618;ColumnType="Super" /&gt;
</pre>
</p><p>
Note that if you restart Cassandra with this changed definition, and
then try to retrieve <tt  >People.Users['1']</tt>, you'll probably get an error.
That's because you effectively have changed the schema without changing
the data, which always is a bad idea. Now you can store and retrieve
finer-grained information:


<pre     class="programlisting">
cassandra&gt; set People.Users['1']['address']['city'] = 'Modiin'

cassandra&gt; get People.Users['1']['address']['city']
=&gt; (column=63697479, value=Modiin, timestamp=1279026442675000)
</pre>
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x153c580.0x1a2ebd0"></a>
Conclusion</h2></div></div><p>
Cassandra provides a non-relational storage and retrieval mechanism
(NoSQL database) that features tremendous scalability, speed and
flexibility. The inclusion of super columns (and super-column
families, which I didn't discuss here) gives you just enough
flexibility to store a great deal of information about many users. So
long as you never have to search on anything other than the primary
key or join information from different users at the database level,
Cassandra is a good choice.
</p><p>
That said, Cassandra is significantly harder to understand and
administer than other non-relational databases. I think the
investment of time and effort are worth it, but you shouldn't expect
to be able to work with Cassandra as quickly and easily as with, say,
CouchDB or MongoDB. The flip side of this issue is that
administration allows you to fine-tune a number of aspects of
Cassandra's networking and consistency until you reach a level with
which you're comfortable.
</p><p>
Next month, I'll continue exploring and discussing 
Cassandra, looking at ways to connect multiple Cassandra boxes to a
cluster&mdash;and what happens when you do so.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x153c580.0x1a2ed88"></a></h2></div></div><div class="sidebar"><p class="title"><b>
Resources</b></p><p>
The Cassandra home page is at <a href="http://cassandra.apache.org" target="_self">cassandra.apache.org</a>. You might
find references to another Cassandra page; it only recently
&ldquo;graduated&rdquo; to become a full-fledged Apache project, rather than an
&ldquo;incubator&rdquo; project; thus, some references will be out of date.
This page contains download links, documentation, an actively
maintained wiki and links to papers, tutorials and drivers in a
number of languages.
</p><p>
Cassandra is based on Amazon's Dynamo, the original paper for which is
useful in understanding some of the
design decisions. You can read this paper at
<a href="http://www.allthingsdistributed.com/2007/10/amazons_dynamo.html" target="_self">www.allthingsdistributed.com/2007/10/amazons_dynamo.html</a>.
</p><p>
Two complementary video talks describing Cassandra, but aimed more at
the network storage aspects (rather than the practical day-to-day
usage) are at
<a href="http://www.parleys.com/#sl=1&amp;st=5&amp;id=1866" target="_self">www.parleys.com/#sl=1&amp;st=5&amp;id=1866</a> and 
<a href="http://vimeo.com/5185526" target="_self">vimeo.com/5185526</a>.
</p><p>
Finally, although I still find the Cassandra documentation to be a bit
lacking, a growing number of blogs, tutorials and testimonials have
made their way onto the Web. Three that I particularly enjoyed were Arin
Sarkissian's &ldquo;WTF is a SuperColumn? An Intro to the Cassandra Data
Model&rdquo; (<a href="http://arin.me/blog/wtf-is-a-supercolumn-cassandra-data-model" target="_self">arin.me/blog/wtf-is-a-supercolumn-cassandra-data-model</a>), Evan
Weaver's &ldquo;Up and Running with Cassandra&rdquo; (<a href="http://blog.evanweaver.com/articles/2009/07/06/up-and-running-with-cassandra" target="_self">blog.evanweaver.com/articles/2009/07/06/up-and-running-with-cassandra</a>)
and Dominic Williams' &ldquo;HBase vs Cassandra: why we moved&rdquo; (<a href="http://ria101.wordpress.com/2010/02/24/hbase-vs-cassandra-why-we-moved" target="_self">ria101.wordpress.com/2010/02/24/hbase-vs-cassandra-why-we-moved</a>).
</p></div></div></div>
<div class="authorblurb"><p>
Reuven M. Lerner is a longtime Web developer, architect and trainer.
He is a PhD candidate in learning sciences at Northwestern University,
researching the design and analysis of collaborative on-line
communities. Reuven lives with his wife and three children in
Modi'in, Israel.

</p></div>

  <div class="toclinks">
    <a class="link1" href="../tocindex.html">Archive Index</a>
    <a class="link2" href="../198/toc198.html">Issue Table of Contents</a>
    <a class="link3" href="../198/10856.html">Article</a>
  </div>
  <div class="bottomhrdiv">
  </div>
  
  <div id="bottom_search">
  <table class="page_search" summary="">
    <tr>
      <td valign="top" align="left">
        <p class="small_shutdown"><a href="/.exit">Shutdown Archive web server</a></p>
      </td>
      <td valign="top" align="right">
        <form method="get" action="/zoom/search.cgi">
          <input type="hidden" name="zoom_sort" value="0" />
          <input type="hidden" name="zoom_xml" value="0" />
          <input type="hidden" name="zoom_per_page" value="10" />
          <input type="hidden" name="zoom_and" value="1" />
          Search: <input type="text" name="zoom_query" size="20" value="" class="zoom_searchbox" />
          <input type="submit" value="Submit" />
        </form>
      </td>
    </tr>
  </table>
  </div>
  
  <div class="footerdiv">
    <a href="../../index.html">
      <img class="bottomimg" src="../../images/CD_FooterBanner.png" alt="LJ Archive"/>
    </a>
  </div>
  
  <div class="copyright">
    Copyright &copy; 1994 - 2018 <cite>Linux Journal</cite>.  All rights reserved.
  </div>
  </body></html>