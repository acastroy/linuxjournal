<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"><html><head><META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>
Rapid, Secure Patching: Tools and Methods
</title><link rel="stylesheet" href="../css/archive.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.57.0"><meta name="description" content="&#10;Generate enterprise-grade SSH keys and load them into an agent for control&#10;of all kinds of Linux hosts. Script the agent with the Parallel Distributed&#10;Shell (pdsh) to effect rapid changes over your server farm.&#10;"><link rel="stylesheet" href="../../css/archive.css" type="text/css"><script type="text/javascript" src="../../js/archive.js"></script><script type="text/javascript" src="../../js/highlight.js"></script></head><body onload="search_highlight();">
  <div class="headerdiv">
    <a href="../../index.html">
      <img class="topimg" src="../../images/CD_HeaderBanner.png" alt="LJ Archive"/>
    </a>
  </div>
  
  <div class="tophrdiv">
  </div>
  
  <div id="top_search">
  <table class="page_search" summary="">
    <tr>
      <td valign="top" align="left">
        <p class="small_shutdown"><a href="/.exit">Shutdown Archive web server</a></p>
      </td>
      <td valign="top" align="right">
        <form method="get" action="/zoom/search.cgi">
          <input type="hidden" name="zoom_sort" value="0" />
          <input type="hidden" name="zoom_xml" value="0" />
          <input type="hidden" name="zoom_per_page" value="10" />
          <input type="hidden" name="zoom_and" value="1" />
          Search: <input type="text" name="zoom_query" size="20" value="" class="zoom_searchbox" />
          <input type="submit" value="Submit" />
        </form>
      </td>
    </tr>
  </table>
  </div>
  <div class="article" lang="en"><div class="titlepage"><div><h1 class="title"><a name="N0x1c5a580.0x1d51ac0"></a>
Rapid, Secure Patching: Tools and Methods
</h1></div><div><div class="author"><h3 class="author">
Charles
 
Fisher
</h3></div><div class="issuemoyr">Issue #283, November 2017</div></div><div><p>
Generate enterprise-grade SSH keys and load them into an agent for control
of all kinds of Linux hosts. Script the agent with the Parallel Distributed
Shell (pdsh) to effect rapid changes over your server farm.
</p></div></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x1c5a580.0x1d52250"></a></h2></div></div><p>
It is with some measure of disbelief that the computer science community has
greeted the recent EternalBlue-related exploits that have torn through
massive numbers of vulnerable systems
(<a href="https://en.wikipedia.org/wiki/EternalBlue" target="_self">https://en.wikipedia.org/wiki/EternalBlue</a>). The SMB exploits have kept coming
(the most recent being SMBLoris presented at the last DEF CON, which impacts
multiple SMB protocol versions, and for which Microsoft will issue no
corrective patch:
<a href="http://securityaffairs.co/wordpress/61530/hacking/smbloris-smbv1-flaw.html" target="_self">securityaffairs.co/wordpress/61530/hacking/smbloris-smbv1-flaw.html</a>). Attacks with these tools incapacitated critical
infrastructure to the point that patients were even turned away from the British
National Health Service
(<a href="http://www.telegraph.co.uk/news/2017/05/13/nhs-cyber-attack-everything-need-know-biggest-ransomware-offensive" target="_self">www.telegraph.co.uk/news/2017/05/13/nhs-cyber-attack-everything-need-know-biggest-ransomware-offensive</a>).
</p><p>
It is with considerable sadness that, during this SMB catastrophe, we 
also have come to understand that the famous Samba server presented an
exploitable attack surface on the public internet in sufficient numbers for
a worm to propagate successfully. I previously have discussed SMB security
in <span   class="emphasis"><em>Linux Journal</em></span>, and I am no longer of the opinion that SMB server processes should run on
Linux
(<a href="http://www.linuxjournal.com/content/smbclient-security-windows-printing-and-file-transfer" target="_self">www.linuxjournal.com/content/smbclient-security-windows-printing-and-file-transfer</a>). 
</p><p>
In any case, systems administrators of all architectures must be able to
down vulnerable network servers and patch them quickly. There is often a
need for speed and competence when working with a large collection of Linux
servers. Whether this is due to security situations or other concerns is
immaterial&mdash;the hour of greatest need is not the time to begin to build
administration tools. Note that in the event of an active intrusion by
hostile parties, forensic analysis may be a legal requirement, and no steps
should be taken on the compromised server without a careful plan and
documentation (<a href="https://staff.washington.edu/dittrich/misc/forensics" target="_self">https://staff.washington.edu/dittrich/misc/forensics</a>). Especially in this new era of the black hats, computer
professionals must step up their game and be able to secure vulnerable
systems quickly.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x1c5a580.0x1d526c8"></a>
Secure SSH Keypairs</h2></div></div><p>
Tight control of a heterogeneous UNIX environment must begin with
best-practice use of SSH authentication keys. I'm going to open this section with
a simple requirement. SSH private keys must be one of three types: Ed25519,
ECDSA using the E-521 curve or RSA keys of 3072 bits. Any key that does not
meet those requirements should be retired (in particular, DSA keys must be
removed from service immediately).
</p><p>
The Ed25519 key format (<a href="https://ed25519.cr.yp.to" target="_self">https://ed25519.cr.yp.to</a>) is associated with Daniel J. Bernstein, who has such
a preeminent reputation in modern cryptography that the field is becoming a
DJB monoculture
(<a href="http://www.metzdowd.com/pipermail/cryptography/2016-March/028824.html" target="_self">www.metzdowd.com/pipermail/cryptography/2016-March/028824.html</a>). The Ed25519 format is deigned for speed, security and size
economy. If all of your SSH servers are recent enough to support Ed25519,
then use it, and consider nothing else.
</p><p>
Guidance on creating Ed25519 keys suggests 100 rounds for a work factor in
the &ldquo;-o&rdquo; secure format (<a href="https://blog.g3rt.nl/upgrade-your-ssh-keys.html" target="_self">https://blog.g3rt.nl/upgrade-your-ssh-keys.html</a>). Raising the number of rounds raises the strength of
the encrypted key against brute-force attacks (should a file copy of the
private key fall into hostile hands), at the cost of more work and time in
decrypting the key when ssh-add is executed. Although there always
is controversy and discussion with security advances
(<a href="https://news.ycombinator.com/item?id=12563899" target="_self">https://news.ycombinator.com/item?id=12563899</a>), I will repeat the
guidance here and suggest that the best format for a newly created SSH key
is this:

<pre     class="programlisting">
ssh-keygen -a 100 -t ed25519
</pre>
</p><p>
Your systems might be too old to support Ed25519&mdash;Oracle/CentOS/Red Hat 7
have this problem (the 7.1 release introduced support). If you cannot
upgrade your old SSH clients and servers, your next best option is
likely E-521, available in the ECDSA key format.
</p><p>
The ECDSA curves came from the US government's National Institute of
Standards (NIST). The best known and most implemented of all of the NIST
curves are P-256, P-384 and E-521. All three curves are approved for secret
communications by a variety of government entities, but a number of
cryptographers have expressed growing suspicion that the P-256 and P-384
curves are tainted (<a href="http://safecurves.cr.yp.to/rigid.html" target="_self">safecurves.cr.yp.to/rigid.html</a>). Well known
cryptographer Bruce Schneier has remarked
(<a href="https://en.wikipedia.org/wiki/Curve25519" target="_self">https://en.wikipedia.org/wiki/Curve25519</a>): &ldquo;I
no longer trust the constants. I believe the NSA has manipulated them
through their relationships with industry.&rdquo; However, DJB has expressed
limited praise of the E-521 curve (<a href="http://blog.cr.yp.to/20140323-ecdsa.html" target="_self">blog.cr.yp.to/20140323-ecdsa.html</a>): &ldquo;To be fair I should mention that there's
one standard NIST curve using a nice prime, namely
2<sup  >521</sup> &ndash; 1; but the sheer
size of this prime makes it much slower than NIST P-256.&rdquo; All of the NIST
curves have greater issues with &ldquo;side channel&rdquo; attacks than
Ed25519&mdash;P-521
is certainly a step down, and many assert that none of the NIST curves are
safe. In summary, there is a slight risk that a powerful adversary exists
with an advantage over the P-256 and P-384 curves, so one is
slightly inclined to avoid them. Note that even if your OpenSSH (source)
release is capable of E-521, it may be disabled by your vendor due to patent
concerns (<a href="https://lwn.net/Articles/573166" target="_self">https://lwn.net/Articles/573166</a>), so E-521 is not an option in this case. If you cannot use DJB's
2<sup  >255</sup> &ndash; 19 curve, this command will generate an E-521 key on a capable
system:

<pre     class="programlisting">
ssh-keygen -o -a 100 -b 521 -t ecdsa
</pre>
</p><p>
And, then there is the unfortunate circumstance with SSH servers that
support neither ECDSA nor Ed25519. In this case, you must fall back to RSA
with much larger key sizes. An absolute minimum is the modern default of
2048 bits, but 3072 is a wiser choice:

<pre     class="programlisting">
ssh-keygen -o -a 100 -b 3072 -t rsa
</pre>
</p><p>
Then in the most lamentable case of all, when you must use old SSH clients
that are not able to work with private keys created with the
<tt  >-o</tt> option,
you can remove the password on id_rsa and create a naked key, then use
OpenSSL to encrypt it with AES256 in the PKCS#8 format, as first documented
by Martin Kleppmann
(<a href="http://martin.kleppmann.com/2013/05/24/improving-security-of-ssh-private-keys.html" target="_self">martin.kleppmann.com/2013/05/24/improving-security-of-ssh-private-keys.html</a>). Provide a blank new password for the keygen utility
below, then supply a new password when OpenSSL reprocesses the key:

<pre     class="programlisting">
$ cd ~/.ssh

$ cp id_rsa id_rsa-orig

$ ssh-keygen -p -t rsa
Enter file in which the key is (/home/cfisher/.ssh/id_rsa): 
Enter old passphrase: 
Key has comment 'cfisher@localhost.localdomain'
Enter new passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved with the new passphrase.

$ openssl pkcs8 -topk8 -v2 aes256 -in id_rsa -out id_rsa-strong
Enter Encryption Password:
Verifying - Enter Encryption Password:

mv id_rsa-strong id_rsa
chmod 600 id_rsa
</pre>
</p><p>
After creating all of these keys on a newer system, you can compare the file
sizes:

<pre     class="programlisting">
$ ll .ssh
total 32
-rw-------. 1 cfisher cfisher  801 Aug 10 21:30 id_ecdsa
-rw-r--r--. 1 cfisher cfisher  283 Aug 10 21:30 id_ecdsa.pub
-rw-------. 1 cfisher cfisher  464 Aug 10 20:49 id_ed25519
-rw-r--r--. 1 cfisher cfisher  111 Aug 10 20:49 id_ed25519.pub
-rw-------. 1 cfisher cfisher 2638 Aug 10 21:45 id_rsa
-rw-------. 1 cfisher cfisher 2675 Aug 10 21:42 id_rsa-orig
-rw-r--r--. 1 cfisher cfisher  583 Aug 10 21:42 id_rsa.pub
</pre>
</p><p>
Although they are relatively enormous, all versions of OpenSSH that I have used
have been compatible with the RSA private key in PKCS#8 format. The Ed25519
public key is now small enough to fit in 80 columns without word wrap, and
it is as convenient as it is efficient and secure.
</p><p>
Note that PuTTY may have problems using various versions of these keys, and
you may need to remove passwords for a successful import into the PuTTY
agent.
</p><p>
These keys represent the most secure formats available for various OpenSSH
revisions. They really aren't intended for PuTTY or other general
interactive activity. Although one hopes that all users create strong keys for all
situations, these are enterprise-class keys for major systems activities. It
might be wise, however, to regenerate your system host keys to conform to
these guidelines.
</p><p>
These key formats may soon change. Quantum computers are causing increasing
concern for their ability to run Shor's Algorithm
(<a href="https://en.wikipedia.org/wiki/Shor's_algorithm" target="_self">https://en.wikipedia.org/wiki/Shor's_algorithm</a>), which can be used to find
prime factors to break these keys in reasonable time. The largest
commercially available quantum computer, the D-Wave 2000Q
(<a href="https://www.dwavesys.com/d-wave-two-system" target="_self">https://www.dwavesys.com/d-wave-two-system</a>), effectively
presents under 200 qubits for this activity
(<a href="https://crypto.stackexchange.com/questions/40893/can-or-can-not-d-waves-quantum-computers-use-shors-and-grovers-algorithm-to-f" target="_self">https://crypto.stackexchange.com/questions/40893/can-or-can-not-d-waves-quantum-computers-use-shors-and-grovers-algorithm-to-f</a>), which is not (yet) powerful
enough for a successful attack. NIST has announced a competition for a new
quantum-resistant public key system with a deadline of November 2017
(<a href="https://yro.slashdot.org/story/16/12/21/2334220/nist-asks-public-for-help-with-quantum-proof-cryptography" target="_self">https://yro.slashdot.org/story/16/12/21/2334220/nist-asks-public-for-help-with-quantum-proof-cryptography</a>). In
response, a team including DJB has released source code for NTRU Prime
(<a href="https://ntruprime.cr.yp.to/index.html" target="_self">https://ntruprime.cr.yp.to/index.html</a>). It
does appear that we will likely see a post-quantum public key format for
OpenSSH (and potentially TLS 1.3) released within the next two years, so
take steps to ease migration now.
</p><p>
Also, it's important for SSH servers to restrict their allowed ciphers,
MACs and key exchange lest strong keys be wasted on broken crypto (3DES,
MD5 and arcfour should be long-disabled). My previous guidance on the
subject
(<a href="http://www.linuxjournal.com/content/cipher-security-how-harden-tls-and-ssh" target="_self">www.linuxjournal.com/content/cipher-security-how-harden-tls-and-ssh</a>)
involved the following (three) lines in the SSH client and server
configuration (note that formatting in the sshd_config file requires all
parameters on the same line with no spaces in the options; line breaks have
been added here for clarity):

<pre     class="programlisting">
Ciphers chacha20-poly1305@openssh.com,
        aes256-gcm@openssh.com,
        aes128-gcm@openssh.com,
        aes256-ctr,
        aes192-ctr,
        aes128-ctr

MACs    hmac-sha2-512-etm@openssh.com,
        hmac-sha2-256-etm@openssh.com,
        hmac-ripemd160-etm@openssh.com,
        umac-128-etm@openssh.com,
        hmac-sha2-512,
        hmac-sha2-256,
        hmac-ripemd160,
        umac-128@openssh.com

KexAlgorithms curve25519-sha256@libssh.org,
              diffie-hellman-group-exchange-sha256
</pre>
</p><p>
Since the previous publication, RIPEMD160 is likely no longer safe and
should be removed. Older systems, however, may support only SHA1, MD5 and
RIPEMD160. Certainly remove MD5, but users of PuTTY likely will want to
retain SHA1 when newer MACs are not an option. Older servers can present a
challenge in finding a reasonable Cipher/MAC/KEX when working with modern
systems.
</p><p>
At this point, you should have strong keys for secure clients and servers.
Now let's put them to use.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x1c5a580.0x1d536f0"></a>
Scripting the SSH Agent</h2></div></div><p>
Modern OpenSSH distributions contain the ssh-copy-id shell script for easy
key distribution. Below is an example of installing a specific, named key in
a remote account:

<pre     class="programlisting">
$ ssh-copy-id -i ~/.ssh/some_key.pub person@yourserver.com
ssh-copy-id: INFO: Source of key(s) to be installed:
   "/home/cfisher/.ssh/some_key.pub"
ssh-copy-id: INFO: attempting to log in with the new key(s),
   to filter out any that are already installed
ssh-copy-id: INFO: 1 key(s) remain to be installed --
   if you are prompted now it is to install the new keys
person@yourserver.com's password:

Number of key(s) added: 1

Now try logging into the machine, with:
   "ssh 'person@yourserver.com'"
and check to make sure that only the key(s) you wanted were added.
</pre>
</p><p>
If you don't have the ssh-copy-id script, you can install a key
manually with the following command:

<pre     class="programlisting">

$ ssh person@yourserver.com 'cat &gt;&gt; ~/.ssh/authorized_keys' &lt; \
      ~/.ssh/some_key.pub

</pre>
</p><p>
If you have SELinux enabled, you might have to mark a newly created
authorized_keys file with a security type; otherwise, the sshd server
d&aelig;mon
will be prevented from reading the key (the syslog may report this issue):

<pre     class="programlisting">
$ ssh person@yourserver.com 'chcon -t ssh_home_t 
 &#8618;~/.ssh/authorized_keys'
</pre>
</p><p>
Once your key is installed, test it in a one-time use with the
<tt  >-i</tt> option
(note that you are entering a local key password, not a remote
authentication password):

<pre     class="programlisting">
$ ssh -i ~/.ssh/some_key person@yourserver.com
Enter passphrase for key '/home/v-fishecj/.ssh/some_key':
Last login: Wed Aug 16 12:20:26 2017 from 10.58.17.14
yourserver $
</pre>
</p><p>
General, interactive users likely will cache their keys with an agent. In
the example below, the same password is used on all three types of keys that
were created in the previous section:

<pre     class="programlisting">
$ eval $(ssh-agent)
Agent pid 4394

$ ssh-add
Enter passphrase for /home/cfisher/.ssh/id_rsa: 
Identity added: ~cfisher/.ssh/id_rsa (~cfisher/.ssh/id_rsa)
Identity added: ~cfisher/.ssh/id_ecdsa (cfisher@init.com)
Identity added: ~cfisher/.ssh/id_ed25519 (cfisher@init.com)
</pre>
</p><p>
The first command above launches a user agent process, which injects
environment variables (named <tt  >SSH_AGENT_SOCK</tt> and
<tt  >SSH_AGENT_PID</tt>) into the
parent shell (via <tt  >eval</tt>). The shell becomes aware of the agent and passes
these variables to the programs that it runs from that point forward.
</p><p>
When launched, the ssh-agent has no credentials and is unable to facilitate
SSH activity. It must be primed by adding keys, which is done with
<tt  >ssh-add</tt>.
When called with no arguments, all of the default keys will be read. It 
also can be called to add a custom key:

<pre     class="programlisting">
$ ssh-add  ~/.ssh/some_key
Enter passphrase for /home/cfisher/.ssh/some_key: 
Identity added: /home/cfisher/.ssh/some_key 
 &#8618;(cfisher@localhost.localdomain)
</pre>
</p><p>
Note that the agent will not retain the password on the key.
<tt  >ssh-add</tt> uses
any and all passwords that you enter while it runs to decrypt keys that it
finds, but the passwords are cleared from memory when
<tt  >ssh-add</tt> terminates
(they are not sent to <tt  >ssh-agent</tt>). This allows you to upgrade to new key
formats with minimal inconvenience, while keeping the keys reasonably safe.
</p><p>
The current cached keys can be listed with <tt  >ssh-add
-l</tt> (from, which you can deduce
that &ldquo;some_key&rdquo; is an Ed25519):

<pre     class="programlisting">
$ ssh-add -l
3072 SHA256:cpVFMZ17oO5n/Jfpv2qDNSNcV6ffOVYPV8vVaSm3DDo
     /home/cfisher/.ssh/id_rsa (RSA)
521 SHA256:1L9/CglR7cstr54a600zDrBbcxMj/a3RtcsdjuU61VU
     cfisher@localhost.localdomain (ECDSA)
256 SHA256:Vd21LEM4lixY4rIg3/Ht/w8aoMT+tRzFUR0R32SZIJc
     cfisher@localhost.localdomain (ED25519)
256 SHA256:YsKtUA9Mglas7kqC4RmzO6jd2jxVNCc1OE+usR4bkcc
     cfisher@localhost.localdomain (ED25519)
</pre>
</p><p>
While a &ldquo;primed&rdquo; agent is running, the SSH clients may use (trusting) remote
servers fluidly, with no further prompts for credentials:

<pre     class="programlisting">
$ sftp person@yourserver.com
Connected to yourserver.com.
sftp&gt; quit

$ scp /etc/passwd person@yourserver.com:/tmp
passwd                              100% 2269    65.8KB/s   00:00

$ ssh person@yourserver.com
   (motd for yourserver.com)
$ ls -l /tmp/passwd
-rw-r--r--  1 root  wheel  2269 Aug 16 09:07 /tmp/passwd
$ rm /tmp/passwd
$ exit
Connection to yourserver.com closed.
</pre>
</p><p>
The OpenSSH agent can be locked, preventing any further use of the
credentials that it holds (this might be appropriate when suspending a
laptop):

<pre     class="programlisting">
$ ssh-add -x
Enter lock password: 
Again: 
Agent locked.

$ ssh yourserver.com
Enter passphrase for key '/home/cfisher/.ssh/id_rsa': ^C
</pre>
</p><p>
It will provide credentials again when it is unlocked:

<pre     class="programlisting">
$ ssh-add -X
Enter lock password: 
Agent unlocked.
</pre>
</p><p>
You also can set <tt  >ssh-agent</tt> to expire keys after a
time limit with the <tt  >-t</tt>
option, which may be useful for long-lived agents that must clear keys after
a set daily shift.
</p><p>
General shell users may cache many types of keys with a number of differing
agent implementations. In addition to the standard OpenSSH agent, users may
rely upon PuTTY's pageant.exe, GNOME keyring or KDE Kwallet, among others
(the use of the PUTTY agent could likely fill an article on its own).
</p><p>
However, the goal here is to create &ldquo;enterprise&rdquo; keys for critical server
controls. You likely do not want long-lived agents in order to limit the risk
of exposure. When scripting with &ldquo;enterprise&rdquo; keys, you will run an
agent only for the duration of the activity, then kill it at completion.
</p><p>
There are special options for accessing the root account with
OpenSSH&mdash;the
<tt  >PermitRootLogin</tt> parameter can be added to the sshd_config file (usually
found in /etc/ssh). It can be set to a simple <tt  >yes</tt> or
<tt  >no</tt>,
<tt  >forced-commands-only</tt>, which will allow only explicitly-authorized programs to
be executed, or the equivalent options
<tt  >prohibit-password</tt> or
<tt  >without-password</tt>,
both of which will allow access to the keys generated here.
</p><p>
Many hold that root should not be allowed any access. Michael W. Lucas
addresses the question in <span   class="emphasis"><em>SSH Mastery</em></span>
(<a href="https://www.michaelwlucas.com/tools/ssh" target="_self">https://www.michaelwlucas.com/tools/ssh</a>):
</p><div class="blockquote"><blockquote class="blockquote"><p>
Sometimes, it seems that you need to allow users to SSH in to the system as
root. This is a colossally bad idea in almost all environments. When users
must log in as a regular user and then change to root, the system logs
record the user account, providing accountability. Logging in as root
destroys that audit trail....It is possible to override the security
precautions and make sshd permit a login directly as root. It's such a bad
idea that I'd consider myself guilty of malpractice if I told you how to do
it. Logging in as root via SSH almost always means you're solving the wrong
problem. Step back and look for other ways to accomplish your goal.
</p></blockquote></div><p>
When root action is required quickly on more than a few servers, the above
advice can impose painful delays. Lucas' direct criticism can be addressed
by allowing only a limited set of &ldquo;bastion&rdquo; servers to issue root commands
over SSH. Administrators should be forced to log in to the bastions with
unprivileged accounts to establish accountability.
</p><p>
However, one problem with remotely &ldquo;changing to root&rdquo; is the statistical use
of the Viterbi algorithm
(<a href="https://people.eecs.berkeley.edu/~dawnsong/papers/ssh-timing.pdf" target="_self">https://people.eecs.berkeley.edu/~dawnsong/papers/ssh-timing.pdf</a>).
Short passwords, the <tt  >su -</tt> command and remote
SSH calls that use passwords to establish a trinary network configuration
are all uniquely vulnerable to timing attacks on a user's keyboard
movement.
Those with the highest security concerns will need to compensate.
</p><p>
For the rest of us, I recommend that <tt  >PermitRootLogin
without-password</tt> be set
for all target machines.
</p><p>
Finally, you can easily terminate <tt  >ssh-agent</tt>
interactively with the <tt  >-k</tt> option:

<pre     class="programlisting">
$ eval $(ssh-agent -k)
Agent pid 4394 killed
</pre>
</p><p>
With these tools and the intended use of them in mind, here is a
complete script that runs an agent for the duration of a set of commands
over a list of servers for a common named user (which is not necessarily
root):

<pre     class="programlisting">
# cat artano

#!/bin/sh

if [[ $# -lt 1 ]]; then echo "$0 - requires commands"; exit; fi

R="-R5865:127.0.0.1:5865" # set to "-2" if you don't want 
 &#8618;port forwarding

eval $(ssh-agent -s)

function cleanup { eval $(ssh-agent -s -k); }

trap cleanup EXIT

function remsh { typeset F="/tmp/${1}" h="$1" p="$2"; 
 &#8618;shift 2; echo "#$h"
 if [[ "$ARTANO" == "PARALLEL" ]]
 then ssh "$R" -p "$p" "$h" "$@" &lt; /dev/null &gt;&gt;"${F}.out" 
  &#8618;2&gt;&gt;"${F}.err" &amp;
 else ssh "$R" -p "$p" "$h" "$@"
 fi }    # HOST                                          PORT CMD

if ssh-add ~/.ssh/master_key
then remsh yourserver.com                                  22 "$@"
     remsh container.yourserver.com                      2200 "$@"
     remsh anotherserver.com                               22 "$@"
     # Add more hosts here.
else echo Bad password - killing agent. Try again.
fi

wait

#######################################################################
# Examples:           # Artano is an epithet of a famous mythical being
# artano 'mount /patchdir'      # you will need an fstab entry for this
# artano 'umount /patchdir'
# artano 'yum update -y 2&gt;&amp;1'
# artano 'rpm -Fvh /patchdir/\*.rpm'
#######################################################################
</pre>
</p><p>
This script runs all commands in sequence on a collection of hosts by
default. If the <tt  >ARTANO</tt> environment variable is set
to <tt  >PARALLEL</tt>, it 
instead will launch them all as background processes simultaneously and append
their <tt  >STDOUT</tt> and <tt  >STDERR</tt> to files in /tmp (this should be no problem when
dealing with fewer than a hundred hosts on a reasonable server). The
<tt  >PARALLEL</tt> setting is useful not only for pushing changes faster, but also for
collecting audit results.
</p><p>
Below is an example using the <tt  >yum update</tt> agent. The source of this
particular invocation had to traverse a firewall and relied on a proxy
setting in the /etc/yum.conf file, which used the port-forwarding option
(<tt  >-R</tt>)
above:

<pre     class="programlisting">

# ./artano 'yum update -y 2&gt;&amp;1'
Agent pid 3458
Enter passphrase for /root/.ssh/master_key:
Identity added: /root/.ssh/master_key (/root/.ssh/master_key)
#yourserver.com
Loaded plugins: langpacks, ulninfo
No packages marked for update
#container.yourserver.com
Loaded plugins: langpacks, ulninfo
No packages marked for update
#anotherserver.com
Loaded plugins: langpacks, ulninfo
No packages marked for update
Agent pid 3458 killed

</pre>
</p><p>
The script can be used for more general maintenance functions. Linux
installations running the XFS filesystem should &ldquo;defrag&rdquo;
periodically.
Although this normally would be done with cron, it can be a centralized
activity, stored in a separate script that includes only on the appropriate
hosts:

<pre     class="programlisting">

# artano-fsr 'xfs_fsr -g 2&gt;&amp;1'
Agent pid 7897
Enter passphrase for /root/.ssh/master_key:
Identity added: /root/.ssh/master_key (/root/.ssh/master_key)
#yourserver.com
#container.yourserver.com
#anotherserver.com
Agent pid 7897 killed

</pre>
</p><p>
An easy method to collect the contents of all authorized_keys files for all
users is the following <tt  >artano</tt> script (this is useful for system auditing and is coded to remove file duplicates):

<pre     class="programlisting">
artano 'awk -F: {print\$6\"/.ssh/authorized_keys\"} \
     /etc/passwd | sort -u | xargs grep . 2&gt; /dev/null'
</pre>
</p><p>
It is convenient to configure NFS mounts for file distribution to remote
nodes. Bear in mind that NFS is clear text, and sensitive content
should not traverse untrusted networks while unencrypted. After configuring
an NFS server on host 1.2.3.4, I add the following line to the /etc/fstab
file on all the clients and create the /patchdir directory. After the
change, the <tt  >artano</tt> script can be used to mass-mount the directory if the
network configuration is correct:

<pre     class="programlisting">
# tail -1 /etc/fstab
1.2.3.4:/var/cache/yum/x86_64/7Server/ol7_latest/packages 
 &#8618;/patchdir nfs4 noauto,proto=tcp,port=2049 0 0
</pre>
</p><p>
Assuming that the NFS server is mounted, RPMs can be upgraded from images
stored upon it (note that Oracle Spacewalk or Red Hat Satellite might be a
more capable patch method):

<pre     class="programlisting">
# ./artano 'rpm -Fvh /patchdir/\*.rpm'
Agent pid 3203
Enter passphrase for /root/.ssh/master_key:
Identity added: /root/.ssh/master_key (/root/.ssh/master_key)
#yourserver.com
Preparing...                          ########################
Updating / installing...
xmlsec1-1.2.20-7.el7_4                ########################
xmlsec1-openssl-1.2.20-7.el7_4        ########################
Cleaning up / removing...
xmlsec1-openssl-1.2.20-5.el7          ########################
xmlsec1-1.2.20-5.el7                  ########################
#container.yourserver.com
Preparing...                          ########################
Updating / installing...
xmlsec1-1.2.20-7.el7_4                ########################
xmlsec1-openssl-1.2.20-7.el7_4        ########################
Cleaning up / removing...
xmlsec1-openssl-1.2.20-5.el7          ########################
xmlsec1-1.2.20-5.el7                  ########################
#anotherserver.com
Preparing...                          ########################
Updating / installing...
xmlsec1-1.2.20-7.el7_4                ########################
xmlsec1-openssl-1.2.20-7.el7_4        ########################
Cleaning up / removing...
xmlsec1-openssl-1.2.20-5.el7          ########################
xmlsec1-1.2.20-5.el7                  ########################
Agent pid 3203 killed
</pre>
</p><p>
I am assuming that my audience is already experienced with package tools for
their preferred platforms. However, to avoid criticism that I've included
little actual discussion of patch tools, the following is a quick reference of RPM
manipulation commands, which is the most common package format on enterprise
systems:
</p><div class="itemizedlist"><ul type="disc"><li><p>
<tt  >rpm -Uvh <i>package</i>.i686.rpm</tt> &mdash; install or upgrade a package file.
</p></li><li><p>
<tt  >rpm -Fvh <i>package</i>.i686.rpm</tt> &mdash; upgrade a package file, if an older version is installed.
</p></li><li><p>
<tt  >rpm -e <i>package</i></tt> &mdash; remove an
installed package.
</p></li><li><p>
<tt  >rpm -q <i>package</i></tt> &mdash; list installed package name and version.
</p></li><li><p>
<tt  >rpm -q --changelog <i>package</i></tt>
&mdash; print full changelog for installed package
(including CVEs).
</p></li><li><p>
<tt  >rpm -qa</tt> &mdash; list all installed packages on the
system.
</p></li><li><p>
<tt  >rpm -ql <i>package</i></tt> &mdash; list all
files in an installed package.
</p></li><li><p>
<tt  >rpm -qpl <i>package</i>.i686.rpm</tt> &mdash; list files
included in a package file.
</p></li><li><p>
<tt  >rpm -qi <i>package</i></tt> &mdash; print
detailed description of installed package.
</p></li><li><p>
<tt  >rpm -qpi <i>package</i></tt> &mdash; print
detailed description of package file.
</p></li><li><p>
<tt  >rpm -qf <i>/path/to/file</i></tt> &mdash; list package
that installed a particular file.
</p></li><li><p>
<tt  >rpm --rebuild <i>package</i>.src.rpm</tt>
&mdash; unpack and build a binary RPM under
/usr/src/redhat.
</p></li><li><p>
<tt  >rpm2cpio <i>package</i>.src.rpm | cpio
-icduv</tt> &mdash; unpack all package files in the
current directory.
</p></li></ul></div><p>
Another important consideration for scripting the SSH agent is limiting the
capability of an authorized key. There is a specific syntax for such
limitations (<a href="https://man.openbsd.org/sshd#AUTHORIZED_KEYS_FILE_FORMAT" target="_self">https://man.openbsd.org/sshd#AUTHORIZED_KEYS_FILE_FORMAT</a>). Of
particular interest is the <tt  >from=""</tt> clause, which will
restrict logins on a key to a limited set of hosts. It is likely wise to
declare a set of &ldquo;bastion&rdquo; servers that will record non-root logins that
escalate into controlled users who make use of the enterprise keys.
</p><p>
An example entry might be the following (note that I've broken this line, which is not
allowed syntax but done here for clarity):

<pre     class="programlisting">
from="*.c2.security.yourcompany.com,4.3.2.1" ssh-ed25519
 &#8618;AAAAC3NzaC1lZDI1NTE5AAAAIJSSazJz6A5x6fTcDFIji1X+
&#8618;svesidBonQvuDKsxo1Mx
</pre>
</p><p>
A number of other useful restraints can be placed upon
<tt  >authorized_keys</tt> entries. The
<tt  >command=""</tt> will restrict a key to a single
program or script and will set the
<tt  >SSH_ORIGINAL_COMMAND</tt> environment
variable to the client's attempted call&mdash;scripts can set alarms if the
variable does not contain approved contents. The
<tt  >restrict</tt> option also
is worth consideration, as it disables a large set of SSH features that can be
both superfluous and dangerous.
</p><p>
Although it is possible to set server identification keys in the known_hosts
file to a <tt  >@revoked</tt> status, this cannot be done with the contents of
authorized_keys. However, a system-wide file for forbidden keys can be set
in the sshd_config with <tt  >RevokedKeys</tt>. This file overrides any user's
<tt  >authorized_keys</tt>. If set, this file must exist and be readable by the sshd
server process; otherwise, no keys will be accepted at all (so use care if
you configure it on a machine where there are obstacles to physical access).
When this option is set, use the <tt  >artano</tt> script to append forbidden
keys to the file quickly when they should be disallowed from the network. A clear
and convenient file location would be /etc/ssh/revoked_keys.
</p><p>
It is also possible to establish a local Certificate Authority (CA) for OpenSSH
that will allow keys to be registered with an authority with expiration
dates (<a href="https://ef.gy/hardening-ssh" target="_self">https://ef.gy/hardening-ssh</a>). These CAs can become quite elaborate in their control over an
enterprise
(<a href="https://code.facebook.com/posts/365787980419535/scalable-and-secure-access-with-ssh" target="_self">https://code.facebook.com/posts/365787980419535/scalable-and-secure-access-with-ssh</a>).
Although the maintenance of an SSH CA is beyond the scope of this
article, keys issued by such CAs should be strong by adhering to the
requirements for Ed25519/E-521/RSA-3072.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x1c5a580.0x22dc6c8"></a>
pdsh</h2></div></div><p>
Many higher-level tools for the control of collections of servers exist
that are much more sophisticated than the script I've presented here.
The most famous is likely Puppet (<a href="https://puppet.com" target="_self">https://puppet.com</a>), which is a Ruby-based configuration
management system for enterprise control. Puppet has a somewhat short list
of supported operating systems. If you are looking for low-level control of
Android, Tomato, Linux smart terminals or other &ldquo;exotic&rdquo; POSIX, Puppet
is likely not the appropriate tool. Another popular Ruby-based tool is Chef
(<a href="https://www.chef.io" target="_self">https://www.chef.io</a>), 
which is known for its complexity. Both Puppet and Chef require Ruby
installations on both clients and servers, and they both will catalog any
SSH keys that they find, so this key strength discussion is completely
applicable to them.
</p><p>
There are several similar Python-based tools, including Ansible
(<a href="https://www.ansible.com" target="_self">https://www.ansible.com</a>), Bcfg2 (<a href="http://bcfg2.org" target="_self">bcfg2.org</a>), 
Fabric (<a href="http://www.fabfile.org" target="_self">www.fabfile.org</a>) and SaltStack (<a href="https://saltstack.com" target="_self">https://saltstack.com</a>). Of these, only Ansible can run
&ldquo;agentless&rdquo; over a
bare SSH connection; the rest will require agents that run on target nodes
(and this likely includes a Python runtime).
</p><p>
Another popular configuration management tool is CFEngine
(<a href="https://cfengine.com" target="_self">https://cfengine.com</a>), which is coded in
C and claims very high performance. Rudder
(<a href="http://www.rudder-project.org/site" target="_self">www.rudder-project.org/site</a>) has evolved from portions of
CFEngine and has a small but growing user community.
</p><p>
Most of the previously mentioned packages are licensed commercially and
some are closed source.
</p><p>
The closest low-level tool to the activities presented here is the Parallel
Distributed Shell (pdsh), which can be found in the EPEL repository
(<a href="https://fedoraproject.org/wiki/EPEL" target="_self">https://fedoraproject.org/wiki/EPEL</a>). The
pdsh utilities grew out of an IBM-developed package named dsh designed for
the control of compute clusters. Install the following packages from the
repository to use pdsh:

<pre     class="programlisting">
# rpm -qa | grep pdsh
pdsh-2.31-1.el7.x86_64
pdsh-rcmd-ssh-2.31-1.el7.x86_64
</pre>
</p><p>
An SSH agent must be running while using pdsh with encrypted keys, and there
is no obvious way to control the destination port on a per-host basis as was
done with the <tt  >artano</tt> script. Below is an example using pdsh to run a command
on three remote servers:

<pre     class="programlisting">
# eval $(ssh-agent)
Agent pid 17106

# ssh-add  ~/.ssh/master_key
Enter passphrase for /root/.ssh/master_key:
Identity added: /root/.ssh/master_key (/root/.ssh/master_key)

# pdsh -w hosta.com,hostb.com,hostc.com uptime
hosta: 13:24:49 up 13 days,  2:13, 6 users, load avg: 0.00, 0.01, 0.05
hostb: 13:24:49 up  7 days, 21:15, 5 users, load avg: 0.05, 0.04, 0.05
hostc: 13:24:49 up  9 days,  3:26, 3 users, load avg: 0.00, 0.01, 0.05

# eval $(ssh-agent -k)
Agent pid 17106 killed
</pre>
</p><p>
The <tt  >-w</tt> option above defines a host list. It allows for limited arithmetic
expansion and can take the list of hosts from standard input if the
argument is a dash (-). The <tt  >PDSH_SSH_ARGS</tt> and
<tt  >PDSH_SSH_ARGS_APPEND</tt>
environment variables can be used to pass custom options to the SSH call. By
default, 32 sessions will be launched in parallel, and this &ldquo;fanout/sliding
window&rdquo; will be maintained by launching new host invocations as existing
connections complete and close. You can adjust the size of the &ldquo;fanout&rdquo; 
either with the <tt  >-f</tt> option or the
<tt  >FANOUT</tt> environment variable. It's interesting to
note that
there are two file copy commands: <tt  >pdcp</tt> and
<tt  >rpdcp</tt>, which are analogous to
<tt  >scp</tt>.
</p><p>
Even a low-level utility like pdsh lacks some flexibility that is available
by scripting OpenSSH, so prepare to feel even greater constraints as more
complicated tools are introduced.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x1c5a580.0x22dd278"></a>
Conclusion</h2></div></div><p>
Modern Linux touches us in many ways on diverse platforms. When the security
of these systems is not maintained, others also may touch our platforms
and turn them against us. It is important to realize the maintenance
obligations when you add any Linux platform to your environment. This
obligation always exists, and there are consequences when it is not met.
</p><p>
In a security emergency, simple, open and well understood tools are best.
As tool complexity increases, platform portability certainly declines, the
number of competent administrators also falls, and this likely impacts speed
of execution. This may be a reasonable trade in many other aspects, but in a
security context, it demands a much more careful analysis. Emergency measures
must be documented and understood by a wider audience than is required for
normal operations, and using more general tools facilitates that discussion.
</p><p>
I hope the techniques presented here will prompt that discussion for
those who have not yet faced it.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x1c5a580.0x22dd430"></a></h2></div></div><div class="sidebar"><p class="title"><b>Disclaimer</b></p><p>
The views and opinions expressed in this article are those of
the author and do not necessarily reflect those of <span   class="emphasis"><em>Linux
Journal</em></span>.
</p></div></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x1c5a580.0x22dd698"></a></h2></div></div><div class="sidebar"><p class="title"><b>Note:</b></p><p>
An exploit compromising Ed25519 was recently demonstrated that relies upon
custom hardware changes to derive a usable portion of a secret key (<a href="https://research.kudelskisecurity.com/2017/10/04/defeating-eddsa-with-faults" target="_self">https://research.kudelskisecurity.com/2017/10/04/defeating-eddsa-with-faults</a>).
Physical hardware security is a basic requirement for encryption integrity,
and many common algorithms are further vulnerable to cache timing or other
side channel attacks that can be performed by the unprivileged processes of
other users. Use caution when granting access to systems that process
sensitive data.
</p></div></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x1c5a580.0x22dd900"></a></h2></div></div><div class="sidebar"><p class="title"><b></b></p><p>Send comments or feedback via <a href="http://www.linuxjournal.com/contact" target="_self">www.linuxjournal.com/contact</a> or to
<a href="mailto:info@linuxjournal.com">info@linuxjournal.com</a>.
</p></div></div></div>
<div class="authorblurb"><p>
Charles Fisher has an electrical engineering degree from the University of
Iowa and works as a systems and database administrator for a Fortune 500
mining and manufacturing corporation. He has previously published both
journal articles and technical manuals on Linux for
<span   class="emphasis"><em>UnixWorld</em></span> and other McGraw-Hill publications.
</p></div>

  <div class="toclinks">
    <a class="link1" href="../tocindex.html">Archive Index</a>
    <a class="link2" href="../283/toc283.html">Issue Table of Contents</a>
    <a class="link3" href="../283/12243.html">Article</a>
  </div>
  <div class="bottomhrdiv">
  </div>
  
  <div id="bottom_search">
  <table class="page_search" summary="">
    <tr>
      <td valign="top" align="left">
        <p class="small_shutdown"><a href="/.exit">Shutdown Archive web server</a></p>
      </td>
      <td valign="top" align="right">
        <form method="get" action="/zoom/search.cgi">
          <input type="hidden" name="zoom_sort" value="0" />
          <input type="hidden" name="zoom_xml" value="0" />
          <input type="hidden" name="zoom_per_page" value="10" />
          <input type="hidden" name="zoom_and" value="1" />
          Search: <input type="text" name="zoom_query" size="20" value="" class="zoom_searchbox" />
          <input type="submit" value="Submit" />
        </form>
      </td>
    </tr>
  </table>
  </div>
  
  <div class="footerdiv">
    <a href="../../index.html">
      <img class="bottomimg" src="../../images/CD_FooterBanner.png" alt="LJ Archive"/>
    </a>
  </div>
  
  <div class="copyright">
    Copyright &copy; 1994 - 2018 <cite>Linux Journal</cite>.  All rights reserved.
  </div>
  </body></html>