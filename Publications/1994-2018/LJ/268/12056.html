<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"><html><head><META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>
The Tiny Internet Project, Part III
</title><link rel="stylesheet" href="../css/archive.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.57.0"><meta name="description" content="&#10;Deploy DNS, mail, web and Linux mirror servers using VM templates.&#10;"><link rel="stylesheet" href="../../css/archive.css" type="text/css"><script type="text/javascript" src="../../js/archive.js"></script><script type="text/javascript" src="../../js/highlight.js"></script></head><body onload="search_highlight();">
  <div class="headerdiv">
    <a href="../../index.html">
      <img class="topimg" src="../../images/CD_HeaderBanner.png" alt="LJ Archive"/>
    </a>
  </div>
  
  <div class="tophrdiv">
  </div>
  
  <div id="top_search">
  <table class="page_search" summary="">
    <tr>
      <td valign="top" align="left">
        <p class="small_shutdown"><a href="/.exit">Shutdown Archive web server</a></p>
      </td>
      <td valign="top" align="right">
        <form method="get" action="/zoom/search.cgi">
          <input type="hidden" name="zoom_sort" value="0" />
          <input type="hidden" name="zoom_xml" value="0" />
          <input type="hidden" name="zoom_per_page" value="10" />
          <input type="hidden" name="zoom_and" value="1" />
          Search: <input type="text" name="zoom_query" size="20" value="" class="zoom_searchbox" />
          <input type="submit" value="Submit" />
        </form>
      </td>
    </tr>
  </table>
  </div>
  <div class="article" lang="en"><div class="titlepage"><div><h1 class="title"><a name="N0x218e580.0x2285ac0"></a>
The Tiny Internet Project, Part III
</h1></div><div><div class="author"><h3 class="author">
John
 S. 
Tonello
</h3></div><div class="issuemoyr">Issue #268, August 2016</div></div><div><p>
Deploy DNS, mail, web and Linux mirror servers using VM templates.
</p></div></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x218e580.0x2286250"></a></h2></div></div><p>
In the May 2016 issue of <span   class="emphasis"><em>LJ</em></span>, I introduced the Tiny Internet Project, a
self-contained Linux project that shows you how to build key pieces
of the internet on a single computer using virtualization software,
a router and free open-source applications. In the second installment in
the July 2016 issue,
I explained how to set up the host server using Proxmox and build a first basic Ubuntu
14.04 virtual machine. In this third installment, you'll learn how to
set up an Ubuntu mirror, a DNS server, a mail server and a web server.
If you missed Parts I and II, be sure to visit the <span   class="emphasis"><em>Linux
Journal</em></span> archive
and read them there.
</p><p>
As you finished with Part II, you hopefully had just booted a raw Ubuntu 14.04 server
VM. Now, I'll describe how to customize that VM with some user accounts and software,
keeping it fairly generic, but ready to become a template for most
everything else you'll build.
</p><p>
Initially, you'll do all your work from the Proxmox web interface on
your Proxmox server: https://10.128.1.2:8006.
</p><p>
Log in and start the Ubuntu VM you made, which probably was named &ldquo;100
(ubuntu)&rdquo;. Wait a moment for it to boot, and click the Proxmox Console
button to launch what is essentially a web-based terminal.
</p><div       class="mediaobject"><a href="12056f1.large.jpg"><img src="12056f1.jpg"></a><div class="caption"><p>
Figure 1. Ubuntu Installation Screen&mdash;Selecting Your Language
</p></div></div><p>
When the shell opens, you'll see the Ubuntu installation screens. Select
your language and choose &ldquo;Install Ubuntu Server&rdquo; from the action
list. You'll be prompted again for language choices and keyboard layouts;
choose the ones that suit your needs. The installer will detect your
network and prompt you to enter a hostname.
</p><div       class="mediaobject"><a href="12056f2.large.jpg"><img src="12056f2.jpg"></a><div class="caption"><p>
Figure 2. Entering a Hostname
</p></div></div><p>
Since you'll be making this VM a template, give the machine a generic
hostname like &ldquo;ubuntu&rdquo;. That way, if you later deploy a different type
of server (say, ArchLinux), you'll easily be able to tell them apart. 
</p><p>
When
you're asked to create a user name, choose something that follows a naming
convention you can use for all future users, such as your first initial
and your full last name. Then when you need to figure out user
names (and email addresses) later, you won't have to guess.
</p><div       class="mediaobject"><a href="12056f3.large.jpg"><img src="12056f3.jpg"></a><div class="caption"><p>
Figure 3. Selecting a User Name
</p></div></div><p>
Provide a password, add encryption if you like, set your time zone and
proceed to the disk partitioning.
</p><p>
When you first created this VM under Proxmox, you gave it a main virtual
disk, which is what the Ubuntu installer now sees. Select &ldquo;Guided
&mdash; use entire disk&rdquo;, not the default with the LVM option. Accept the
configuration and then write the changes to disk.
</p><div       class="mediaobject"><a href="12056f4.large.jpg"><img src="12056f4.jpg"></a><div class="caption"><p>
Figure 4. Disk Partitioning 
</p></div></div><p>
The installer will set up the system, which takes a few
minutes. If you've ever installed an operating system onto hardware from
a DVD, this is the same thing.
</p><p>
When you're prompted for HTTP proxy information, leave it blank and
continue unless your school or situation requires a proxy to access the
public internet.
</p><p>
Once the installer configures <tt  >apt</tt>, it'll set up all the base software
and prompt you about how to manage upgrades. Select &ldquo;Install security
updates automatically&rdquo; and continue. On the Software selection page,
select only &ldquo;OpenSSH server&rdquo; for now. Doing so will give this base VM
template direct shell access and won't load up the machine with packages
you don't need.
</p><div       class="mediaobject"><a href="12056f5.large.jpg"><img src="12056f5.jpg"></a><div class="caption"><p>
Figure 5. Software Selection&mdash;Selecting Only OpenSSH Server
</p></div></div><p>
When prompted to install the GRUB bootloader to the master boot record,
choose &ldquo;Yes&rdquo;, and reboot when prompted. The VM will launch
into the GRUB menu quickly, boot and drop you at the login prompt.
</p><div       class="mediaobject"><a href="12056f6.large.jpg"><img src="12056f6.jpg"></a><div class="caption"><p>
Figure 6. Login Prompt
</p></div></div><p>
Log in using the user name and password you set up during the installation
and check the system's IP address. It was dynamically configured with
DHCP during the installation, and it will be handy to know so you can
<tt  >ssh</tt> into your new VM:

<pre     class="programlisting">
$ ifconfig
</pre>
</p><div       class="mediaobject"><a href="12056f7.large.jpg"><img src="12056f7.jpg"></a><div class="caption"><p>
Figure 7. Logging in and <tt >ifconfig</tt> Output
</p></div></div><p>
You'll see two entries, one for eth0 and one for lo (local). In my
example, the automatically assigned address is 10.128.1.26. If your
administration PC is a Linux box or Mac, open a terminal and
<tt  >ssh</tt> in to
your new VM by typing:

<pre     class="programlisting">
$ ssh username@10.128.1.26
</pre>
</p><p>
If you're on Windows, <tt  >ssh</tt> in using PuTTY or a similar tool. If you get a
login prompt, you're good to go. You always can use the Proxmox console
to connect to your VMs, but being able to <tt  >ssh</tt> in directly is handy.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x218e580.0x2287b10"></a>
Customize the VM</h2></div></div><p>
With your Ubuntu VM up and accessible, it's time to make some
customizations that will save time for all future deployments. Start by
adding any other administrative users you want. That way, when you make a
template out of this VM, all those users already will be set up. You're
already an administrative (sudo) user yourself, but it might be handy to have
someone else with admin rights:

<pre     class="programlisting">
$ sudo adduser msmith
</pre>
</p><p>
Follow the prompts and enter the user's full name and any of the rest
you care to add. Next, add your new user to the sudoers group:

<pre     class="programlisting">
$ sudo adduser msmith sudo
</pre>
</p><p>
These steps can be combined, but I think it's useful to see the output so
you better understand what's happening under the covers.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x218e580.0x2680020"></a>
Set a Static IP Address</h2></div></div><p>
All your servers will have static IP addresses so they can be mapped to
DNS later, so this is a good time to change them by editing the network
configuration file:

<pre     class="programlisting">
$ sudo vi /etc/network/interfaces
</pre>
</p><p>
Change the eth0 entry from this:

<pre     class="programlisting">
auto eth0
iface eth0 inet dhcp	
</pre>
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x218e580.0x2680230"></a></h2></div></div><p>
to this:

<pre     class="programlisting">
auto eth0
iface eth0 inet static
    address 10.128.1.200   # .200 is out of range of anything 
                           # I might be adding soon
    netmask 255.255.255.0
    dns-nameservers 10.128.1.3	
    dns-search tiny.lab	
</pre>
</p><p>
Save the file and reboot.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x218e580.0x26803e8"></a>
Add a Second Network Interface</h2></div></div><p>
The goal of your tiny internet is to make a self-contained system that
doesn't rely on the public internet, but you'll need to cheat a little
with this first VM and, later, with the mirror server. These VMs need
a second NIC so they can access both your private and
public networks simultaneously.
</p><p>
Once this VM is customized and updated, you can delete the second NIC
by reversing the steps you're about to take.
</p><p>
In the main Proxmox web interface, click on the Hardware tab for your
VM. Click Add and select Network Device from the menu. In the modal
window, select &ldquo;Bridge mode&rdquo; and bridge the second network interface,
in my example &ldquo;vmbr1&rdquo;. Click OK, and for good measure, restart the VM.
</p><div       class="mediaobject"><a href="12056f8.large.jpg"><img src="12056f8.jpg"></a><div class="caption"><p>
Figure 8. Bridge Mode
</p></div></div><p>
When you type <tt  >ifconfig</tt> at the prompt after you log in, you'll still
see only eth0 and lo, so you need to activate the newly added NIC. In
the console window (or shell), edit the network configuration file:

<pre     class="programlisting">
$ sudo vi /etc/network/interfaces
</pre>
</p><p>
Create a static IP entry for the second NIC:

<pre     class="programlisting">
auto eth1
iface eth1 inet static
    address 192.168.1.200   # .200 is an available address on 
                            # my network
    netmask 255.255.255.0
    gateway 192.168.1.1
    dns-nameservers 8.8.8.8 8.8.4.4	
</pre>
</p><p>
In this example, I choose .200 because it's a free address on my
LAN. Assign one of your own that doesn't conflict with other machines
on your network. The dns-nameservers are Google's.
</p><p>
Save the file and reboot the VM. When you log in and run
<tt  >ifconfig</tt> now,
you should see that the eth0 and eth1 interfaces are active (Figure 9).
</p><div       class="mediaobject"><a href="12056f9.large.jpg"><img src="12056f9.jpg"></a><div class="caption"><p>
Figure 9. eth0 and eth1 are both active.
</p></div></div><p>
This VM now has access to your private network and the public internet
so you can do updates and downloads. Run this update so you have the
latest version of your software and kernel:

<pre     class="programlisting">
$ sudo apt-get update &amp;&amp; sudo apt-get upgrade -y 
 &#8618;&amp;&amp; sudo apt-get autoremove -y
</pre>
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x218e580.0x2680d30"></a>
Install Webmin</h2></div></div><p>
You're now ready to install Webmin, a browser-based tool for administering
your Linux server. It's worth installing on the template VM so it's
available on every server you build from here on out.
</p><p>
First, install a few packages Webmin needs to work properly:

<pre     class="programlisting">
$ sudo apt-get install libnet-ssleay-perl libauthen-pam-perl 
 &#8618;libio-pty-perl apt-show-versions libapt-pkg-perl
</pre>
</p><p>
When those packages are installed, copy the URL of the latest Debian
installer from the Webmin downloads page (see the Resources section),
and fetch it to your home directory on this VM:

<pre     class="programlisting">
$ cd ~
$ wget http://prdownloads.sourceforge.net/webadmin/
&#8618;webmin_1.791_all.deb
</pre>
</p><p>
Now, install it:

<pre     class="programlisting">
$ sudo dpkg -i webmin_1.791_all.deb
</pre>
</p><p>
The installer will take a little while, so be patient. When it's done,
it'll direct you to log in at https://ubuntu:10000, but since you
don't have DNS set up yet, you'll have to use https://10.128.1.200:10000
for now. Use your administration PC and log in with your user name and
password.
</p><div       class="mediaobject"><a href="12056f10.large.jpg"><img src="12056f10.jpg"></a><div class="caption"><p>
Figure 10. Logging in to Webmin
</p></div></div></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x218e580.0x2681258"></a>
Set Up the Firewall</h2></div></div><p>
If you want to enable a firewall on your template, this is the time to
do it. It's easy with the Webmin interface&mdash;under Networking, click
Linux Firewall. Check the box at the bottom that says &ldquo;Enable firewall
at boot time&rdquo;, and click the &ldquo;Setup Firewall&rdquo; button. Create four
basic rules:


<div class="itemizedlist"><ul type="disc"><li><p>
Accept if state of connection is ESTABLISHED,RELATED.
</p></li><li><p>
Accept if interface is not eth0.
</p></li><li><p>
Accept if source is 10.128.1.0/24.
</p></li><li><p>
Accept if source is 192.168.1.0/24.
</p></li></ul></div>
</p><p>
These rules allow traffic only from devices on your two networks&mdash;the
one you use to connect to the internet and the private one that makes up
your tiny internet. Set the &ldquo;Default Action To:&rdquo; button to &ldquo;Drop&rdquo; on the first
entry (&ldquo;Accept&rdquo; on the other two), and click Apply Configuration.
</p><div       class="mediaobject"><a href="12056f11.large.jpg"><img src="12056f11.jpg"></a><div class="caption"><p>
Figure 11. Setting Up the Firewall Rules
</p></div></div><p>
You can confirm these rules are active by running this simple command:

<pre     class="programlisting">
$ sudo iptables -L
</pre>
</p><div       class="mediaobject"><a href="12056f12.large.jpg"><img src="12056f12.jpg"></a><div class="caption"><p>
Figure 12. Output of the <tt >sudo iptables -L</tt> Command
</p></div></div></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x218e580.0x2681d00"></a>
Change Your Local sources.list</h2></div></div><p>
Next, you'll change the apt package repository listed in
/etc/apt/sources.list from the Ubuntu default to your own. This will enable
you to update all your VMs locally without them ever needing to access
the public internet. Note that this won't work until your apt-mirror is
fully operational (if you don't want to set up a mirror, skip this step):

<pre     class="programlisting">
$ mv /etc/apt/sources.list /etc/apt/sources.list.bak
$ sudo vi /etc/apt/sources.list
</pre>
</p><p>
Enter the following three lines in sources.list and save it. The URL
points to the VM you'll make called &ldquo;mirror&rdquo; on the domain you'll
create called &ldquo;tiny.lab&rdquo;:

<pre     class="programlisting">
deb http://mirror.tiny.lab/ubuntu trusty main restricted 
 &#8618;universe multiverse
deb http://mirror.tiny.lab/ubuntu trusty-security main 
 &#8618;restricted universe multiverse
deb http://mirror.tiny.lab/ubuntu trusty-updates main 
 &#8618;restricted universe multiverse
</pre>
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x218e580.0x2682018"></a>
Set Up a Proxy</h2></div></div><p>
If you're planning to build and use an HTTP proxy, edit /etc/environment
to add the following lines. In this example, I used addresses and a port number
created later by installing tinyproxy. After the
<tt  >PATH</tt> line, add:

<pre     class="programlisting">
no_proxy="127.0.0.1, localhost, *tiny.lab"
http_proxy="http://proxy.tiny.lab:8888"
ftp_proxy="http://proxy.tiny.lab:8888"
</pre>
</p><p>
In this case, I don't want the system to use the proxy for anything on
my private tiny internet domain (*tiny.lab), but it can for anything
else that isn't local. If you're not planning to build your own mirror
and plan to use a public repository (the default), you'll also need to
edit /etc/apt/apt.conf to add a line telling apt to use your proxy
to get to the repository:

<pre     class="programlisting">
Acquire::http::Proxy "http://proxy.tiny.lab:8888";
</pre>
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x218e580.0x2592b90"></a>
Convert Your VM to a Template</h2></div></div><p>
Now you're ready to convert this VM to a template. It's been customized with
your credentials, static IP addresses that can be modified easily, Webmin
for easy system management, simple firewall rules, a custom sources.list
and proxy settings, if necessary.
</p><p>
To convert it, return to the Proxmox browser interface and shut down the
machine. Right-click on the VM and select &ldquo;Convert to
template&rdquo; from
the menu.
</p><div       class="mediaobject"><a href="12056f13.large.jpg"><img src="12056f13.jpg"></a><div class="caption"><p>
Figure 13. Converting the VM to a Template
</p></div></div><p>
After a few moments, the VM's icon will change, showing you that the machine
is now purely a template. It no longer can be started as is.
</p><p>
If you installed a second hard drive on your Proxmox host server, now
is a good time to back up this new template. Check the Proxmox website
for more information.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x218e580.0x2592fb0"></a>
Deploy a Linux Repository Mirror</h2></div></div><p>
You have two choices when it comes to deploying the Ubuntu repository:
clone your new VM template and resize its 30GB virtual disk, or create
an all-new VM with a larger disk. I explain the latter here.
</p><p>
Start by creating a new VM from the Ubuntu .iso file you used to
create your template VM. This time, give the machine a virtual disk
that's at least 200GB. Boot the machine and step through the server
installation process as before, making sure to give the machine the
hostname &ldquo;mirror&rdquo; and an IP address of 10.128.1.6. Use the same
user name and password you set on your template, and install only OpenSSH
from the application list.
</p><p>
Follow the procedure for adding a second NIC, and be sure to leave the
/etc/apt/sources.list unchanged for now. You'll need it to point to the
default external Ubuntu repository.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x218e580.0x25931c0"></a>
Install apt-mirror</h2></div></div><p>
With the machine set with access to both your tiny internet and the
public internet, install <tt  >apt-mirror</tt> and the web server that will serve
up packages:

<pre     class="programlisting">
$ sudo apt-get install apt-mirror apache2
</pre>
</p><p>
The core of the <tt  >apt-mirror</tt> configuration is the list of repository
URLs. Make a backup of the default file and edit the original:

<pre     class="programlisting">
$ sudo cp /etc/apt/mirror.list /etc/apt/mirror.list.bak
$ sudo vi /etc/apt/mirror.list
</pre>
</p><p>
Leave the <tt  >config</tt> section at the top as is, and don't change the first
three <tt  >deb</tt> listings. However, to save disk space, remove all the
<tt  >deb-src</tt> entries and replace them with the 32-bit repositories. Your
entries should look like this:

<pre     class="programlisting">
deb http://archive.ubuntu.com/ubuntu trusty main restricted 
 &#8618;universe multiverse
deb http://archive.ubuntu.com/ubuntu trusty-security main 
 &#8618;restricted universe multiverse
deb http://archive.ubuntu.com/ubuntu trusty-updates main 
 &#8618;restricted universe multiverse

deb-i386 http://archive.ubuntu.com/ubuntu trusty main 
 &#8618;restricted universe multiverse
deb-i386 http://archive.ubuntu.com/ubuntu trusty-security main 
 &#8618;restricted universe multiverse
deb-i386 http://archive.ubuntu.com/ubuntu trusty-updates main 
 &#8618;restricted universe multiverse

clean http://archive.ubuntu.com/ubuntu
</pre>
</p><p>
Save the file and start <tt  >apt-mirror</tt> with your edited
mirror.list. Depending on your internet connection, this likely
will take many hours. You'll get a hint of just how long when it tells you how
many gigabytes will be downloaded. Be patient:

<pre     class="programlisting">
$ sudo apt-mirror /etc/apt/mirror.list
</pre>
</p><p>
Continue your work during this download by opening another shell into the
server. You can configure apache2 while <tt  >apt-mirror</tt> is doing its thing
by creating a symbolic link from the <tt  >apt-mirror</tt> repository to the web
directory that was created automatically when you installed
apache2.
</p><p>
If you haven't already, test to see that the web server is up by pointing
your browser to http://10.128.1.6.
</p><p>
If it works, create a new directory at the root of the web server:

<pre     class="programlisting">
$ sudo mkdir /var/www/html/ubuntu
</pre>
</p><p>
Create a symbolic link from the directory where
<tt  >apt-mirror</tt> stores the
packages to the new directory:

<pre     class="programlisting">
$ sudo ln -s /var/spool/apt-mirror/mirror/archive.ubuntu.com/
&#8618;ubuntu/pool/ /var/www/html/ubuntu
</pre>
</p><p>
Test it by pointing your browser to http://10.128.1.6/ubuntu. If you
see a list of directories, you're all set. Any VMs built with the local
sources.list will be able to download packages from this local server once
apt-mirror completes. (See the Resources section for more information.)
</p><div       class="mediaobject"><a href="12056f14.large.jpg"><img src="12056f14.jpg"></a><div class="caption"><p>
Figure 14. Installing apt-mirror
</p></div></div></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x218e580.0x2593c68"></a>
Set Up DNS (bind9)</h2></div></div><p>
If you want to use domain names instead of IP addresses for reaching all
your tiny internet machines, it's time to deploy a DNS server. Use the
addresses you established as part of your tiny internet schema. Here's
a reminder:
</p><div class="itemizedlist"><ul type="disc"><li><p>
pve &mdash; 10.128.1.2
</p></li><li><p>
dns01 &mdash; 10.128.1.3
</p></li><li><p>
dns02 &mdash; 10.128.1.4
</p></li><li><p>
mail &mdash; 10.128.1.5
</p></li><li><p>
mirror &mdash; 10.128.1.6
</p></li><li><p>
web01 &ndash;10.128.1.7
</p></li></ul></div><p>
Start by cloning your VM template. Right-click on the template and select
&ldquo;Clone&rdquo;. The target node will default to &ldquo;pve&rdquo; (or whatever you
called your Proxmox host). Set the VM ID and name to whatever you
want. Leave the auto-incrementing ID as is, and give the VM a name that's
the same as the hostname you'll assign. In my example, I used
&ldquo;dns01&rdquo;. Set
the Mode to &ldquo;Full Clone&rdquo;, and set the Target Storage to
&ldquo;local&rdquo;
with &ldquo;Raw disk image&rdquo; as the format.
</p><div       class="mediaobject"><a href="12056f15.large.jpg"><img src="12056f15.jpg"></a><div class="caption"><p>
Figure 15. Cloning the Template
</p></div></div><p>
It takes less than a minute to spawn a new VM from your template. In
its current state, it's exactly like the original &ldquo;ubuntu&rdquo;
VM&mdash;same IP address, same hostname. Of course, you'll need to change those
before putting the machine into production:
</p><div class="itemizedlist"><ul type="disc"><li><p>
Edit /etc/hosts &mdash; change <tt  >127.0.1.1 ubuntu</tt> to
<tt  >10.128.1.3 dns01.tiny.lab dns01</tt>.
</p></li><li><p>
Edit /etc/hostname &mdash; change <tt  >ubuntu</tt> to
<tt  >dns01.tiny.lab</tt>.
</p></li><li><p>
Edit /etc/network/interfaces &mdash; change the
<tt  >10.128.1.200</tt> address to
<tt  >10.128.1.3</tt>.
</p></li></ul></div><p>
Once you've made these basic changes, reboot, log in and install
<tt  >bind9</tt>:

<pre     class="programlisting">
$ sudo apt-get update
$ sudo apt-get install bind9 bind9utils dnsutils bind9-doc
</pre>
</p><p>
The main DNS configuration is done in these three files:
</p><div class="itemizedlist"><ul type="disc"><li><p>
/etc/default/bind9
</p></li><li><p>
/etc/bind/named.conf.options
</p></li><li><p>
/etc/bind/named.conf.local
</p></li></ul></div><p>
You'll finish by creating your zone files in /etc/bind/zones. I'm
using the &ldquo;tiny.lab&rdquo; domain name in all these examples, but you can
set the name to anything you want.
</p><p>
Start by adding an IPv4 option:

<pre     class="programlisting">
$ sudo vi /etc/default/bind9
</pre>
</p><p>
Add the following to the end of the file:

<pre     class="programlisting">
OPTIONS="-4 -u bind"
</pre>
</p><p>
Make backup copies of the next two files before editing them, then edit
/etc/bind/named.conf.options and add your trusted hosts (one for each
server and resource you have), and set the options:

<pre     class="programlisting">
acl "trusted" {
    10.128.1.1;
    10.128.1.2;
    10.128.1.3;
    10.128.1.4;
    10.128.1.5;
    10.128.1.6;
    10.128.1.7;
    10.128.0.0/16;
};

options {
    directory "/var/cache/bind";

    recursion	yes;   # enables recursive queries
    allow-recursion	{ trusted; };   # allows queries from "trusted" 
                                        # clients
    listen-on { 10.128.1.3; };   # dns01 IP address
    allow-transfer { none; };   # disable zone transfer by default

    forwarders {
        8.8.8.8;   # These are Google's DNS servers
        8.8.4.4;
    };

    ...
}; 
</pre>
</p><p>
Save the file and create your zones by editing
/etc/bind/named.conf.local. This is where you set your domain name,
replacing &ldquo;tiny.lab&rdquo; with whatever you want:

<pre     class="programlisting">
zone "tiny.lab" {
    type master;
    file "/etc/bind/zones/db.tiny.lab";
    allow-transfer { 10.128.1.4; };  # Setting this for a 
                                     # future secondary DNS server
};

zone "128.10.in-addr.arpa" {
    type master;
    file "/etc/bind/zones/db.10.128";
    allow-transfer { 10.128.1.4; };
};
</pre>
</p><p>
Now create the forward and reverse zone files, placing them in the
/etc/bind/zones folder. If it doesn't exist, create it:

<pre     class="programlisting">
$ cd /etc/bind
$ sudo mkdir zones
</pre>
</p><p>
Copy the default DNS forward and reverse zone config files into that
folder, renaming them to match your domain name and IP subnet:

<pre     class="programlisting">
$ sudo cp db.local ./zones/db.tiny.lab
$ sudo cp db.127 ./zones/db.10.128
</pre>
</p><p>
Edit /etc/bind/zones/db.tiny.lab, and enter your current and future
hosts. The file I set up includes comments at the top to remind me of
changes I make. I also created entries for my router (10.128.1.1) and a
proxy server, which I put on the same box as my dns02. Each time you make
modifications, increment the Serial entry before saving. Also note the
&ldquo;.?&rdquo; after each name. Don't leave those off. You can find more information about
DNS in the Resources section at the end of this article,
but this will get you started:

<pre     class="programlisting">
; BIND data file for local loopback interface
;
;       20150505        JST     Modified proxy address
;       20160505        JST     Added web01

$TTL    604800
@       IN      SOA     dns01.tiny.lab admin.dns01.tiny.lab. (
                             12         ; Serial
                         604800         ; Refresh
                          86400         ; Retry
                        2419200         ; Expire
                         604800 )       ; Negative Cache TTL
; name servers -- NS records
        IN      NS      dns01.tiny.lab.
        IN      NS      dns02.tiny.lab.

; name servers -- A records
dhcp.tiny.lab.          IN      A       10.128.1.1
pve.tiny.lab.           IN      A       10.128.1.2
dns01.tiny.lab.         IN      A       10.128.1.3
dns02.tiny.lab.         IN      A       10.128.1.4
proxy.tiny.lab.         IN      CNAME   dns02.tiny.lab.
mail.tiny.lab.          IN      A       10.128.1.5
mirror.tiny.lab.      	IN      A       10.128.1.6
web01.tiny.lab.         IN      A       10.128.1.7
</pre>
</p><p>
Save the file and edit the /etc/bind/db.10.128 reverse zone file. The IP
addresses for each server under &ldquo;PTR records&rdquo; are truncated-looking
and can be confusing. Imagine each leading off with an invisible
&ldquo;10.128.&rdquo; to envision the addresses. Again, be sure to increment
the Serial entry each time you make a change:

<pre     class="programlisting">
; BIND reverse data file for local loopback interface
;
; 20160505      JST     Added cname for proxy
; 20160505      JST     Added mirror01

$TTL    604800
@       IN      SOA     tiny.lab. admin.tiny.org. (
                             11         ; Serial
                         604800         ; Refresh
                          86400         ; Retry
                        2419200         ; Expire
                         604800 )       ; Negative Cache TTL
;
; name servers -- NS records
        IN      NS      dns01.tiny.lab.
        IN      NS      dns02.tiny.lab.

; PTR records
1.1     IN      PTR     dhcp.tiny.lab.
1.2     IN      PTR     pve.tiny.lab.
1.3     IN      PTR     dns01.tiny.lab.
1.4     IN      PTR     dns02.tiny.lab.
1.5     IN      PTR     mail.tiny.lab.
1.6     IN      PTR     mirror.tiny.lab.
1.7     IN      PTR     web01.tiny.lab.
</pre>
</p><p>
Save the file and check the syntax of your files by running:

<pre     class="programlisting">
$ sudo named-checkconf
</pre>
</p><p>
If everything is correct, you'll get no output and no errors. Check the
configurations further with <tt  >named-checkzone</tt>:

<pre     class="programlisting">
$ sudo named-checkzone tiny.lab /etc/bind/zones/db.tiny.lab
$ sudo named-checkzone 128.10.in-addr.arpa /etc/bind/zones/db.10.128
</pre>
</p><p>
You'll see &ldquo;OK&rdquo; if everything checks out. If not, edit the
files. Leaving off the trailing &ldquo;.?&rdquo; is a common mistake.
</p><p>
Restart bind to get it up and running:

<pre     class="programlisting">
$ sudo service bind9 restart
</pre>
</p><p>
When <tt  >bind9</tt> restarts, do a quick check with the
<tt  >dig</tt> utility,
or simply open a browser and navigate to your mirror server at
http://mirror.tiny.lab:

<pre     class="programlisting">
$ dig mirror.tiny.lab
</pre>
</p><p>
If you see 10.128.1.6 in the <tt  >dig</tt> output, you've succeeded. DNS is
working. You can complete your DNS setup by deploying a second VM or
installing <tt  >bind9</tt> on a physically separate machine on your tiny internet
network, but it's not strictly necessary at this point. You also can set
this VM to start automatically when your Proxmox host starts, so you have
DNS running whenever your tiny internet is up.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x218e580.0x2811998"></a>
Deploy a Mail Server</h2></div></div><p>
Mail servers have two key components: a service that transfers mail and
a service that serves up mail. Postfix is a common transfer agent (SMTP),
and when coupled with Dovecot, it will provide you with all you need to
send and receive mail via IMAP (or POP if you're so inclined).
</p><p>
Deploy another clone of your &ldquo;ubuntu&rdquo; template, this time naming
it &ldquo;mail&rdquo;, making sure the Mode is &ldquo;Full Clone&rdquo; and your Target
Storage is &ldquo;local&rdquo;. Once it's generated, start it up, open a
console,
and update the same basic information you did for your mirror server: set
the static IP address for <tt  >eth0</tt> as 10.128.1.5, and
change the <tt  >hostname</tt>
to <tt  >mail.tiny.lab</tt>.
</p><p>
Reboot and install Postfix and Dovecot:

<pre     class="programlisting">
$ sudo apt-get update
$ sudo apt-get install postfix
</pre>
</p><p>
During the install, you'll be prompted to select the type of installation
you want. Choose &ldquo;Internet Site&rdquo;. Follow that by setting the
&ldquo;System
mail name&rdquo; as &ldquo;mail&rdquo;&mdash;the same as the hostname.
</p><p>
When it's done, install <tt  >mailutils</tt> and Dovecot tools:

<pre     class="programlisting">
$ sudo apt-get install dovecot-imapd dovecot-pop3d
</pre>
</p><p>
Reply &ldquo;Yes&rdquo; to install the self-signed certificate, set the hostname
as &ldquo;mail&rdquo; and allow the install to complete.
</p><p>
To configure Postfix, run this command:

<pre     class="programlisting">
$ sudo dpkg-reconfigure postfix
</pre>
</p><p>
You can confirm the entries you made during the Postfix install,
and then proceed to set your user name for the &ldquo;Root and postmaster
mail recipient&rdquo;&mdash;in my case, &ldquo;jtonello&rdquo;. Look over the
other destinations from which to accept mail, and add your domain
(&ldquo;tiny.lab&rdquo;). Don't force synchronous updates on the mail queue,
but under the local networks, be sure to add &ldquo;10.128.1.0/24&rdquo; to the
list. That's the scope you defined for all your machines. If you leave
this out, the mail server will reject all incoming mail.
</p><div       class="mediaobject"><a href="12056f16.large.jpg"><img src="12056f16.jpg"></a><div class="caption"><p>
Figure 16. Postfix Configuration
</p></div></div><p>
Set the mailbox limits to suit your needs, and set &ldquo;all&rdquo; as the
internet protocols to use. You'll start with IPv4, but having IPv6
enabled offers future flexibility.
</p><p>
With the basics now in place, check out the main Ubuntu Postfix and
Dovecot pages listed in the Resources section for more information.
</p><p>
You'll be able to use any email client with your new mail server,
including Thunderbird and Evolution, two common tools that come
pre-installed on many Linux distributions. You also might consider
installing a web-based mail tool like Roundcube. It provides a great
interface and plenty of features that work well with Postfix and Dovecot.
</p><p>
If you want to dig in to the mail configuration, use Webmin. Log in at
https://mail.tiny.lab:10000 and look under the Servers tab for the
Postfix and Dovecot entries. From there, you can explore and
manage the servers easily.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x218e580.0x28127b0"></a>
Set Up a Web Server</h2></div></div><p>
So far, without possibly being aware, you've installed apache2 on the
mirror and mail servers. These allow web connections to those services,
but you'll want a more full-featured LAMP stack (Linux, Apache, MySQL
and PHP) for building robust websites.
</p><p>
When you first installed Ubuntu from the .iso, you may have noticed a
LAMP choice during the applications install step. You definitely
can create a VM from scratch and check that box; it'll give you everything
you need. However, since you have a nice pre-made VM template, you can
use that and add LAMP to it.
</p><p>
Start by cloning your Ubuntu template. Follow the same steps you did
with previous clones&mdash;change the IP address (10.128.1.7) and hostname
(web01). Reboot and open a terminal to install the LAMP components:

<pre     class="programlisting">
$ sudo apt-get install lamp-server^
</pre>
</p><p>
The caret (^) is important; don't leave it off. As the installers proceed,
you'll be asked to create a root password for the MySQL database. Jot
it down or put it in your password safe so you don't forget it.
</p><p>
The installation will create the /var/www/html folder and the default
index.html. If you point your browser to the machine (either by IP or
DNS name if you set it up), you'll see the default Apache2 page. Test
the PHP installation by creating a new file in the same directory:

<pre     class="programlisting">
$ sudo vi /var/www/html/phpinfo.php
</pre>
</p><p>
Add these lines to the file:

<pre     class="programlisting">

&lt;?php
        phpinfo();
?&gt;

</pre>
</p><p>
Point your browser to the page at http://web01.tiny.lab/phpinfo.php. If
you see a page with information, your server is successfully serving
up PHP.
</p><p>
To make it easier to work with the MySQL database, install phpMyAdmin:

<pre     class="programlisting">
$ sudo apt-get install phpmyadmin
</pre>
</p><p>
Select &ldquo;apache2&rdquo; as the server to reconfigure automatically,
and answer &ldquo;No&rdquo; to the next question (because the database is
already configured). When the installation is complete, you'll have
a very robust web-based tool to manage all your databases. Log in at
http://web01.tiny.lab/phpmyadmin with the MySQL user name
&ldquo;root&rdquo; and
the password you set.
</p><p>
If you plan to deploy multiple web servers, go ahead and convert this
web01 VM to a template. That way, it will be full-featured and ready with
only a few small changes. If you want each VM to use WordPress or another
content-management tool, install that before you make your template.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x218e580.0x2816418"></a>Conclusion</h2></div></div><p>
You now have a fully operational tiny internet, complete with a Linux
repository; mail, DNS and web servers; and a number of useful tools. Use
this setup to explore and learn about Linux. If you mess up a VM server,
just deploy another one from your template. Most important, share what
you've learned and get others involved, and help spur the curiosity of
the next generation of Linux enthusiasts.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x218e580.0x2816520"></a></h2></div></div><div class="sidebar"><p class="title"><b>Resources</b></p><p>
Download PuTTY:
<a href="http://www.chiark.greenend.org.uk/~sgtatham/putty/download.html" target="_self">www.chiark.greenend.org.uk/~sgtatham/putty/download.html</a>
</p><p>
Webmin Downloads:
<a href="http://webmin.com/download.html" target="_self">webmin.com/download.html</a> and 
<a href="http://prdownloads.sourceforge.net/webadmin/webmin_1.791_all.deb" target="_self">prdownloads.sourceforge.net/webadmin/webmin_1.791_all.deb</a>
</p><p>
Setting Up a Mirror:
<a href="https://www.howtoforge.com/local_debian_ubuntu_mirror_p2" target="_self">https://www.howtoforge.com/local_debian_ubuntu_mirror_p2</a>
</p><p>
Setting Up DNS (bind9):
<a href="https://www.digitalocean.com/community/tutorials/how-to-configure-bind-as-a-private-network-dns-server-on-ubuntu-14-04" target="_self">https://www.digitalocean.com/community/tutorials/how-to-configure-bind-as-a-private-network-dns-server-on-ubuntu-14-04</a>
and
<a href="https://help.ubuntu.com/community/BIND9ServerHowto" target="_self">https://help.ubuntu.com/community/BIND9ServerHowto</a>
</p><p>
Postfix and Dovecot Installation:
<a href="https://help.ubuntu.com/community/Postfix" target="_self">https://help.ubuntu.com/community/Postfix</a> and
<a href="https://help.ubuntu.com/community/Dovecot" target="_self">https://help.ubuntu.com/community/Dovecot</a>
</p><p>
Installing Roundcube:
<a href="https://github.com/roundcube/roundcubemail/wiki/Installation" target="_self">https://github.com/roundcube/roundcubemail/wiki/Installation</a>
</p><p>
Install a LAMP Stack:
<a href="https://help.ubuntu.com/community/ApacheMySQLPHP" target="_self">https://help.ubuntu.com/community/ApacheMySQLPHP</a>
</p><p>
TinyProxy How-To:
<a href="https://tinyproxy.github.io" target="_self">https://tinyproxy.github.io</a>
</p></div></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x218e580.0x2816d60"></a></h2></div></div><div class="sidebar"><p class="title"><b></b></p><p>Send comments or feedback via <a href="http://www.linuxjournal.com/contact" target="_self">www.linuxjournal.com/contact</a> or to
<a href="mailto:info@linuxjournal.com">info@linuxjournal.com</a>.
</p></div></div></div>
<div class="authorblurb"><p>
John Tonello is the Director of IT for NYSERNet Inc., New York
state's regional optical networking company. He's been a Linux user
and enthusiast since building his first Slackware system from diskette
20 years ago. Since then, he's developed web and IT solutions for major
universities, Fortune 500 companies and small start-ups. A former Cornell
University IT trainer and writer, John served six years as the mayor of
an Upstate New York city, where he championed the use of technology to
help solve problems facing municipalities.
</p></div>

  <div class="toclinks">
    <a class="link1" href="../tocindex.html">Archive Index</a>
    <a class="link2" href="../268/toc268.html">Issue Table of Contents</a>
    <a class="link3" href="../268/12056.html">Article</a>
  </div>
  <div class="bottomhrdiv">
  </div>
  
  <div id="bottom_search">
  <table class="page_search" summary="">
    <tr>
      <td valign="top" align="left">
        <p class="small_shutdown"><a href="/.exit">Shutdown Archive web server</a></p>
      </td>
      <td valign="top" align="right">
        <form method="get" action="/zoom/search.cgi">
          <input type="hidden" name="zoom_sort" value="0" />
          <input type="hidden" name="zoom_xml" value="0" />
          <input type="hidden" name="zoom_per_page" value="10" />
          <input type="hidden" name="zoom_and" value="1" />
          Search: <input type="text" name="zoom_query" size="20" value="" class="zoom_searchbox" />
          <input type="submit" value="Submit" />
        </form>
      </td>
    </tr>
  </table>
  </div>
  
  <div class="footerdiv">
    <a href="../../index.html">
      <img class="bottomimg" src="../../images/CD_FooterBanner.png" alt="LJ Archive"/>
    </a>
  </div>
  
  <div class="copyright">
    Copyright &copy; 1994 - 2018 <cite>Linux Journal</cite>.  All rights reserved.
  </div>
  </body></html>