<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"><html><head><META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>
Secure Token-Based Authentication with YubiKey 4
</title><link rel="stylesheet" href="../css/archive.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.57.0"><meta name="description" content="&#10;YubiKeys replace other one-time password and two-factor authentication&#10;systems with a USB token. This article provides in-depth coverage of&#10;common YubiKey configurations and defines a Vagrant virtual machine to&#10;speed up configuration testing.&#10;"><link rel="stylesheet" href="../../css/archive.css" type="text/css"><script type="text/javascript" src="../../js/archive.js"></script><script type="text/javascript" src="../../js/highlight.js"></script></head><body onload="search_highlight();">
  <div class="headerdiv">
    <a href="../../index.html">
      <img class="topimg" src="../../images/CD_HeaderBanner.png" alt="LJ Archive"/>
    </a>
  </div>
  
  <div class="tophrdiv">
  </div>
  
  <div id="top_search">
  <table class="page_search" summary="">
    <tr>
      <td valign="top" align="left">
        <p class="small_shutdown"><a href="/.exit">Shutdown Archive web server</a></p>
      </td>
      <td valign="top" align="right">
        <form method="get" action="/zoom/search.cgi">
          <input type="hidden" name="zoom_sort" value="0" />
          <input type="hidden" name="zoom_xml" value="0" />
          <input type="hidden" name="zoom_per_page" value="10" />
          <input type="hidden" name="zoom_and" value="1" />
          Search: <input type="text" name="zoom_query" size="20" value="" class="zoom_searchbox" />
          <input type="submit" value="Submit" />
        </form>
      </td>
    </tr>
  </table>
  </div>
  <div class="article" lang="en"><div class="titlepage"><div><h1 class="title"><a name="N0x130a580.0x1401ac0"></a>
Secure Token-Based Authentication with YubiKey 4
</h1></div><div><div class="author"><h3 class="author">
Todd
 A. 
Jacobs
</h3></div><div class="issuemoyr">Issue #265, May 2016</div></div><div><p>
YubiKeys replace other one-time password and two-factor authentication
systems with a USB token. This article provides in-depth coverage of
common YubiKey configurations and defines a Vagrant virtual machine to
speed up configuration testing.
</p></div></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x130a580.0x1402250"></a></h2></div></div><p>
One-time password systems like S/Key and OTPW (see my article &ldquo;Configuring One-Time
Password Authentication with OTPW&rdquo; in the January 2013 issue of <span   class="emphasis"><em>Linux Journal</em></span>) are
designed to protect your login credentials when you need to connect from
an untrusted host, such as a co-worker's desktop, or a public terminal at
an Internet caf&eacute; or over an unencrypted protocol like telnet. Such
systems rely on a challenge-response password list that you must carry
around, and periodically update and print from secure terminals. This
can be a huge hassle.
</p><div       class="mediaobject"><a href="11956f1.large.jpg"><img src="11956f1.jpg"></a><div class="caption"><p>
Figure 1. YubiKey 4 from Yubico
</p></div></div><p>
In contrast, two-factor authentication systems (with or without one-time
passwords) require a second authentication step in order to prove your
identity. This &ldquo;second authentication factor&rdquo; can be provided through
token-based systems, such as Yubico's YubiKeys. YubiKeys are commercial
(but inexpensive) security devices that provide support for a variety of
one-time password and two-factor authentication methods in several
portable and platform-independent USB form-factors.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x130a580.0x1402720"></a></h2></div></div><div class="sidebar"><p class="title"><b>
YubiKey 4 Authentication Protocols and Cryptographic Features</b></p><p><span   class="bold"><b>
YubiKey 4 Authentication Protocols:</b></span>
</p><p>
In addition to the Yubico OTP protocol pre-configured in Slot 1, the
YubiKey 4 supports several other one-time password protocols. At the
time of this writing, the YubiKey 4 natively supports a number of
additional protocols, such as OATH-HOTP (HMAC-Based One-Time Passwords),
FIDO U2F (Universal 2nd Factor) and HMAC-SHA1 Challenge-Response. The
YubiKey 4 also provides the OATH-TOTP (Time-Based One-Time Passwords)
authentication when used with the GPLv3 Yubico Authenticator desktop
application.
</p><p><span   class="bold"><b>
Additional Cryptographic Features:</b></span>
</p><p>
The YubiKey 4 also is configurable as an OpenPGP Smartcard with support
for strong RSA keys up to 4,096 bits and several ECC (Elliptic Curve
Cryptography) key types. These keys support the usual OpenPGP
encryption and signing functions used by Pretty Good Privacy (PGP) and
GNU Privacy Guard (GPG).
</p><p>
As a bonus feature, the YubiKey 4 supports a special authentication key
that can be used by GNU Privacy Guard's gpg-agent for SSH public key
authentication. Although outside the scope of this article, a YubiKey
configured for SSH authentication meets all the requirements to be
considered a true two-factor authentication method.
</p><p>
Since secret key material can't be extracted from a YubiKey even when
plugged in to a compromised host, the smartcard features of the YubiKey
make it ideal for carrying around your OpenPGP secret keys for creating
digital signatures or decrypting messages on multiple hosts, or for
using SSH public key authentication from an untrusted host without fear
of giving up your secret key. 
</p></div><p>
Unlike tokens that require you to enter a PIN or transcribe a result,
the YubiKey 4 is designed for ease of use. Simply plug it in to a USB
port, and it will be seen as a USB keyboard that can interact directly
with your authentication dialogs.
</p><div       class="mediaobject"><a href="11956f2.large.jpg"><img src="11956f2.jpg"></a><div class="caption"><p>
Figure 2. Inserting a YubiKey 4 into a USB Port
</p></div></div><p>
In some modes, a user may be required to activate a touch-sensitive spot
on the token to authenticate when challenged, and in others, all that's
required is the device's physical presence. In either case, this
simplified approach to token-based authentication improves the user
experience tremendously.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x130a580.0x1402e00"></a>
YubiKey Configuration for Yubico OTP</h2></div></div><p>
<span   class="bold"><b>Using a Factory-Default YubiKey:</b></span>
</p><p>
The YubiKey 4 is a rugged USB token that comes pre-configured for
cloud-based authentication using 128-bit AES keys. In this mode,
YubiKeys generate 44-character one-time passwords on demand. Although the
YubiKey 4 is ready to use the Yubico OTP protocol via the YubiCloud
service out of the box, an additional configuration slot is available to
enable other protocols and local authentication options.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x130a580.0x1403010"></a></h2></div></div><div class="sidebar"><p class="title"><b>Warning: Why YubiKey Slot 1 Is Special</b></p><p>
Each YubiKey has two configuration slots. The first slot is
factory-configured to support the Yubico OTP protocol, and this protocol
validates against the Internet-accessible YubiCloud. Don't overwrite
this slot!
</p><p>
Overwriting a slot isn't a reversible action. You can't reload the slot
with previous data. You'll be required to create a <span   class="emphasis"><em>new</em></span> key with a
special &ldquo;vv&rdquo; prefix (rather than the Yubico-standard
&ldquo;cccccc&rdquo; prefix) to
assign to Slot 1, and then upload that new key to the YubiCloud. This is
only desirable in corporate settings where additional information (such as
organizational unit) needs to be encoded into the prefix, or when
compliance requirements require the use of an on-premises hardware
security module (HSM), such as the YubiHSM.
</p><p>
Although you <span   class="emphasis"><em>can</em></span> overwrite Slot 1 with a custom configuration, clobbering
the factory-default configuration creates unnecessary complications.
Therefore, most users and administrators should limit custom
configuration settings to Slot 2. However, if you <span   class="emphasis"><em>do</em></span> overwrite the
Slot 1 configuration, refer to the extensive Yubico documentation for
information on generating a new AES key and uploading it to the
YubiCloud or an on-premises authentication server.
</p></div><p>
In other words, if you simply want to use the factory-default
configuration for token-based validation against the YubiCloud, the
YubiKey token requires no further configuration. The key itself is ready
to use the moment you open the package and plug it in to a USB port!
</p><p>
Of course, even though the YubiKey arrives pre-configured, Linux
services still need to know how to validate a key and how to associate
an identity with that key. To do that, configure your Linux devices to
support the Yubico OTP protocol through OpenSSH and PAM as described
below.
</p><p><span   class="bold"><b>
Configure SSH for Challenge-Response Authentication:</b></span>
</p><p>
To use Yubico OTP or any of the YubiKey's other challenge-response
protocols for SSH authentication, you must first configure your OpenSSH
d&aelig;mon to support it. On Ubuntu 15.04, which is the reference system for
this article, the following settings must be present in the
/etc/ssh/sshd_config file:

<pre     class="programlisting">
ChallengeResponseAuthentication yes
UsePAM yes
</pre>
</p><p>
Reload the SSH server to enable the new configuration options to take
effect. Note that the Vagrantfile provided in the next section
will handle the configuration changes and reloading automatically for
you.
</p><p><span   class="bold"><b>
Supporting Yubico OTP in SSH with PAM:</b></span>
</p><p>
The standard Linux mechanism for authentication is PAM, which stands for
Pluggable Authentication Module. Yubico provides a BSD-licensed PAM
module, which is available on GitHub and in the repositories of many
recent distributions.
</p><p>
Once you have installed Yubico PAM, include the module in any
PAM-enabled service that you want to protect with a YubiKey. Although this
most often is the SSH service, you also can use it for console logins,
X11 logins or other PAM-protected services. Because it's possible to
lock yourself out of a machine through improper PAM configuration, and
because not all X11 display managers support challenge-response
authentication, this article remains focused on the common use case
of protecting the SSH service.
</p><p>
If you have Vagrant and VirtualBox installed, along with direct access
to the Internet, you can use the Vagrantfile shown in Listing 1 to create a
test instance. The Vagrantfile also will set up Yubico PAM for you while
provisioning the virtual machine (VM). This can save you a great deal of time
troubleshooting when setting up a YubiKey test environment.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x130a580.0x1403900"></a></h2></div></div><div class="sidebar"><p class="title"><b>Listing 1. Vagrantfile to Create a Test Instance</b></p><pre     class="programlisting">

Vagrant.configure(2) do |config|
  config.vm.box = 'ubuntu/vivid64'

  if defined? VagrantVbguest
    config.vbguest.auto_update = false
  end

  config.vm.provider :virtualbox do |v|
    v.gui = true
    v.customize ['modifyvm', :id, '--usb', 'on']
    v.customize [
      'usbfilter', 'add', '0',
      '--target', :id,
      '--name', 'yubikey',
      '--vendorid', '1050',
      '--productid', '0407',
    ]
  end

  config.vm.provision :shell, inline: &lt;&lt;-'SHELL'
    authfile='/etc/yubikey_mappings'

    packages=(
      libpam-{yubico,otpw}
      otpw-bin
      yubikey-personalization
    )
    export DEBIAN_FRONTEND=noninteractive
    apt-get install -y "${packages[@]}"

    if [[ ! -f "$authfile" ]]; then
      touch "$authfile"
      chmod 640 "$authfile"
    fi

    file='/etc/pam.d/sshd'
    comment='# Enable YubiCloud authentication.'
    config='auth       sufficient   pam_yubico.so'
    config="$config id=16 authfile=$authfile"
    if ! fgrep -q pam_yubico.so "$file"; then
      sed -i "2a\\$comment\n$config\n" "$file"
    fi

    comment='# Require OTPW one-time passwords.'
    config="# auth        requisite  pam_otpw.so\n"
    config+='# session     optional   pam_otpw.so'
    if ! egrep -q 'req.*pam_otpw' "$file"; then
      sed -i \
          "/pam_yubico/a\\\n$comment\n$config" \
          "$file"
    fi

    comment='# Require YubiCloud authentication.'
    config='# auth       requisite    pam_yubico.so'
    config="$config id=16 authfile=$authfile"
    if ! egrep -q 'req.*pam_yubico.so' "$file"; then
      sed -i \
          "/pam_yubico/a\\\n$comment\n$config" \
          "$file"
    fi

    dir='/etc/yubico'
    if [[ ! -d "$dir" ]]; then
      mkdir -pm 1777 "$dir"
    fi

    file='/etc/pam.d/common-auth'
    comment='# Enable HMAC-SHA1 to succeed without '
    comment+=" a second factor, even with\n"
    comment+='# encrypted home directories.'
    config='# auth    sufficient    '
    config+='pam_yubico.so '
    config+='mode=challenge-response '
    config+='#chalresp_path=/etc/yubico'
    if ! fgrep -q pam_yubico.so "$file"; then
      sed -i \
          -e "/# pam-auth-update(8)/a\\\n$comment" \
          -e "/# pam-auth-update(8)/a\\$config" \
        "$file"
    fi

    file='/etc/ssh/sshd_config'
    keyword='ChallengeResponseAuthentication'
    if ! egrep -q "^$keyword yes" "$file"; then
      sed -ri "s/($keyword) no/\\1 yes/" "$file"
      service ssh reload
    fi

    dir='/etc/udev/rules.d/'
    rules=($dir/*)
    if [[ ${#rules} -ne 2 ]]; then
        url="https://raw.githubusercontent.com"
        url="${url}/Yubico/yubikey-personalization"
        url="${url}/master"
        url="${url}/[69-70]-yubikey.rules"
        cd "$dir"
        curl -sLO "$url"
        udevadm trigger
    fi
  SHELL
end

</pre></div><p>
Bring up the VM with the following command:

<pre     class="programlisting">
$ vagrant up --provider virtualbox
</pre>
</p><p>
If you have a real server to work with or prefer to configure an
existing box rather than a VM, ensure that the
<tt  >pam_yubico.so</tt> module is
included at the very top of your PAM configuration file for the SSH
service. On the Ubuntu reference platform for this article, the PAM configuration file is
/etc/pam.d/sshd, but it may be different on your distribution.
</p><p>
As an example, the top of your file should look similar to the
following:

<pre     class="programlisting">
# PAM configuration for the Secure Shell service

# Enable YubiCloud authentication.
auth    sufficient  pam_yubico.so id=16 authfile=/etc/yubikey_mappings

# Standard Un*x authentication.
@include common-auth
</pre>
</p><p>
This particular PAM configuration prompts the user for YubiKey
authentication before falling back to a standard password prompt. See
the sidebar on precedence for more information about the order in which
authentications happens.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x130a580.0x17fbfc8"></a></h2></div></div><div class="sidebar"><p class="title"><b>
Precedence of Authentication Steps</b></p><p>
OpenSSH and PAM both contain authentication rules and can support very
complex configurations when necessary. However, when configured on the
reference platform as described in this article, the precedence of
authentication mechanisms (unless overridden by the SSH client) will be as
follows:
</p><div class="orderedlist"><ol type="1"><li><p>
Public key authentication.
</p></li><li><p>
YubiKey authentication.
</p></li><li><p>
UNIX password authentication.
</p></li></ol></div><p>
This is generally the appropriate order of precedence, but if necessary,
it can be adjusted through one or more of the following mechanisms:
</p><div class="orderedlist"><ol type="1"><li><p>
The precedence defined by <tt  >PreferredAuthentications</tt> in the SSH client.
</p></li><li><p>
The authentication methods allowed by your SSH server configuration.
</p></li><li><p>
Multiple authentications as required by the
<tt  >AuthenticationMethods</tt>
server option.
</p></li><li><p>
The PAM stack defined for your SSH service.
</p></li></ol></div></div><p><span   class="bold"><b>
Map Users to YubiKeys:</b></span>
</p><p>
With the OpenSSH and PAM configuration now done, there is one more step
to complete before YubiKey authentication will work: mapping system
users to authorized tokens.
</p><p>
First, it's important to understand <span   class="emphasis"><em>why</em></span> this step is necessary,
especially when using the YubiCloud. The challenge-response
configuration you've implemented here pairs a token holding a secure element
(the YubiKey) with an AES key stored in the YubiCloud. Without a way to
authorize tokens, a user could use <span   class="emphasis"><em>any</em></span> valid token to log in, even if
the token wasn't issued to that user. In addition, unless you map tokens
to specific accounts, you can't identify the holder of a token nor limit
the accounts a given token can be used to access.
</p><p>
To address these concerns, you will use a file defined by your PAM configuration
to map tokens to users. This restricts who may use YubiKeys to
authenticate to the system, as well as tying a given YubiKey to a
specific user or system account.
</p><p>
This mapping is done using a 12-character modified hexadecimal (ModHex)
prefix unique to each AES key. The prefix for factory-configured
YubiKeys starts with &ldquo;cccccc&rdquo;, although custom or reconfigured YubiKeys
always start with &ldquo;vv&rdquo;. The following script will enable you to 
identify the necessary prefix for your YubiKey easily:

<pre     class="programlisting">
#!/usr/bin/env bash

read -p 'Enter Yubico OTP: '
echo "${REPLY:0:12}"
</pre>
</p><div class="orderedlist"><ol type="1"><li><p>
Place the script into your path and make it executable.
</p></li><li><p>
Insert your YubiKey into an available USB port.
</p></li><li><p>
Run the script.
</p></li><li><p>
When prompted, <span   class="emphasis"><em>briefly</em></span> press the round sensor for 0.3 to 1.5
seconds to issue a one-time password using the factory-default
setting in Slot 1. Please note that longer presses of 2.5&ndash;5.0 or 8&ndash;15
seconds trigger other behaviors; see the YubiKey Manual for details.
</p></li><li><p>
Copy the prefix; this will be associated with a user name in the
mapping file defined in your PAM configuration.
</p></li></ol></div><p>
When you run the script and trigger your YubiKey, you should see output
similar to the following:

<pre     class="programlisting">
$ bash yubikey-id.sh
Enter Yubico OTP: ccccccrlivbljtkhdinnclelldrktdefttuuuecfjdbh
ModHex Prefix: ccccccrlivbl
</pre>
</p><p>
Using this example, you would map &ldquo;ccccccrlivbl&rdquo; to the user assigned
that particular YubiKey device. You do that in the authfile defined in
your PAM configuration file.
</p><p>
If you use the Vagrantfile from Listing 1, you can
configure the mapping file from the host machine with a single command
and a tap of your YubiKey:

<pre     class="programlisting">
vagrant ssh -- \
    "echo 'vagrant:$(yubikey-id.sh)' |
     sudo tee -a /etc/yubikey_mappings"
</pre>
</p><p>
Otherwise, log in to your test system and edit the mapping file in the
form of <tt  >&lt;username&gt;:&lt;prefix&gt;</tt>. To assign more than one YubiKey per user,
separate each prefix from the next one with a colon.
</p><p><span   class="bold"><b>
Testing Your YubiKey:</b></span>
</p><p>
Now you're ready to test authentication with Yubico OTP! If possible,
remain logged in as root on the box that you're testing while you verify
the configuration in another window. If you have made a mistake in one
of the configuration files, you may not be able to reconnect.
</p><p>
If you are using the Vagrant test instance, use the following command to
perform a valid test of Yubico OTP:

<pre     class="programlisting">
vagrant ssh -- \
    -S none \
    -o PreferredAuthentications=keyboard-interactive
</pre>
</p><p>
This will force the SSH client to disable connection sharing so that it
won't reuse an existing connection where you already may have
authenticated with an SSH key or password. In addition, it will tell the
client to try challenge-response before presenting any SSH keys.
</p><p>
If you are not using Vagrant, use the <tt  >-S none</tt> and
<tt  >-o
PreferredAuthentications=keyboard-interactive</tt> arguments anyway to
ensure you are performing a valid test. However, feel free to modify
other aspects of SSH client behavior to fit your specific environment.
</p><p>
If your OpenSSH and PAM settings are correct, you will see a prompt
similar to the one shown in Figure 3.
</p><div       class="mediaobject"><a href="11956f3.large.jpg"><img src="11956f3.jpg"></a><div class="caption"><p>
Figure 3. OpenSSH Dialog Prompting User for YubiKey
</p></div></div><p>
To continue, press the sensor on your YubiKey for 0.3 to 1.5 seconds to
submit your one-time password. Assuming that your mapping file is
correct, and that the PAM module is able to connect to the Internet and
reach the YubiCloud service, you will be logged in.
</p><p>
If you're also prompted for your system password but haven't configured
two-factor authentication, as described later in this article, it's
likely that your mapping file or ability to connect to the YubiCloud
service is the problem. Double-check the mapping file and your Internet
connectivity. If problems persist, refer to the Yubico PAM documentation
for instructions on how to turn on debug-level logging.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x130a580.0x17fd8e0"></a>
Adding a Second Authentication Factor</h2></div></div><p>
Two-factor authentication is sometimes defined as something you know
(such as a PIN) and something you have, such as an OTP calculator or token.
As you've implemented the system thus far, you've really implemented
only one-time passwords in a way that is similar to S/Key or OTPW, but much
easier for the end user. No password lists to carry around, no password
prefixes to memorize&mdash;just connect, press the sensor, and bingo!
</p><p>
You can implement true two-factor authentication by making a minor change
to your SSH server's PAM configuration. For example, you can require the
use of a password (something you know) <span   class="emphasis"><em>in addition to</em></span> a YubiKey
(something you have).
</p><p>
To do this, change the control value of Yubico PAM from
&ldquo;sufficient&rdquo; to
&ldquo;requisite&rdquo;. In your original one-time password configuration, the module
was <span   class="emphasis"><em>sufficient</em></span> by itself to grant access when Yubico OTP succeeded,
but would fall back to the next authentication option if it failed. With
the change to <span   class="emphasis"><em>requisite</em></span>, Yubico OTP is now required, and the PAM
authentication stack will return immediately from a failure. The first
four lines of /etc/pam.d/sshd now contain:

<pre     class="programlisting">
# PAM configuration for the Secure Shell service

# Require token-based Yubico OTP authentication.
auth    requisite  pam_yubico.so id=16 authfile=/etc/yubikey_mappings
</pre>
</p><p>
Your login dialog now should look like Figure 4, even when your YubiKey
successfully validates against the YubiCloud.
</p><div       class="mediaobject"><a href="11956f4.large.jpg"><img src="11956f4.jpg"></a><div class="caption"><p>
Figure 4. Two-Factor Authentication with YubiKey and Password
</p></div></div><p>
A compromised machine can't extract elements from the YubiKey for later
use or replay a one-time password using the Yubico OTP protocol once
the password has been used. Even assuming that you are logged in on a
compromised workstation, two-factor authentication is surprisingly
robust even when exposing your password to the local host. By combining
your password with the one-time passwords provided by the YubiKey token,
and given the necessity of having physical possession of the token in
order to issue one-time passwords, your overall risk is actually
reduced.
</p><p>
However, if you are exposing a password that you use on multiple
machines, and not all of those machines are protected by two-factor
authentication, this would be an unacceptable risk. You can do
better!
</p><p>
It's possible to modify the PAM stack further to replace the request for
your Linux system password with a request for a different one-time
password system, such as OTPW. For example, on the example reference platform,
you
might require the OTPW module <span   class="emphasis"><em>in addition to</em></span> Yubico OTP. Assuming that
OTPW has been installed and configured, your PAM module in
/etc/pam.d/sshd would look like this:

<pre     class="programlisting">
# PAM configuration for the Secure Shell service

# Require token-based Yubico OTP authentication.
auth    requisite  pam_yubico.so id=16 authfile=/etc/yubikey_mappings

# Require OTPW one-time passwords.
auth        requisite  pam_otpw.so
session     optional   pam_otpw.so
</pre>
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x130a580.0x17fe0c8"></a></h2></div></div><div class="sidebar"><p class="title"><b>
OpenSSH AuthenticationMethods</b></p><p>
It's worth noting that recent versions of OpenSSH v6.2 and later support
multifactor authentication through the
<tt  >AuthenticationMethods</tt>
server configuration option. However, in most cases, PAM provides a more
customizable experience with a wider range of supported authentication
options.
</p><p>
At the time of this writing, using <tt  >AuthenticationMethods</tt> instead of PAM
for multifactor authentication on Linux systems appears to be of
limited value. However, this feature <span   class="emphasis"><em>does</em></span> allow OpenSSH to require the
user to authenticate using more than one public key at a time. This is
something PAM cannot do, and the feature may grow more robust in the
future.
</p></div><p>
Of course, to ensure that the system requires both Yubico OTPW and your
second-factor authenticator, you also must disable standard password
authentication via PAM. On the reference platform, edit /etc/pam.d/sshd
and prefix <tt  >@include common-auth</tt> with a comment character.
</p><p>
Once you've initialized OTPW with:

<pre     class="programlisting">
$ vagrant ssh -- otpw-gen &gt; password-list.txt
</pre>
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x130a580.0x198cde8"></a></h2></div></div><p>
you're ready to test out two-factor authentication. With public key
authentication disabled, you should be prompted for an OTPW password
after successfully authenticating your YubiKey.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x130a580.0x198cef0"></a>
Local Validation</h2></div></div><p>
In some cases, it's undesirable to validate to the YubiCloud or other
networked resource. If you can physically plug the YubiKey token in to
your server or workstation, HMAC-SHA1 is a good alternative. In
this mode, YubiKey's challenge-response feature is very similar to
S/Key, OPIE or OTPW one-time password systems, but requires only the
physical presence of the token.
</p><p><span   class="bold"><b>
Installing the YubiKey Command-Line Personalization Tool:</b></span>
</p><p>
The YubiKey configuration tools ykpersonalize and ykpamcfg are
available from the yubikey-personalization package on Ubuntu 15.04. If
you're using the Vagrantfile provided here, this package already has been
installed and configured for you. Otherwise, go ahead and install it
now.
</p><p>
Next, install the udev rules to give non-root users access to the
YubiKey device. The yubikey_udev_rules.sh script below downloads the latest
rules for you and places them into the correct location on an Ubuntu
machine (adjust the download directory on other distributions if
necessary):

<pre     class="programlisting">
#!/usr/bin/env bash

# Purpose:
#     Download the latest udev rules for the YubiKey
#     Personalization Tools.

url="https://raw.githubusercontent.com"
url="${url}/Yubico/yubikey-personalization"
url="${url}/master"
url="${url}/[69-70]-yubikey.rules"

cd /etc/udev/rules.d/
sudo curl -sLO "$url"
</pre>
</p><p>
Finally, run <tt  >sudo udevadm trigger</tt> to force udev to use the new rules
you just installed. Otherwise, the rules may not take effect until the
next reboot.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x130a580.0x198d260"></a></h2></div></div><div class="sidebar"><p class="title"><b>Debugging YubiKey Configuration Tools</b></p><p>
Use a recent version of the command-line YubiKey Personalization Tools.
At the time of this writing, the current stable version is v1.17.2.
Also, ensure you're logged in on a local TTY rather than over the
network with telnet or SSH.
</p><p><span   class="bold"><b>
Outdated Tools:</b></span>
</p><p>
If you see an error like &ldquo;Yubikey core error: no yubikey present&rdquo;
when trying to configure the token, try the following command to see if
your YubiKey is being detected as a USB device:

<pre     class="programlisting">
$ lsusb | fgrep Yubico
Bus 001 Device 003: ID 1050:0407 Yubico.com
</pre>
</p><p>
If your device is detected, but the problem persists, the personalization
tools may not be current. Use version 1.16.2 or later of the tools.
</p><p><span   class="bold"><b>
Permission Problems:</b></span>
</p><p>
On the other hand, &ldquo;USB error: Access denied (insufficient
permissions)&rdquo;
is telling you that:
</p><div class="itemizedlist"><ul type="disc"><li><p>
You don't have the proper udev rules installed.
</p></li><li><p>
You are attempting to use the tools via SSH, rather than from a
console.
</p></li></ul></div></div><p>
Make sure you download the latest udev rules from the GitHub repository
and connect directly to a console or through your virtual machine's
graphical user interface.
</p><p>
<span   class="bold"><b>Configuring HMAC-SHA1 Challenge-Response:</b></span>
</p><p>
Once the udev rules are installed, you're ready to configure the key
from a local console. If using the VM, log in through the graphical user
interface using the user name &ldquo;vagrant&rdquo; and the password
&ldquo;vagrant&rdquo;.
</p><p>
First, use the YubiKey personalization tools to enable HMAC-SHA1
challenge-response from Slot 2:

<pre     class="programlisting">
# Configure Slot 2 for HMAC-SHA1.
yes | ykpersonalize -2 \
                    -ochal-resp \
                    -ochal-hmac \
                    -ohmac-lt64 \
                    -oserial-api-visible
</pre>
</p><p>
Next, initialize the file that holds the challenge-response pairs using
your new Slot 2 configuration:

<pre     class="programlisting">
ykpamcfg -2
</pre>
</p><p>
Finally, configure PAM to accept the HMAC-SHA1 credentials during
console logins by placing challenge-response authentication
<span   class="emphasis"><em>before</em></span> the
primary block in /etc/pam.d/common-auth. Use the following excerpt as
guidance:

<pre     class="programlisting">
# /etc/pam.d/common-auth - authentication settings common to all 
# services
#
# This file is included from other service-specific PAM config files,
# and should contain a list of the authentication modules that define
# the central authentication scheme for use on the system
# (e.g., /etc/shadow, LDAP, Kerberos, etc.).  The default is to use 
# the traditional Unix authentication mechanisms.
#
# As of pam 1.0.1-6, this file is managed by pam-auth-update by default.
# To take advantage of this, it is recommended that you configure any
# local modules either before or after the default block, and use
# pam-auth-update to manage selection of other modules.  See
# pam-auth-update(8) for details.

# Enable HMAC-SHA1 to succeed without a second factor.
auth    sufficient    pam_yubico.so mode=challenge-response

# here are the per-package modules (the "Primary" block)
auth    [success=1 default=ignore]      pam_unix.so nullok_secure
</pre>
</p><p>
If you're using the VM, just uncomment module in common-auth. However,
leave the directory argument commented out for now. At this time, if you
specify a global directory for HMAC-SHA1, the PAM module will not find
the challenge-response file in the user's home directory. (I'll discuss
use of the global directory in the next section.)
</p><p>
The changes you made in common-auth won't affect non-local connections
such as SSH <span   class="emphasis"><em>unless</em></span> you're connecting to a local VM. This is typically
because the host machine and the VM share access to the YubiKey.
Remember that HMAC-SHA1 is for authenticating console access only!
</p><p>
Now that PAM has been updated, attempt to log in again from a console.
You should be authenticated automatically immediately after typing your
user name at the login prompt. However, when you modify PAM, login may
not pick up the configuration changes immediately. If this happens, just
press return a few times on your console until the screen clears and the
login prompt starts again at the top of the screen.
</p><p><span   class="bold"><b>
HMAC-SHA1 with Encrypted Home Directories:</b></span>
</p><p>
If you use encrypted home directories, such as Ubuntu's eCryptfs, 
challenge-response files must be moved out of the user's home directory
and into a central location, such as /etc/yubico. Otherwise, the
challenge-response files can't be read or updated by PAM during the
authentication process when the directory is unmounted.
</p><p>
On such systems, the module authors recommend a publicly writable
central location with the sticky bit set. This is similar to the /tmp
directory and allows users to update their challenge-response files
after each log in:

<pre     class="programlisting">
sudo mkdir --mode=1777 /etc/yubico
</pre>
</p><p>
Next, add this central directory to your PAM configuration using the
<tt  >chalresp_path</tt> option. If using the VM, just uncomment the provided
argument:

<pre     class="programlisting">
# /etc/pam.d/common-auth - authentication settings common to all 
# services
#
# This file is included from other service-specific PAM config files,
# and should contain a list of the authentication modules that define
# the central authentication scheme for use on the system
# (e.g., /etc/shadow, LDAP, Kerberos, etc.).  The default is to use the
# traditional Unix authentication mechanisms.
#
# As of pam 1.0.1-6, this file is managed by pam-auth-update by default.
# To take advantage of this, it is recommended that you configure any
# local modules either before or after the default block, and use
# pam-auth-update to manage selection of other modules.  See
# pam-auth-update(8) for details.

# Enable HMAC-SHA1 to succeed without a second factor, even with
# encrypted home directories.
auth    sufficient    pam_yubico.so mode=challenge-response
chalresp_path=/etc/yubico

# here are the per-package modules (the "Primary" block)
auth    [success=1 default=ignore]      pam_unix.so nullok_secure
</pre>
</p><p>
All users must then move their challenge-response file into this central
directory and rename the file's prefix from &ldquo;challenge&rdquo; to their login
name. For example:

<pre     class="programlisting">
mv ~/.yubico/challenge-* \
   "/etc/yubico/$LOGNAME-$(ykinfo -qs)"
</pre>
</p><p>
<span   class="bold"><b>Adding a Second Factor to HMAC-SHA1:</b></span>
</p><p>
As with Yubico OTP, it's easy to add a second factor to HMAC-SHA1
challenge-response authentication. Simply substitute 
<tt  >auth sufficient pam_yubico.so</tt> with <tt  >auth required
pam_yubico.so</tt> in the common-auth file, and PAM will mandate the
presence of the user's YubiKey in addition to any other required
authentications. On the reference system, this will be the system
password by default, but other configurations are possible.
</p><p>
In general, use <span   class="emphasis"><em>required</em></span> here instead of
<span   class="emphasis"><em>requisite</em></span>. Using &ldquo;required&rdquo;
ensures that the rest of the PAM stack (such as the system password
prompt) is evaluated before returning a response even though
authentication can't succeed if the YubiKey isn't present or valid. Not
returning immediately prevents a potential attacker from seeing &ldquo;Login
incorrect&rdquo; immediately after typing in a user name. However, this
represents a trade-off for users. With &ldquo;required&rdquo;, if users forget to
insert their YubiKeys <span   class="emphasis"><em>before</em></span> attempting to login, they may think
they've simply mistyped their password and become frustrated. The
trade-off between user experience and security in this particular case
is yours to make.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x130a580.0x198e758"></a>
Summary</h2></div></div><p>
I have described two types of challenge-response systems using the
YubiKey 4 USB tokens: Yubico OTP with YubiCloud validation and
HMAC-SHA1 for local validation. I've also explored different ways to
configure YubiKey authentication using PAM, including support for
two-factor authentication.
</p><p>
The YubiKey 4 is a worthwhile replacement for other one-time password
and two-factor authentication systems due to its flexibility, rugged
design and convenient form factor.
</p><p>
In addition, the device's support for OpenPGP smartcard standards and
other code-signing features makes it a good choice for administrators,
developers and DevOps engineers who need secure access to their secret
keys when on the go.
</p><p>
This article provides a solid foundation for implementing the
device's basic security features. Hopefully, it has also whet your
appetite for exploring additional uses for the YubiKey 4.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x130a580.0x198e968"></a></h2></div></div><div class="sidebar"><p class="title"><b>Resources</b></p><p><span   class="bold"><b>
Essential Resources for This Article:</b></span>
</p><p>
Yubico PAM Module: <a href="https://developers.yubico.com/yubico-pam" target="_self">https://developers.yubico.com/yubico-pam</a>
</p><p>
YubiKey Personalization Tools: <a href="https://github.com/Yubico/yubikey-personalization" target="_self">https://github.com/Yubico/yubikey-personalization</a>
</p><p><span   class="bold"><b>
Additional YubiKey-Related Resources:</b></span>
</p><p>
Yubico Home Page: <a href="https://www.yubico.com" target="_self">https://www.yubico.com</a>
</p><p>
Yubico Downloads: <a href="https://www.yubico.com/support/downloads" target="_self">https://www.yubico.com/support/downloads</a>
</p><p>
Yubico Documentation: <a href="https://www.yubico.com/support/documentation" target="_self">https://www.yubico.com/support/documentation</a>
</p><p>
YubiCloud Connector Libraries: <a href="https://developers.yubico.com/OTP/Libraries/List_of_libraries.html" target="_self">https://developers.yubico.com/OTP/Libraries/List_of_libraries.html</a>
</p><p>
Supported YubiCloud Alternatives for Yubico OTP:
</p><div class="itemizedlist"><ul type="disc"><li><p>
YubiKey Key Storage Module (YK-KSM):
<a href="https://github.com/Yubico/yubikey-ksm" target="_self">https://github.com/Yubico/yubikey-ksm</a>
</p></li><li><p>
YubiKey OTP Validation Server (YK-VAL): <a href="https://github.com/Yubico/yubikey-val" target="_self">https://github.com/Yubico/yubikey-val</a>
</p></li><li><p>
Python YubiHSM (PyHSM): <a href="https://github.com/Yubico/python-pyhsm" target="_self">https://github.com/Yubico/python-pyhsm</a>
</p></li></ul></div><p>
Yubico Authenticator for OATH (desktop app):
<a href="https://github.com/Yubico/yubioath-desktop" target="_self">https://github.com/Yubico/yubioath-desktop</a>
</p></div></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x130a580.0x1991ac8"></a></h2></div></div><div class="sidebar"><p class="title"><b></b></p><p>Send comments or feedback via <a href="http://www.linuxjournal.com/contact" target="_self">www.linuxjournal.com/contact</a> or to
<a href="mailto:info@linuxjournal.com">info@linuxjournal.com</a>.
</p></div></div></div>
<div class="authorblurb"><p>
Todd A. Jacobs is a veteran IT consultant who currently specializes in
automation and security. In what passes for his free time, Todd is also
a top contributor on Stack Overflow and Project Management Stack
Exchange. In between writing, coding and (of course) drinking way too
much coffee, he practices the ancient arts of marriage and fatherhood to
the very best of his ability.
</p></div>

  <div class="toclinks">
    <a class="link1" href="../tocindex.html">Archive Index</a>
    <a class="link2" href="../265/toc265.html">Issue Table of Contents</a>
    <a class="link3" href="../265/11956.html">Article</a>
  </div>
  <div class="bottomhrdiv">
  </div>
  
  <div id="bottom_search">
  <table class="page_search" summary="">
    <tr>
      <td valign="top" align="left">
        <p class="small_shutdown"><a href="/.exit">Shutdown Archive web server</a></p>
      </td>
      <td valign="top" align="right">
        <form method="get" action="/zoom/search.cgi">
          <input type="hidden" name="zoom_sort" value="0" />
          <input type="hidden" name="zoom_xml" value="0" />
          <input type="hidden" name="zoom_per_page" value="10" />
          <input type="hidden" name="zoom_and" value="1" />
          Search: <input type="text" name="zoom_query" size="20" value="" class="zoom_searchbox" />
          <input type="submit" value="Submit" />
        </form>
      </td>
    </tr>
  </table>
  </div>
  
  <div class="footerdiv">
    <a href="../../index.html">
      <img class="bottomimg" src="../../images/CD_FooterBanner.png" alt="LJ Archive"/>
    </a>
  </div>
  
  <div class="copyright">
    Copyright &copy; 1994 - 2018 <cite>Linux Journal</cite>.  All rights reserved.
  </div>
  </body></html>