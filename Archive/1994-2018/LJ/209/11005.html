<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"><html><head><META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>
Multiplatform GNU Development
</title><link rel="stylesheet" href="../css/archive.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.57.0"><meta name="description" content="&#10;Get a guitar synth working with Rock Band 3.&#10;"><link rel="stylesheet" href="../../css/archive.css" type="text/css"><script type="text/javascript" src="../../js/archive.js"></script><script type="text/javascript" src="../../js/highlight.js"></script></head><body onload="search_highlight();">
  <div class="headerdiv">
    <a href="../../index.html">
      <img class="topimg" src="../../images/CD_HeaderBanner.png" alt="LJ Archive"/>
    </a>
  </div>
  
  <div class="tophrdiv">
  </div>
  
  <div id="top_search">
  <table class="page_search" summary="">
    <tr>
      <td valign="top" align="left">
        <p class="small_shutdown"><a href="/.exit">Shutdown Archive web server</a></p>
      </td>
      <td valign="top" align="right">
        <form method="get" action="/zoom/search.cgi">
          <input type="hidden" name="zoom_sort" value="0" />
          <input type="hidden" name="zoom_xml" value="0" />
          <input type="hidden" name="zoom_per_page" value="10" />
          <input type="hidden" name="zoom_and" value="1" />
          Search: <input type="text" name="zoom_query" size="20" value="" class="zoom_searchbox" />
          <input type="submit" value="Submit" />
        </form>
      </td>
    </tr>
  </table>
  </div>
  <div class="article" lang="en"><div class="titlepage"><div><h1 class="title"><a name="N0x27eb580.0x28e2ac0"></a>
Multiplatform GNU Development
</h1></div><div><div class="author"><h3 class="author">
Nathanael
 
Anderson
</h3></div><div class="issuemoyr">Issue #209, September 2011</div></div><div><p>
Get a guitar synth working with <span   class="emphasis"><em>Rock Band 3</em></span>.
</p></div></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x27eb580.0x28e32a8"></a></h2></div></div><p>
In my ideal world, mixing games and music would result in music games
that use real instruments. Harmonix's <span   class="emphasis"><em>Rock Band</em></span> series is the closest
mainstream realization of this lofty ideal, except for one major issue. I
couldn't plug in my guitar and play pro guitar mode songs out of the box.
</p><p>
Now, before you think this is an impossible task, one important
fact should be noted. I play a guitar synthesizer. What this means is
my guitar has a hexaphonic pickup that reads and processes every
string's signal individually and connects with a 13-pin cable to a guitar
processor with midi out. This means my signal is already digital and,
therefore, does not require any additional A/D algorithms in my software.

</p><div       class="mediaobject"><a href="11005f1.large.jpg"><img src="11005f1.jpg"></a><div class="caption"><p>
From left to right: custom-built guitar synth, custom-built rack for VG-99, Axon AX-100
and Fantom-XR.
</p></div></div><div       class="mediaobject"><a href="11005f2.large.jpg"><img src="11005f2.jpg"></a><div class="caption"><p>
Custom-built guitar synth, built by the author.
</p></div></div></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x27eb580.0x28e3930"></a>
The Hardware</h2></div></div><p>
I have a few guitars with different 13-pin interfaces that can connect
to an Axon AX-100 that has its midi out running to the midi in port
on an M-Audio UNO, which gets connected to my Linux box running
g2ghpro. The midi out port on the UNO then runs into a PS3 <span   class="emphasis"><em>Rock
Band</em></span>
adapter and into my PS3. A guitar hexaphonic guitar pickup with
13-pin midi out is required to run g2ghpro. The following lists are of tested
hardware that will work:
</p><p>
Pickups:
</p><div class="itemizedlist"><ul type="disc"><li><p>
Roland GK-3a.
</p></li><li><p>
Roland GK-2a.
</p></li><li><p>
Roland GK-3b.
</p></li><li><p>
Graph Tech LB-63 (any Graph Tech piezo bridge will work if using the
hexpander module).
</p></li><li><p>
Godin Synth Access guitars.
</p></li></ul></div><p>
Guitars with built-in 13-pin capability:
</p><div class="itemizedlist"><ul type="disc"><li><p>
Godin LGX-SA.
</p></li><li><p>
Godin Freeway-SA.
</p></li><li><p>
Godin LGXT.
</p></li><li><p>
Roland Ready Fender stratocaster.
</p></li><li><p>
Brian Moore i8.13.
</p></li></ul></div><p>
Guitar-to-midi converters:
</p><div class="itemizedlist"><ul type="disc"><li><p>
Axon Ax-100.
</p></li><li><p>
Roland VG-99.
</p></li><li><p>
Roland GR-55.
</p></li><li><p>
Roland GR-20.
</p></li></ul></div><p>
Of the listed hardware, I use a Roland VG-99, Axon Ax-100, Godin
LGX-SA, Godin LGX with Roland GK-3a and custom-built Ibanez S540 with
Graph Tech LB-63 and hexpander.
</p><p>
I've also tested g2ghpro with a Roland GK-3a pickup running into a
Roland VG-99. Others have reported using a Roland GK-3a with GR-20 and
GK-3b with GR-55 on a bass guitar as well. G2ghpro currently is the only
solution for using a real bass guitar in the game, as no official bass guitar
controllers have been released at this point.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x27eb580.0x28e46f0"></a>
The Original Controller</h2></div></div><p>
Harmonix created two guitar controllers for <span   class="emphasis"><em>Rock Band
3</em></span> pro guitar
mode. The first controller released was the Mustang, which is a
&ldquo;button&rdquo;
controller, with 102 buttons on the frets and six strings over the body
of the guitar. When I wrote the initial version of g2ghpro, the Fender
Squier Pro Strat wasn't on the market yet, which is the other pro guitar
controller that works with the game. So I had midi dumps only from the
Mustang to work with.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x27eb580.0x28e48a8"></a>
Midi</h2></div></div><p>
In order to understand how the Mustang worked, I first had to understand
what the Mustang dumps meant and relate controller actions to messages
sent. This required a refresher on the midi standard. Midi has
16 separate channels, and changing the sending channel is done by adding
the value of the channel minus one to the message type value. My first
example is a midi &ldquo;note on&rdquo; message, which has a decimal value of 144
in the first byte for channel 0. To send the same message on channel 6,
add 5 to 144.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x27eb580.0x28e4a60"></a>
Example Data</h2></div></div><p>
Action: held fret one of low E and picked low E:


<pre     class="programlisting">
TIMESTAMP IN PORT STATUS DATA1 DATA2 CHAN NOTE   EVENT
0023E843    1      --     95    29    00  6 F 2  Note Off 
0023E843    1      --     95    29    7D  6 F 2  Note On 
0023E847    1      --     F0    Buffer: 8 Bytes System Exclusive
SYSX: F0 08 40 0A 05 06 7D F7
</pre>
</p><p>
The dumps I had found came from a Windows program called Midi Ox, which
showed the data in hex. The midi specification shows data in binary, and
I was used to seeing this data with aseqdump in decimal. I converted all
the examples I had been provided with into decimal so I could understand
their behavior. The midi spec states that note on-and-off events contain
3 bytes of data. The first byte is event type plus channel; the second is
note number, and the third is velocity. From experience, I've seen that many
devices send a velocity event of 0 instead of an actual note off event,
which is what the above shows. So, the result after it has been converted
to decimal is (note: velocity zero below is really note off):

<pre     class="programlisting">
Type             Channel  Note  Velocity
(Note On 149)    5          41       00 
(Note On 149)    5          41      125
</pre>
</p><p>
SysEx is short for System Exclusive messages, and they are free-form
messages to send data that doesn't fit into the predefined midi message
types. Initially, I tried to treat the data from the dumps as a normal
midi controller, and I ignored the SysEx data in the dump, which I later
realized is why I didn't have any code that made the game react. All
game functions react to SysEx messages, not note events. This is
why a guitar synthesizer cannot be plugged in to <span   class="emphasis"><em>Rock
Band</em></span> and just
work. At this point, I requested more dumps, where different frets were
pressed down with the same string pressed.
</p><p>
I converted all the dumps I had to decimal and compared SysEx messages to
note messages and found a correlation. Here's the resulting structure of the
messages (displayed in decimal):

<pre     class="programlisting">
Part         1  2  3  4 5 6  7  8
Sample      240 8 64 10 1 1 43 247
</pre>
</p><div class="itemizedlist"><ul type="disc"><li><p>
Part 1: starting byte of a SysEx message.
</p></li><li><p>
Part 2, 3, 4: identifiers that this is a SysEx message 
used by the Mustang.
</p></li><li><p>
Part 5: message type (1 = set fret position, 5 = play string).
</p></li><li><p>
Part 6: midi channel (string on the instrument).
</p></li><li><p>
Part 7: midi note number.
</p></li><li><p>
Part 8: end SysEx message.
</p></li></ul></div></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x27eb580.0x2cdd4f0"></a>
The Software</h2></div></div><p>
To explore the message format, I put together a quick program for sending
a combination of note events and SysEx messages to the game. I know
that the guitar synthesizer hardware required to use the software I was
writing isn't very common, so I want to be proactive in removing any
limitations to people using it. I've done midi and C++ programming with
ALSA under Linux before, but never midi on Windows or OS X, and I wanted
to be able to support all three to make the software more accessible.
</p><p>
From past experience with RtMidi, I knew it was written in portable C++,
while supporting Windows, Linux and OS X.
</p><p>
The home page for RtMidi provides detailed, easy-to-read documentation,
with examples for many basic midi tasks. Copy-and-paste examples are
provided that give a base from which to start working, along with ready-to-compile demos provided in the tests directory in the RtMidi source code.
</p><p>
A good place to start with RtMidi is the bundled code in the tests
directory. I started by modifying midiout.cpp and tried sending
different SysEx messages based on my data dumps until finally I ended
up with the following:


<pre     class="programlisting">

std::vector&lt;unsigned char&gt; sysExMessage;
sysExMessage.push_back( 240);
sysExMessage.push_back( 8 );
sysExMessage.push_back( 64 );
sysExMessage.push_back( 10  );
sysExMessage.push_back( 1); // 1 sets fret position, 
                            // 5 to play the current string
sysExMessage.push_back( channel + 1 ); // channel
sysExMessage.push_back( note );
sysExMessage.push_back( 247 );
midiout-&gt;sendMessage( &amp;sysExMessage );

</pre>
</p><p>
With that SysEx message, I was able to toggle fret position and
strings played in the game. The actual logic to make this work was
less than 100 lines. The full code is available in the Subversion repository
for game2midi in g2ghpro.cpp.
</p><p>
RtMidi currently has issues processing active sensing messages that came
from my Roland gear, which the author is aware of. A flag is provided to
filter out active sensing messages. Setting ignoreTypes to true on your
midi input object's third parameter will work around the issue until it
is resolved&mdash;for example:

<pre     class="programlisting">
midiin-&gt;ignoreTypes( false, false, true);
</pre>
</p><p>
The main missing feature of RtMidi, as far as the Linux pro audio world
is concerned, is no jack-midi support.
</p><p>
The RtMidi documentation listed compiler flags for all three operating
systems to link the required libraries, so all that was left for me to
do was figure out how to compile under Windows.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x27eb580.0x2cdd9c0"></a>
Supporting Other Operating Systems</h2></div></div><p>
I hadn't touched a Windows development IDE in more than ten years, and I wanted
to keep the same code base for all three operating systems. Somewhere
during the past few years, I heard mention of MinGW (Minimalist GNU for
Windows). As I am familiar developing in a GNU/Linux environment, this
sounded like what I needed. To bring your Linux dev environment to Windows,
use <tt  >mingw-get-inst</tt>, and do a full installation. This will provide you with
the MinGW Shell, bundled with many standard GNU tools, including SSH. Next,
install TortoiseSVN, which is a Subversion client that integrates with
the Windows shell. Checkout and commit actions are accessed by right-clicking on folders in Explorer to keep files in sync. The MinGW shell
allows for changing drives' letters like a standard DOS shell with <tt  >cd
C:</tt>.
</p><p>
The next problem is how to build the code based on operating system. Let's 
look at two options: Makefiles and autotools. First, let's look at basic
Makefile-based builds and compare the differences by platform:


<pre     class="programlisting">
# Makefile.linux

all: 
        mkdir -p deps
        g++ -DHAVE_CONFIG_H -I. -I.. -g -O2 -D__LINUX_ALSASEQ__ 
        &#8618;-g -O2 -MT midiio.o -MD -MP -MF deps/RtMidi.Tpo 
        &#8618;-c -o RtMidi.o RtMidi.cpp
        g++ -DHAVE_CONFIG_H -I. -I.. -g -O2 -D__LINUX_ALSASEQ__ 
        &#8618;-g -O2 -MT -midiio.o -MD -MP -MF deps/midiio.TPO 
        &#8618;-c -o midiio.o midiio.cpp
        g++ -g -O2 -o midiio RtMidi.o midiio.o -lasound

# Makefile.mingw

all: 
        mkdir -p deps
        g++ -DHAVE_CONFIG_H -I. -I.. -g -O2 -D__WINDOWS_MM__ 
        &#8618;-g -O2 -MT RtMidi.o -MD -MP -MF deps/RtMidi.Tpo 
        &#8618;-c -o RtMidi.o RtMidi.cpp
        g++ -DHAVE_CONFIG_H -I. -I.. -g -O2 -D__WINDOWS_MM__ 
        &#8618;-g -O2 -MT -midiio.o -MD -MP -MF deps/midiio.TPO 
        &#8618;-c -o midiio.o midiio.cpp
        g++ -g -Wl,--enable-auto-import -O2 -o midiio RtMidi.o 
        &#8618;midiio.o -lwinmm 
</pre>
</p><p>

The library I used, rtmidi, requires that the platform be defined,
so for Linux, define <tt  >-D__LINUX_ALSASEQ__</tt>, and for Windows, define
<tt  >-D__WINDOWS__MM__</tt>. The last step in each is the linking phase, where you
specify system libraries to link to the binary. To enable a clean build
under Windows, I had to add
<tt  >-Wl,--enable-auto-import</tt>, so functions would
be auto-imported.
</p><p>
Now, let's look at autotools-based builds. Usually when an autotools-based build is committed to version control, only non-generated files are
committed, which includes configure.ac, Makefile.am and src/Makefile.am. The
standard practice is to create an autogen.sh script that will call the
files to generate configure, Makefile and other required files from *.ac
and *.am files:

<pre     class="programlisting">
# Autogen.sh
#!/bin/sh
aclocal
autoreconf
automake --add-missing --copy
autoreconf
libtoolize -f --automake
</pre>
</p><p>
configure.ac (Listing 1) contains host-based auto-detection and is where to
specify which host-based libraries to check for and link against.

</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x27eb580.0x2cddf98"></a></h2></div></div><div class="sidebar"><p class="title"><b>Listing 1. configure.ac</b></p><pre     class="programlisting">
#configure.ac
dnl - dnl represents a comment in automake config files
dnl here we specify the 
AC_INIT(midiio,0.1)
AM_INIT_AUTOMAKE(midiio, 0.1)
AC_PROG_CXX
AC_LANG_C
dnl Checks for programs.
AC_PROG_AWK
AC_PROG_CC

dnl Check for headers
AC_CHECK_HEADERS(unistd.h)

dnl Checks for typedefs, structures, and compiler characteristics.
AC_TYPE_SIZE_T

dnl Detect OS we're building on
dnl this next line is required to be able to read the host value
AC_CANONICAL_HOST
dnl Use the value here to add support for other operating systems
echo "Host Value: '${host}'"

case "${host}" in
	*-mingw32*)
		dnl specify Windows specific compiler flags 
                &#8618;and linker options
		compile_target=win
		CPPFLAGS="$CPPFLAGS -D__WINDOWS_MM__"
		LIBS="$LIBS -lwinmm"
	;;
	*linux-gnu)
		dnl specify Linux specific compiler flags 
                &#8618;and linker options
		compile_target=linux
		dnl Check for ALSA
		AC_CHECK_LIB(asound, snd_seq_event_output_direct,
                &#8618;alsalib=yes,alsalib=no)
		AC_CHECK_HEADERS(alsa/asoundlib.h,alsaheader=yes,
                &#8618;alsaheader=no)

		if test "$alsalib" = "yes"; then
			if test "$alsaheader" = "yes"; then
				LIBS="$LIBS -lasound"
			else
				AC_MSG_ERROR([** Coulnd't find ALSA 
                                &#8618;header file sys/asoundlib.h **])
			fi
		else
			AC_MSG_ERROR([** Couldn't find ALSA library 
                        &#8618;libasound. **])
		fi
		CPPFLAGS="$CPPFLAGS -D__LINUX_ALSASEQ__"
	;;
esac

AC_HEADER_STDC
AM_CONFIG_HEADER(config.h)
AC_OUTPUT(Makefile src/Makefile)

# Makefile.am

# Here we specify we have files in the source directory to process
AUTOMAKE_OPTIONS = foreign
SUBDIRS = src

# src/Makefile.am
# Here we define there are 2 programs we're compiling
bin_PROGRAMS = midiio midiout
# and here we define what we put together to make the final programs
midiout_SOURCES = midiout.cpp RtMidi.cpp
midiio_SOURCES = midiio.cpp RtMidi.cpp
</pre></div><p>
Full code for these examples can be downloaded from the game2midi project's
Subversion repository in the basic-midi-io-example folder.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x27eb580.0x2cde200"></a>Conclusion</h2></div></div><p>
Using GNU libraries and tools can help reduce the time and effort
required in supporting multiple platforms. I hope this article
encourages you to consider adding multiplatform support to a current
or future open-source project.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x27eb580.0x2cde308"></a></h2></div></div><div class="sidebar"><p class="title"><b>
Resources</b></p><p>
Official Midi Specification: <a href="http://www.midi.org/techspecs/midimessages.php" target="_self">www.midi.org/techspecs/midimessages.php</a>
</p><p>
Posts of Mustang Controller Dumps: <a href="http://www.rockband.com/forums/showthread.php?t=207792&amp;page=1" target="_self">www.rockband.com/forums/showthread.php?t=207792&amp;page=1</a>
</p><p>
Official RtMidi Home Page: <a href="http://www.music.mcgill.ca/~gary/rtmidi" target="_self">www.music.mcgill.ca/~gary/rtmidi</a>
</p><p>
MinGW: <a href="http://www.mingw.org" target="_self">www.mingw.org</a>
</p><p>
Mingw Download: <a href="http://sourceforge.net/projects/mingw/files/Automated%20MinGW%20Installer/mingw-get-inst/mingw-get-inst-20110316/mingw-get-inst-20110316.exe/download" target="_self">sourceforge.net/projects/mingw/files/Automated%20MinGW%20Installer/mingw-get-inst/mingw-get-inst-20110316/mingw-get-inst-20110316.exe/download</a>
</p><p>
TortiseSVN: <a href="http://tortoisesvn.tigris.org" target="_self">tortoisesvn.tigris.org</a>
</p><p>
game2midi Home Page: <a href="http://game2midi.sourceforge.net" target="_self">game2midi.sourceforge.net</a>
</p></div></div></div>
<div class="authorblurb"><p>
Nathanael Anderson has been a UNIX systems administrator for five
years. Family, coding and all things guitar keep him active. Feel free
to contact him on his blog at <a href="http://wirelessdreamer.com" target="_self">wirelessdreamer.com</a>.
</p></div>

  <div class="toclinks">
    <a class="link1" href="../tocindex.html">Archive Index</a>
    <a class="link2" href="../209/toc209.html">Issue Table of Contents</a>
    <a class="link3" href="../209/11005.html">Article</a>
  </div>
  <div class="bottomhrdiv">
  </div>
  
  <div id="bottom_search">
  <table class="page_search" summary="">
    <tr>
      <td valign="top" align="left">
        <p class="small_shutdown"><a href="/.exit">Shutdown Archive web server</a></p>
      </td>
      <td valign="top" align="right">
        <form method="get" action="/zoom/search.cgi">
          <input type="hidden" name="zoom_sort" value="0" />
          <input type="hidden" name="zoom_xml" value="0" />
          <input type="hidden" name="zoom_per_page" value="10" />
          <input type="hidden" name="zoom_and" value="1" />
          Search: <input type="text" name="zoom_query" size="20" value="" class="zoom_searchbox" />
          <input type="submit" value="Submit" />
        </form>
      </td>
    </tr>
  </table>
  </div>
  
  <div class="footerdiv">
    <a href="../../index.html">
      <img class="bottomimg" src="../../images/CD_FooterBanner.png" alt="LJ Archive"/>
    </a>
  </div>
  
  <div class="copyright">
    Copyright &copy; 1994 - 2018 <cite>Linux Journal</cite>.  All rights reserved.
  </div>
  </body></html>