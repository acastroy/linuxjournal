<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"><html><head><META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>
Build a Home Terabyte Backup System Using Linux</title><link rel="stylesheet" href="../css/archive.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.57.0"><meta name="description" content="&#10;Build a low-cost, terabyte-sized backup server using Linux and back up your digital audio files, digital images and digital movie recordings.&#10;"><link rel="stylesheet" href="../../css/archive.css" type="text/css"><script type="text/javascript" src="../../js/archive.js"></script><script type="text/javascript" src="../../js/highlight.js"></script></head><body onload="search_highlight();">
  <div class="headerdiv">
    <a href="../../index.html">
      <img class="topimg" src="../../images/CD_HeaderBanner.png" alt="LJ Archive"/>
    </a>
  </div>
  
  <div class="tophrdiv">
  </div>
  
  <div id="top_search">
  <table class="page_search" summary="">
    <tr>
      <td valign="top" align="left">
        <p class="small_shutdown"><a href="/.exit">Shutdown Archive web server</a></p>
      </td>
      <td valign="top" align="right">
        <form method="get" action="/zoom/search.cgi">
          <input type="hidden" name="zoom_sort" value="0" />
          <input type="hidden" name="zoom_xml" value="0" />
          <input type="hidden" name="zoom_per_page" value="10" />
          <input type="hidden" name="zoom_and" value="1" />
          Search: <input type="text" name="zoom_query" size="20" value="" class="zoom_searchbox" />
          <input type="submit" value="Submit" />
        </form>
      </td>
    </tr>
  </table>
  </div>
  <div class="article" lang="en"><div class="titlepage"><div><h1 class="title"><a name="N0x1806580.0x18fdab0"></a>
Build a Home Terabyte Backup System Using Linux</h1></div><div><div class="author"><h3 class="author">
Duncan
 
Napier
</h3></div><div class="issuemoyr">Issue #141, January 2006</div></div><div><p>
Build a low-cost, terabyte-sized backup server using Linux and back up your digital audio files, digital images and digital movie recordings.
</p></div></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x1806580.0x18fe298"></a></h2></div></div><p>
A terabyte-plus backup and storage system is now an affordable option for
Linux users. This article discusses options for building and configuring
an inexpensive, expandable, Linux-based backup server.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x1806580.0x18fe3a0"></a>
Server Design</h2></div></div><p>
High-capacity disk drives are now widely available at prices that are
incredibly cheap compared to those of only a few years ago. In addition, with
so many Linux users now ripping CDs to disk, saving images from their
digital cameras and recording video using digital camcorders and
DVRs, such as MythTV, the need for backing up and archiving large amounts
of data is becoming critical. Losing pictures and videos of your
kids&mdash;or your audio music library&mdash;because of a disk crash would be a
catastrophe. Fortunately, a high-capacity, Linux-based backup server
can be built easily and cheaply using inexpensive disk drives and free
software.
</p><p>
Virtually any home PC can meet the basic requirements for a backup
server. If you have long backup windows or relatively small amounts of
data, a slow computer is not an obstacle. Make sure your network is fast
enough to transfer data within your backup window. For older equipment,
the bottleneck for backups can be the disk data transfer bandwidth
(30-150Mbps depending on disk technology).
</p><p>
Many consumer-level computers do not have cooling capacity for more
than two internal hard disks. Most motherboards support a maximum of four
onboard disks (often four ATA/IDE devices, but the two ATA/IDE and two SATA
combination is becoming common). External USB high-capacity drives are
also available. If your computer is older and has USB1, purchase an
inexpensive USB2 PCI expansion card, which is ten times faster.
</p><p>
SCSI has fewer limitations, but it is expensive and has tended to lock
purchasers in to &ldquo;flavor-of-the-month&rdquo; SCSI technologies. One option
for disk expansion and upgrade is the Host Bus Adaptor (HBA), such as
those made by Promise Technology. An HBA is a disk controller on a PCI
expansion card. HBAs typically require no additional software, have
their own BIOS and are not constrained by PC BIOS limits on disk size. HBAs
let you put large disks (more than 120GB) into systems with legacy BIOSes,
upgrade from ATA-33 to ATA-150 or mix ATA and SATA disks.
</p><p>
You may want to consider purchasing a dedicated fileserver. A bare-bones
server capable of holding six disks (fully preassembled, no disks or OS)
can cost less than $1,500 US. With this initial investment, you can expand
disk space as needed for less than $0.80 per GB or grow by plugging in USB
disks. Once you have decided how many disks you need, consider their
space, cooling and noise requirements. Figure 1 shows an
example of a backup system build from an old server. The system
has well over a terabyte of storage capacity.
</p><div       class="mediaobject"><a href="8590f1.large.jpg"><img src="8590f1.jpg"></a><div class="caption"><p>
Figure 1. Storage array build from an old server (capacity of nine IDE disks,
including five in a converted SCSI RAID stack). Additional IDE spots added
with Promise HBA.
</p></div></div><p>
Even if you choose to build a server from scratch and populate it with
high-capacity disks, you can expect costs for your terabyte-plus backup
server still to be minimal in terms of its per-gigabyte price. This is
because storage costs have decreased so dramatically.
Table 1 provides a variety of different configurations for a backup
server, along with estimated prices per gigabyte for each (note: prices are
estimates and do not include taxes or shipping costs). As you can see
from the table, costs for a new server equipped with more than two terabytes
of storage can be built for a cost of less than $1.50 per gigabyte. That
will back up a lot of home movies, digital pictures and music files!
</p><div class="table"><a name="N0x1806580.0x18fe870"></a><p class="title"><b>
Table 1. Some Backup Options, with Estimated per-GB Costs
</b></p><table     summary="&#10;Table 1. Some Backup Options, with Estimated per-GB Costs&#10;" border="1"><colgroup><col><col><col><col></colgroup><thead><tr><th>Type</th><th>Configuration</th><th>Capacity (TB)</th><th>Cost per GB ($)</th></tr></thead><tbody><tr><td>
ATA/SATA Disk</td><td>Internal disk</td><td>0.4</td><td>0.56</td></tr><tr><td>Linux Desktop*</td><td>Three internal disks</td><td>1.2</td><td>0.84</td></tr><tr><td>Linux Desktop*</td><td>Three internal disks plus two USB external</td><td>2.0</td><td>0.73</td></tr><tr><td>
LaCie 2TB Storage</td><td>Network server appliance</td><td>2</td><td>1.15</td></tr><tr><td>Linux Server**</td><td>Six internal disks</td><td>2.4</td><td>1.21</td></tr><tr><td>Linux Server**</td><td>Six internal plus two USB external</td><td>3.2</td><td>1.08</td></tr></tbody></table></div><p>
*Intel Celeron D 478 325 2.53GHz, 256MB of RAM.
**Intel SC5275 chassis, Intel ATX Motherboard, dual-3GHz Xeon CPUs, 2GB of
RAM.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x1806580.0x18ff688"></a>
Building the Server and Adding Additional Disk Drives</h2></div></div><p>
During the past few years, I have built backup servers using Red Hat Linux
9, but you can use any flavor of Linux. I use Red Hat 9 because it is stable,
free, currently maintained (Fedora Legacy Project) and simple to
install and configure. If you buy a new computer, you may have to use a
more current version of Linux. I generally do not use RAID for low-budget
systems where cost is paramount, but it is worth considering.
</p><p>
Software requirements for a Linux backup server are minimal. Basic
network administration utilities (including the secure shell, SSH, and
secure shell daemon, sshd) and rsync are required. rsync is a fast,
incremental duplication/synchronization utility that comes with most
Linux distributions. With SSH and rsync, you can carry out virtually
all basic backup tasks. It is advantageous for a backup server also
to be a fileserver, so I install Samba, the SMB fileserver as well. I use
Samba because it is the default fileserver for MS Windows clients, and
it also is readily accessible by any UNIX system (including Mac OS X) using
a Samba client. If you have a homogenous UNIX network, you can use NFS,
which I will not discuss here.
</p><p>
If you need to attach additional disks to your server, begin by making
sure you have enough data (IDE/SATA/SCSI) cables and power lines
to accommodate the expansion. Ensure that your drive is Linux-compatible
(although most are). Turn off the power to your computer and disconnect
the power cable. Physically attach the disk(s) to your computer. Linux
should recognize the new disk(s) on boot. If your drive is not recognized,
your disk is incompatible or you need to locate and install a driver
for it. Check boot messages for new drives using the
<tt  >dmesg</tt> command. The
boot message for an IDE drive may look like this:

<pre     class="programlisting">
hdb: ST3400832A, ATA DISK drive
</pre>
</p><p>
All IDE/ATA (and some SATA) drives have the designation hdx, where the
x is replaced with a letter of the alphabet (b in this case). Similarly,
adding new USB or SCSI (and some SATA) disks gives boot messages
indicating a new drive designation sdx, where the x is replaced by the
appropriate letter.
</p><p>
Most Linux distributions come with a GUI disk manager. These disk managers
let you define and format partitions (I generally use one partition per
backup disk), assign mountpoints (for example, /data1, /data2) and mount the
partition. The process also can be done from the command line using
fdisk to create partitions.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x1806580.0x18ff9a0"></a></h2></div></div><div class="sidebar"><p class="title"><b>Creating New Partitions
</b></p><p>
To create new partitions on hdb (above), type:

<pre     class="programlisting">
fdisk /dev/hdb
</pre>
</p><p>
Type <tt  >m</tt> at the fdisk prompt for a help summary.
Typing <tt  >n</tt> at the prompt asks about the new partition we are creating:

<pre     class="programlisting">
Command action
   e   extended
   p   primary partition (1-4)
p
</pre>
</p><p>
For a single primary partition, type in <tt  >p</tt>:

<pre     class="programlisting">
Partition number (1-4):1
</pre>
</p><p>
You are then prompted for a partition number (type
<tt  >1</tt> for a single
partition). Next, set the partition size by determining the first and
last cylinder. Because we are using the whole disk, you should be able to
select the default values (the first and last cylinders):

<pre     class="programlisting">
First cylinder (1-48641, default 1):
Using default value 1
Last cylinder or +size or +sizeM or +sizeK (1-48641, default 48641):
Using default value 48641
</pre>
</p><p>
Type <tt  >w</tt> to write the partition table. You now have
a partition, /dev/hdb1,
that occupies the whole disk.
</p><p>
Next, format the partition in the filesystem of choice (mine is in the ext3
format) using the mkfs command:

<pre     class="programlisting">
mkfs -t ext3 /dev/hdb1
</pre>
</p><p>
Create a mountpoint for the new partition of your new disk (I'll call
it /data1):

<pre     class="programlisting">
mkdir /data1
</pre>
</p><p>
Mount the newly created ext3 partition:

<pre     class="programlisting">
mount -t ext3 /dev/hdb1 /data1
</pre>
</p><p>
And, test reading and writing. Finally, add a line in /etc/fstab, the mount table, to mount automatically during the boot process:

<pre     class="programlisting">
# Device                mountpoint       fstype   options      freq   pass_no
/dev/hdb1              /data1            ext3    defaults        1        2
</pre>
</p></div></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x1806580.0x18f6b20"></a>
Software Configuration&mdash;rsync and SSH</h2></div></div><p>
rsync is included in most Linux distributions. You need rsync
and SSH on both your backup client and server. Check to see whether rsync
installed by typing <tt  >rsync</tt> at the command prompt or check your list of
installed packages. If you cannot find a binary distribution for your
package, you can download the source code for rsync by following links
on the rsync home page (see the on-line Resources).
</p><p>
The simplest way to run rsync over a network is as a standalone
application using SSH for authentication. You can run rsync as a daemon
with more features, but you won't need to in this case. I illustrate
this here with a backup client named foo and a server named bar.
</p><p>
To replicate the directory /home on Linux machine foo with directory
/data1/foo of backup server bar from client foo using rsync and
SSH, type:

<pre     class="programlisting">
rsync -az  /home  -e ssh bob@bar:/data1/foo
</pre>
</p><p>
You will be prompted for user bob's password, and then the foo /home
directories are replicated to /data1/foo/home on bar (bob needs an
account on the server and write permission for /data1/foo).
</p><p>
To avoid having to type bob's password each time, create a private/public
key pair for SSH authentication without a password. This allows you
to automate the login process.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x1806580.0x18f6e38"></a></h2></div></div><div class="sidebar"><p class="title"><b>
Generating the Key Pair
</b></p><p>
On the machine you want to log in to (logged on as bob on bar in this
case), type
<tt  >ssh-keygen -d</tt>
to generate the key pair. Enter a password if the key will be
accessible/readable to other users. Otherwise, press Return. Change into
the .ssh directory and copy the public key to the allowed list:

<pre     class="programlisting">
cd ~/.ssh
cp id_dsa.pub authorized_keys2
</pre>
</p><p>
Copy the private key to the .ssh directory of the account on the machine
you will be logging in from (for example, root user on foo). Remove
the private key from bar (the machine you want to log on to):

<pre     class="programlisting">
scp id_dsa root@foo:~/.ssh/id_dsa
rm id_dsa
</pre>
</p><p>
On the machine you're logging in from, start the SSH agent, and add the
key to the agent's list (<tt  >ssh-add</tt> asks for a password if you typed
one in the first step above):

<pre     class="programlisting">
eval `ssh-agent`
ssh-add
</pre>
</p><p>
You can now log in to account bob bar from foo without a password:

<pre     class="programlisting">
ssh bob@foo
</pre>
</p></div><p>
You can run a script on foo to replicate foo on bar using
bob's account on bar. You should read the documentation for rsync,
which has numerous features (more than 70 command-line options). In
particular,
the -delete option can have disastrous consequences if misused. Listing
1 shows a seven-day incremental backup. Files altered or deleted on each
day of the week are deposited in directories named for the day (set by
-backup-dir). The most recent backup is stored in the directory current.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x1806580.0x18f7360"></a></h2></div></div><div class="sidebar"><p class="title"><b>
Listing 1. Full and Incremental rsync
</b></p><pre     class="programlisting">
#!/bin/sh

# This script does backups of foo to the backup server bar
# in a 7 day rotating incremental backup.
# Based on script by Andrew Tridgell

# directory to backup
BDIR=/home

# Remote directory on backup server
BACKUP_HOME=/data1/foo

# Backup login account on remote server
BACKUP_LOGIN=bob

# the name of the backup server
BSERVER=bar
BACKUPDIR=`date +%A`
OPTS="--force --ignore-errors --delete --backup
-backup-dir=$BACKUP_HOME/$BACKUPDIR -av"

export PATH=$PATH:/bin:/usr/bin:/usr/local/bin

# Dump output to backup file
date &gt; /var/log/backup.$BACKUPDIR.log

# the following line clears the last week's incremental directory
[ -d /tmp/emptydir ] || mkdir /tmp/emptydir
rsync --delete -a /tmp/emptydir/
BACKUP_LOGIN@$BSERVER:$BACKUP_HOME/$BACKUPDIR/
rmdir /tmp/emptydir


# now the actual transfer
rsync $OPTS $BDIR BACKUP_LOGIN@$BSERVER:$BACKUP_HOME/current &gt;&gt;
/var/log/backup.$BACKUPDIR.log
</pre></div><p>
If you prefer a compressed archive format, you still can run
<tt  >tar</tt> for a
full backup over the network:

<pre     class="programlisting">
tar cvfz - /home | ssh bob@bar dd of=/data1/foo/current.tar.gz
</pre>
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x1806580.0x18f7620"></a></h2></div></div><p>
and use the -newer option for an incremental tar backup.
</p><p>
rsync is more efficient than the tar command, because rsync copies only the
differences between the current and previous copy of the data.
</p><p>
You can get by with rsync and SSH on most platforms (including MS Windows),
but in reality, a fileserver setup is preferable, especially if you are
running MS Windows clients. For MS Windows machines, a Windows backup
application is preferable. The easiest way to do this is to run the
backup to write to a share on the Samba server.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x1806580.0x18f77d8"></a>
Software Configuration&mdash;Samba</h2></div></div><p>
If your Linux installation supports SMB file sharing, Samba is
probably installed. If not, binaries are included with virtually all
distributions. If this isn't the case with your distribution, or if you
prefer to use the very latest Samba version, download the source code
and compile and install. Official Samba distributions are available from
the Samba home page (see Resources). Refer to the documentation there for installing
and initially configuring Samba.
</p><p>
Once your backup server has Samba server installed, all Samba
configurations are made by editing the smb.conf file, which is usually
in /etc/samba/smb.conf or /usr/local/samba/lib/smb.conf. Graphical
configuration utilities like SWAT usually are included with Samba. See
your documentation for information about starting or stopping Samba. You
should configure your server to ensure that Samba starts when the server
initially boots up.
</p><p>
Following our backup example above, on server bar, set up a simple
smb.conf file or try appending the section below to the existing smb.conf
file to define a share called bob:

<pre     class="programlisting">
[bob]
   comment = foo backup account
   path = /data1/foo
   valid users = bob
   public = no
   writable = yes
</pre>
</p><p>
Next, add bob with any secure password as a Samba user (bob must have
a Linux account as well as permission to read/write the /data1/foo
directory):

<pre     class="programlisting">
smbpasswd -a bob
New SMB password: somepassword
Retype new SMB password: somepassword
Added user bob
</pre>
</p><p>
For MS Windows clients, map the share \\bar\bob as a network drive in
MS Windows using the user name bob and the SMB password for the bob
Samba account. You then should be able to run backups to the mapped
network drive. I typically use the free ntbackup software and set it up to
write .bkf files to network storage. ntbackup comes free with Windows 2000
and XP and can run automated, regularly scheduled backups from the Windows
client. Windows client-based backups have the advantage of backing
up the entire state of the system (including the Windows registry).
</p><p>
You also can use Samba to serve files to most UNIX or Mac OS X clients. The
smb client is installed by default in Mac OS X. In Linux distributions,
make sure that the smb client package is installed. The smb share should
be mounted onto the /backup mountpoint of machine foo:

<pre     class="programlisting">
mount -t smbfs -o username=bob,password=somepassword //bar/foo /backup
</pre>
</p><p>
To have the backup drive mount when the system boots, place a line such
as the following in /etc/fstab:

<pre     class="programlisting">
//bar/data1/foo            /backup                smbfs  rw,username=bob,password=somepassword  0 0
</pre>
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x1806580.0x18f7c50"></a>
Adding Off-Site Backup for Additional Security</h2></div></div><p>
To add an additional level of security, you may consider adding a
second server to your overall backup plans consisting of a server
that exists off-site, away from the home or office location where your
primary backup server is located. This allows you to mirror your backup
server to an off-site location once a week. That way, if you have a fire
or some other catastrophe at your primary location, your data still
will be available. Figure 2 shows a sample configuration
for this setup.
</p><div       class="mediaobject"><img src="8590f2.jpg"><div class="caption"><p>
Figure 2. Example backup scenario with client foo, backup server bar
and off-site mirror baroffsite.
</p></div></div><p>
Listing 2 is a basic script that mirrors the server bar with an
off-site mirror baroffsite using rsync. Always set up backups to run
automatically and on a regular schedule. Always keep logs of your backups,
and always check the backup logs.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x1806580.0x18f7f68"></a></h2></div></div><div class="sidebar"><p class="title"><b>
Listing 2. rsync Mirroring bar to baroffsite
</b></p><pre     class="programlisting">
#!/bin/sh

# Mirror /data1 on bar to /data1/bar on baroffsite.

#Backup directory on bar
BACKUP=/data1
#Backup directory on baroffsite
BACKUP_OFF=/data1/bar

# Give the day of week as name of backup
BACKUPNAME=`date +%A`

# Offsite server
BSERVER=baroffsite
# Backup account on backup server
BAC_ACC=backup

date &gt;  /var/log/backup.$BACKUPNAME.log

/usr/bin/rsync -avz --delete -e ssh $BACKUP $BAC_ACC@$BSERVER:$BACKUPOFF
&gt;&gt;  /var/log/backup.$BACKUPNAME.log

# Email the log to administrator

cat /var/log/backup.$BACKUPNAME.log | mail -s 'Mirror Check'
backup_guy@mycompany.com
</pre></div></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x1806580.0x18f8120"></a>
Monitoring Your Backup Server</h2></div></div><p>
In order to monitor your backup process and make sure your backups are
running as scheduled (and that your backup server hasn't run out of disk
space), it's important to put some automated monitoring
and reporting into place. Listing 3 is a simple script that
can be set up to run periodically via cron and send you a summary of the
backups that have occurred and how much disk space is remaining on each
of your partitions.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x1806580.0x18f8228"></a></h2></div></div><div class="sidebar"><p class="title"><b>
Listing 3. Simple Timestamp and Disk Space Lister
</b></p><pre     class="programlisting">
#!/bin/sh

# Check space on partitions
# List timestamps in chronological order

BACKUPS=/data1      #Identify directories to check
# Give the day of week as name of backup
BACKUPNAME=`date +%A`

#Timestamp
date &gt;  /var/log/backup.$BACKUPNAME.log
# Disk space on partitions
df -k &gt; /var/log/backup.$BACKUPNAME.log
echo ' ' &gt;&gt;  /var/log/backup.$BACKUPNAME.log

#List timestamps on backup server
# ls -lRt is much more verbose
ls -lt $BACKUPS/* &gt;&gt;  /var/log/backup.$BACKUPNAME.log

# Email the log to administrator

cat  /var/log/backup.$BACKUPNAME.log | mail -s 'Backup Check'
backup_guy@mycompany.com
</pre></div><p><span   class="bold"><b>Resources for this article:</b></span>
<a href="../141/8635.html" target="_self">/article/8635</a>.
</p></div></div>
<div class="authorblurb"><p>
Duncan Napier works as computer and instrumentation consultant in the
Vancouver area of British Columbia.
</p></div>

  <div class="toclinks">
    <a class="link1" href="../tocindex.html">Archive Index</a>
    <a class="link2" href="../141/toc141.html">Issue Table of Contents</a>
  </div>
  <div class="bottomhrdiv">
  </div>
  
  <div id="bottom_search">
  <table class="page_search" summary="">
    <tr>
      <td valign="top" align="left">
        <p class="small_shutdown"><a href="/.exit">Shutdown Archive web server</a></p>
      </td>
      <td valign="top" align="right">
        <form method="get" action="/zoom/search.cgi">
          <input type="hidden" name="zoom_sort" value="0" />
          <input type="hidden" name="zoom_xml" value="0" />
          <input type="hidden" name="zoom_per_page" value="10" />
          <input type="hidden" name="zoom_and" value="1" />
          Search: <input type="text" name="zoom_query" size="20" value="" class="zoom_searchbox" />
          <input type="submit" value="Submit" />
        </form>
      </td>
    </tr>
  </table>
  </div>
  
  <div class="footerdiv">
    <a href="../../index.html">
      <img class="bottomimg" src="../../images/CD_FooterBanner.png" alt="LJ Archive"/>
    </a>
  </div>
  
  <div class="copyright">
    Copyright &copy; 1994 - 2018 <cite>Linux Journal</cite>.  All rights reserved.
  </div>
  </body></html>