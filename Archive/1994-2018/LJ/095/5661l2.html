<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 3.2//EN">

<html>
<head>
  <title>Improving the Speed of PHP Web Scripts</title>
<link rel="stylesheet" href="../../css/archive.css" type="text/css" />
</head>

<body>
  <div class="headerdiv">
    <a href="../../index.html">
      <img class="topimg" src="../../images/CD_HeaderBanner.png" alt="LJ Archive"/>
    </a>
  </div>
  
  <div class="tophrdiv">
  </div>
  
  <div id="top_search">
  <table class="page_search" summary="">
    <tr>
      <td valign="top" align="left">
        <p class="small_shutdown"><a href="/.exit">Shutdown Archive web server</a></p>
      </td>
      <td valign="top" align="right">
        <form method="get" action="/zoom/search.cgi">
          <input type="hidden" name="zoom_sort" value="0" />
          <input type="hidden" name="zoom_xml" value="0" />
          <input type="hidden" name="zoom_per_page" value="10" />
          <input type="hidden" name="zoom_and" value="1" />
          Search: <input type="text" name="zoom_query" size="20" value="" class="zoom_searchbox" />
          <input type="submit" value="Submit" />
        </form>
      </td>
    </tr>
  </table>
  </div>
  
  <h4>Listing 2. Associating an Arbitrary Function with the Script Termination Event</h4>
  <pre>
&lt;?php
// path where cache files are stored
$CACHE_PATH="/tmp";

// cache time out in seconds
$CACHE_TIMEOUT=10;

// this script URL
$SCRIPT_URL="http://".$HTTP_HOST.$PHP_SELF;

// create cache file name based on
// the script name and the cache path
function cachefilename() {
global $PHP_SELF,$CACHE_PATH;

   return($CACHE_PATH."/".md5($PHP_SELF).".cache");
}

// check whether the script needs caching
function needscache($timeout) {
   clearstatcache();
   if (time()-filemtime(cachefilename())&gt;$timeout)
      return(true);
   else
      return(false);
}

// read cache file and send it to the browser
function outputcache() {
   readfile(cachefilename());
}

// cache the script
function docache($buffer) {

   // write the script output into
   // the cache file
   $fp=fopen(cachefilename(),"w");
   if ($fp)
      fputs($fp,$buffer);

   // send the script output to
   // the browser
   return($buffer);
}

// cache the script after it finishes
function doaftercache() {
global $SCRIPT_URL;

   // read the script output
   $fp=fopen($SCRIPT_URL,"r");
   while (!feof($fp))
      $buffer.=fgets($fp,4096);

   // write the script output into
   // the cache file
   $fp=fopen(cachefilename(),"w");
   if ($fp)
      fputs($fp,$buffer);
   fclose($fp);
}

if (needscache($CACHE_TIMEOUT)) {
   // the script needs caching
   if (file_exists(cachefilename())) {
      register_shutdown_function("doaftercache");
      outputcache();
      exit();
   } else
      ob_start("docache");
} else {
   // the script is cached so let's read
   // from the cache and exit
   outputcache();
   exit();
}
?&gt;
</pre>

  <div class="toclinks">
    <a class="link1" href="../tocindex.html">Archive Index</a>
    <a class="link2" href="../095/toc095.html">Issue Table of Contents</a>
    <a class="link3" href="../095/5661.html">Article</a>
  </div>
  <div class="bottomhrdiv">
  </div>
  
  <div id="bottom_search">
  <table class="page_search" summary="">
    <tr>
      <td valign="top" align="left">
        <p class="small_shutdown"><a href="/.exit">Shutdown Archive web server</a></p>
      </td>
      <td valign="top" align="right">
        <form method="get" action="/zoom/search.cgi">
          <input type="hidden" name="zoom_sort" value="0" />
          <input type="hidden" name="zoom_xml" value="0" />
          <input type="hidden" name="zoom_per_page" value="10" />
          <input type="hidden" name="zoom_and" value="1" />
          Search: <input type="text" name="zoom_query" size="20" value="" class="zoom_searchbox" />
          <input type="submit" value="Submit" />
        </form>
      </td>
    </tr>
  </table>
  </div>
  
  <div class="footerdiv">
    <a href="../../index.html">
      <img class="bottomimg" src="../../images/CD_FooterBanner.png" alt="LJ Archive"/>
    </a>
  </div>
  
  <div class="copyright">
    Copyright &copy; 1994 - 2018 <cite>Linux Journal</cite>.  All rights reserved.
  </div>
  </body>
</html>
<!--
## vim: tabstop=2: shiftwidth=2: expandtab:
## kate: tab-width 2; indent-width 2; replace-tabs true;
-->
