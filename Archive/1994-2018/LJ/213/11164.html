<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"><html><head><META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>
A Penetration Tester's Toolkit
</title><link rel="stylesheet" href="../css/archive.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.57.0"><meta name="description" content="&#10;Ever wonder exactly how vulnerable your network is? Using these tools&#10;can give you an idea and provide the means to protect yourself.&#10;"><link rel="stylesheet" href="../../css/archive.css" type="text/css"><script type="text/javascript" src="../../js/archive.js"></script><script type="text/javascript" src="../../js/highlight.js"></script></head><body onload="search_highlight();">
  <div class="headerdiv">
    <a href="../../index.html">
      <img class="topimg" src="../../images/CD_HeaderBanner.png" alt="LJ Archive"/>
    </a>
  </div>
  
  <div class="tophrdiv">
  </div>
  
  <div id="top_search">
  <table class="page_search" summary="">
    <tr>
      <td valign="top" align="left">
        <p class="small_shutdown"><a href="/.exit">Shutdown Archive web server</a></p>
      </td>
      <td valign="top" align="right">
        <form method="get" action="/zoom/search.cgi">
          <input type="hidden" name="zoom_sort" value="0" />
          <input type="hidden" name="zoom_xml" value="0" />
          <input type="hidden" name="zoom_per_page" value="10" />
          <input type="hidden" name="zoom_and" value="1" />
          Search: <input type="text" name="zoom_query" size="20" value="" class="zoom_searchbox" />
          <input type="submit" value="Submit" />
        </form>
      </td>
    </tr>
  </table>
  </div>
  <div class="article" lang="en"><div class="titlepage"><div><h1 class="title"><a name="N0x1026580.0x111dac0"></a>
A Penetration Tester's Toolkit
</h1></div><div><div class="author"><h3 class="author">
Matthew
 
Agle
</h3></div><div class="issuemoyr">Issue #213, January 2012</div></div><div><p>
Ever wonder exactly how vulnerable your network is? Using these tools
can give you an idea and provide the means to protect yourself.
</p></div></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x1026580.0x111e2a8"></a></h2></div></div><p>
I don't know about you, but during the years of my IT career, I've become
more and more concerned with security. I'm sure everyone has to a certain
degree, but for me, it has become a daily part of my job (not that I'm
complaining; on the contrary, it's quite exciting). As such, there
are a multitude of tools I've used to get said job done.
Some I like, and some I don't. But, I keep coming back to three in particular: 
Nmap, Nessus and Metasploit. 
</p><p>
In this article,
I introduce these three tools at a high level to give you an idea of
how to use them and what to use them for. I also provide some examples
from my own experiences to better explain how I use these tools (and
how you could possibly use them) in the real world.
</p><p>
Nmap is my go-to tool when beginning my investigations
on systems. Nmap has enjoyed quite a long life, starting back in 1997.
It's a scanning tool that allows you to perform various tasks, such as
remote scanning, fingerprinting, monitoring, inventory and other such
functions. It utilizes various techniques like packet manipulation
to get the answers to questions like the types of operating systems in use or the
version of Web serving software that's running on a target. It's great
information if you are to protect your network successfully.
</p><p>
The next tool in my bag is Metasploit. Metasploit has come a long way
since its creation in early 2003. Metasploit is a framework
for developing and testing vulnerabilities (these are its core functions;
its features seem almost limitless at times). It's a great tool for
testing server security (just be sure to use test servers,
because you never know when code could crash a box). 
</p><p>
Finally, the last
(but certainly not least) tool in my bag is Nessus. Nessus is a scanner
similar to Nmap and has been around almost as long (since 1998). However,
Nessus is capable of running vulnerability code against a machine like
Metasploit (whereas Metasploit can be used both to develop and run
exploitation code), but at a much simpler level. In fact, that's
Nessus' strong point; it's easy to use, like Nmap, and it has some of
the strengths of Metasploit. Depending on the situation, I may use one
or all of these tools, which brings me to a good point&mdash;duplication.
</p><p>
Redundant features aren't bad. For example, each one of these tools are capable of doing
basic scans. However, you will find that Nmap runs the fastest
and offers the least intrusive scanning method. These are the things to
consider when taking into account each of these tool's features and how to
best use them.
</p><p>
Regardless of the duplicating features in these tools, take the time to
learn each tool's individual features to find what works best for you.
You might discover that although Nmap is fast, you like the idea of scanning and
exploiting with Nessus (all in one step, if you will). You might like
the simplicity of Nessus but need the strength of Metasploit (for
scripting and grouping tests together). Even though they all get the job
done, it depends on your situation as to how you use these tools.
</p><p>
The first thing to do is install these tools. Because this article is in
<span   class="emphasis"><em>Linux Journal</em></span>, I assume you're running this on a Linux platform,
but all of these tools work on Windows as well.
You <span   class="emphasis"><em>could</em></span> install these tools from your repositories,
but I recommend going to each tool's Web site and installing from its
packages (this ensures that you get the latest version with all current fixes
and gives you the best success for installation). 
</p><p>
Installation is pretty
straightforward; just follow the steps from each tool's respective site,
and you'll be fine. As soon as the tools are installed, it's time
to start playing with them. I highly recommend that you have
either a virtual machine or a test machine of some sort as your first target,
so as not to crash anything critical. Nothing's worse than running
a scan against a box, only to find out that you crashed it by accident
(very high possibility with Nessus and Metasploit, depending on what
you are doing) and interrupted someone's work.
</p><p>
For the purpose of this article, I'm going to set up an example scenario.
I am going to use a virtual machine with Windows XP (SP3) loaded on it
to run these three tools against. This machine will be a fresh install
with no patches and the firewall disabled. The reason for this,
quite simply, is to be realistic when running these scans. More often
than not, I have come across this very machine, sitting in a corner,
collecting dust and running some sort of old-mission-critical app (I'm
sure you've encountered something similar). Especially in large
environments, these machines are very easy to forget about and can give
you the biggest amount of trouble. 
I have configured the host machine to use an IP of 192.168.56.1, and the
guest machine to use an IP of 192.168.56.101. 
</p><div       class="mediaobject"><a href="11164f1.large.jpg"><img src="11164f1.jpg"></a><div class="caption"><p>
Figure 1. Windows XP Machine
</p></div></div><div       class="mediaobject"><a href="11164f2.large.jpg"><img src="11164f2.jpg"></a><div class="caption"><p>
Figure 2. Scanning Machine
</p></div></div><p>
Let's start with Nmap to begin the information-gathering stage (you have to know what
you're working with) on your
target. Because you know the IP of the machine in question, you don't have to
but just as easily could run a scan against a subnet or some other subset
of IP addresses. For this article, let's stick with 192.168.56.101.
In your terminal, run the following (remember that you can run this
command as a regular user on the machine, as long as said user has access
to /usr/bin/):

<pre     class="programlisting">
nmap  -sV -A -v 192.168.56.101 &gt; /tmp/nmap-output 
</pre>
</p><p>
I always send the output to a file, as it's easier to read through
afterward. Before delving into the output, however, let's look at those
switches:
</p><div class="itemizedlist"><ul type="disc"><li><p>
<tt  >-sV</tt> &mdash; this tells Nmap the type of scan. In this case, it's a version scan
to see what programs are running on what ports (where available).
</p></li><li><p>
<tt  >-A</tt> &mdash; this tells Nmap to run a fingerprint check. This means Nmap
will attempt to identify the version of the OS and any related
information correctly.
</p></li><li><p>
<tt  >-v</tt> &mdash; verbosity&mdash;this is important, as you need this to
get critical
information from Nmap.
</p></li></ul></div></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x1026580.0x111f068"></a></h2></div></div><div class="sidebar"><p class="title"><b>Note:</b></p><p>
When it comes to tools like Nmap, man pages are your friend. Remember that
these tools are extremely complex and have a lot of functions, and that means
a lot of switches. When in doubt, always refer to the man pages, lest you
use the wrong switch and accidentally crash a box (easily done with tools like
Nessus).
</p></div><p>
Listing 1 shows the output of the previous command.

</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x1026580.0x111f328"></a></h2></div></div><div class="sidebar"><p class="title"><b>
Listing 1. Nmap Output</b></p><pre     class="programlisting">

Starting Nmap 5.50 ( http://nmap.org ) at 2011-11-07 15:45 EST
NSE: Loaded 57 scripts for scanning.
NSE: Script Pre-scanning.
NSE: Starting runlevel 1 (of 2) scan.
Initiating NSE at 15:45
Completed NSE at 15:45, 0.00s elapsed
NSE: Starting runlevel 2 (of 2) scan.
Initiating ARP Ping Scan at 15:45
Scanning 192.168.56.101 [1 port]
Completed ARP Ping Scan at 15:45, 0.00s elapsed (1 total hosts)
Initiating Parallel DNS resolution of 1 host. at 15:45
Completed Parallel DNS resolution of 1 host. at 15:45, 0.02s elapsed
Initiating SYN Stealth Scan at 15:45
Scanning 192.168.56.101 [1000 ports]
Discovered open port 139/tcp on 192.168.56.101
Discovered open port 445/tcp on 192.168.56.101
Discovered open port 135/tcp on 192.168.56.101
Completed SYN Stealth Scan at 15:46, 1.15s elapsed (1000 total ports)
Initiating Service scan at 15:46
Scanning 3 services on 192.168.56.101
Completed Service scan at 15:46, 6.01s elapsed (3 services on 1 host)
Initiating OS detection (try #1) against 192.168.56.101
NSE: Script scanning 192.168.56.101.
NSE: Starting runlevel 1 (of 2) scan.
Initiating NSE at 15:46
Completed NSE at 15:46, 0.15s elapsed
NSE: Starting runlevel 2 (of 2) scan.
Nmap scan report for 192.168.56.101
Host is up (0.00077s latency).
Not shown: 997 closed ports
PORT    STATE SERVICE      VERSION
135/tcp open  msrpc        Microsoft Windows RPC
139/tcp open  netbios-ssn
445/tcp open  microsoft-ds Microsoft Windows XP microsoft-ds
MAC Address: 08:00:27:5B:91:AC (Cadmus Computer Systems)
Device type: general purpose
Running: Microsoft Windows XP|2003
OS details: Microsoft Windows XP SP2 or SP3, or Windows Server 2003
Network Distance: 1 hop
TCP Sequence Prediction: Difficulty=245 (Good luck!)
IP ID Sequence Generation: Incremental
Service Info: OS: Windows

Host script results:
| nbstat: 
|   NetBIOS name: XPTESTVM, NetBIOS user: &lt;unknown&gt;, 
|   NetBIOS MAC: 08:00:27:5b:91:ac (Cadmus Computer Systems)
|   Names
|     XPTESTVM&lt;00&gt;         Flags: &lt;unique&gt;&lt;active&gt;
|     WORKGROUP&lt;00&gt;        Flags: &lt;group&gt;&lt;active&gt;
|     XPTESTVM&lt;20&gt;         Flags: &lt;unique&gt;&lt;active&gt;
|     WORKGROUP&lt;1e&gt;        Flags: &lt;group&gt;&lt;active&gt;
|     WORKGROUP&lt;1d&gt;        Flags: &lt;unique&gt;&lt;active&gt;
|_    \x01\x02__MSBROWSE__\x02&lt;01&gt;  Flags: &lt;group&gt;&lt;active&gt;
|_smbv2-enabled: Server doesn't support SMBv2 protocol
| smb-os-discovery: 
|   OS: Windows XP (Windows 2000 LAN Manager)
|   Name: WORKGROUP\XPTESTVM
|_  System time: 2011-11-07 15:46:06 UTC-5

TRACEROUTE
HOP RTT     ADDRESS
1   0.77 ms 192.168.56.101

NSE: Script Post-scanning.
NSE: Starting runlevel 1 (of 2) scan.
NSE: Starting runlevel 2 (of 2) scan.
Read data files from: /usr/share/nmap
OS and Service detection performed. Please report any incorrect 
results at http://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 9.34 seconds
           Raw packets sent: 1072 (47.866KB) | Rcvd: 1017 (41.234KB)

</pre></div><p>
As you can see from the output in Listing 1, you can identify that this is
indeed a Windows platform, most likely XP, with service pack 2 or 3 or 2003
server. This type of scan is a fingerprinting scan, which allows you to
identify the OS and any services worth testing as closely as
possible.
The fact that you can pull this much information from a very basic scan
alone indicates a low level of protection and a high level of
threat.
You easily can surmise that there is no local firewall, and that this box
hasn't gone through any hardening process. 
</p><p>
Although you could run many other
types of scans against this box to get more information,
you have enough here to continue. You could narrow down whether this
is a server through a process of elimination. For example, if
this is a desktop, the chances of it running a service like MS SQL or
Exchange are very minimal. That said, you have enough here to proceed
to the second tool, Nessus.
</p><p>
With Nessus, let's put
this box to the test to see just what hackers could do to this box if
they got access. Nessus now uses a Web interface, but you still
can use the command line if you prefer (remember to read the man pages). For
this article though, let's stick with the Web interface. Once you log in to the
Web GUI (note: it's a slick interface), click
on the scan link to begin configuring a scan.
</p><div       class="mediaobject"><a href="11164f3.large.jpg"><img src="11164f3.jpg"></a><div class="caption"><p>
Figure 3. Nessus Landing Page
</p></div></div><div       class="mediaobject"><a href="11164f4.large.jpg"><img src="11164f4.jpg"></a><div class="caption"><p>
Figure 4. Nessus Scan Page
</p></div></div><p>
Once you click add, configure your scan using these basic
settings (Figure 5). This will give you a quick scan with minimal
impact, which is key on an internal network. You don't want to disrupt
network traffic and bring on the wrath of your fellow admins and
network engineers.
</p><div       class="mediaobject"><a href="11164f5.large.jpg"><img src="11164f5.jpg"></a><div class="caption"><p>
Figure 5. Nessus Scan Configuration Page
</p></div></div><p>
Once it's complete, click on Reports and double-click your report to
open it.
</p><div       class="mediaobject"><a href="11164f6.large.jpg"><img src="11164f6.jpg"></a><div class="caption"><p>
Figure 6. Nessus Report on Test Box
</p></div></div><p>
Take a look at the report in detail by clicking on the IP in the report.
Here you will see a grid broken down by level of concern. As you can see,
this very basic vulnerability scan returned a lot of good information.
In particular, let's look at the RPC issue. Open that up and
take a look at the listing (Figure 7).
</p><div       class="mediaobject"><a href="11164f7.large.jpg"><img src="11164f7.jpg"></a><div class="caption"><p>
Figure 7. A Lot Going on Here for a Fresh Build
</p></div></div><p>
What you can take away from this is that RPC is a
service of concern and that Nessus by itself has an exploit against it.
The plugin ID tells you which plugin to use to test the exploit; the
name gives you some detail about the issue, and port and severity are self-explanatory. By clicking on the name, you pull up a window that provides
plenty of detail, including what versions are affected, patches
released to fix it and various other tidbits (Figure 8).
</p><div       class="mediaobject"><a href="11164f8.large.jpg"><img src="11164f8.jpg"></a><div class="caption"><p>
Figure 8. Detailed Results
</p></div></div><p>
This gives us plenty to work with, but 
let's make
sure that we really can exploit this and that there is, indeed, cause for concern.
You could do that with Nessus (give it a try!), but rather than relying solely on
Nessus, let's bring in the final tool, the heavy-hitter Metasploit.
</p><p>
Why use two different tools that can do the same job? Preference, mostly.
I
find that Metasploit is much better suited for exploits than
Nessus. That's not to
say Nessus doesn't get the job done, but Metasploit was built specifically for this
purpose. If nothing else, a third tool presents another compelling piece of
evidence to support your findings. It never hurts to have an extra set of
eyes.
</p><p>
Before going any further, I should say this: I have a ton of respect
for the power behind Metasploit. Be sure to read all the documentation before
<span   class="emphasis"><em>ever</em></span> attempting a run of Metasploit against a remotely used
box. Metasploit is a lot of fun, but kind of in the way that fireworks
are a lot of fun (obviously, accidents can happen if you're not careful).
</p><p>
Start by opening a terminal, <tt  >su</tt> to root (if you have given a regular
user access to the proper files/directories for Metasploit, it's
best to run as said user instead of root), and run the command
<tt  >msfconsole</tt>
(Figure 9).
</p><div       class="mediaobject"><a href="11164f9.large.jpg"><img src="11164f9.jpg"></a><div class="caption"><p>
Figure 9. Behold, Metasploit
</p></div></div><p>
Once you get a prompt back, the first thing to do is select
your exploit to test. To see all available exploits, type the following,
then go get a cup of coffee, because this takes a minute...or two:

<pre     class="programlisting">
show exploits
</pre>
</p><p>
Okay, for the purpose of this example, let's use the following
command (Figure 10 shows the results), which corresponds to the previous error shown
from Nessus (Figure 8): 

<pre     class="programlisting">
use exploit/windows/smb/ms08_067_netapi
</pre>
</p><div       class="mediaobject"><a href="11164f10.large.jpg"><img src="11164f10.jpg"></a><div class="caption"><p>
Figure 10. Exploits Listed and Exploit Selected
</p></div></div><p>
You could use another exploit, which simply would crash the box, but
let's try not to be too destructive. With your exploit selected, now
you need to choose a payload. A payload is the set of instructions to
send via the exploit to get the desired results. In this case, you want
to broadcast a message to the computer. First, list your payloads
by running the following:

<pre     class="programlisting">
show payloads
</pre>
</p><p>
Next, select the payload by using the following command:

<pre     class="programlisting">
set payload windows/speak_pwned 
</pre>
</p><div       class="mediaobject"><a href="11164f11.large.jpg"><img src="11164f11.jpg"></a><div class="caption"><p>
Figure 11. Payload Selected
</p></div></div><p>
Finally, show the options for this payload to see what
you need to append to this command to run the exploit. In this case,
you need to give it the IP of the box in question (which makes sense&mdash;Metasploit
is not a mind-reading tool). Listing 2 shows the output.

</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x1026580.0x1518ff0"></a></h2></div></div><div class="sidebar"><p class="title"><b>
Listing 2. Output of Exploit</b></p><pre     class="programlisting">
msf  exploit(ms08_067_netapi) &gt; set payload windows/speak_pwned 
payload =&gt; windows/speak_pwned
msf  exploit(ms08_067_netapi) &gt; show options

Module options (exploit/windows/smb/ms08_067_netapi):

Name     Current Setting  Required  Description
----     ---------------  --------  -----------
RHOST                     yes       The target address
RPORT    445              yes       Set the SMB service port
SMBPIPE  BROWSER          yes       Pipe name to use (BROWSER, SRVSVC)


Payload options (windows/speak_pwned):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Exploit target:

   Id  Name
   --  ----
   0   Automatic Targeting


msf  exploit(ms08_067_netapi) &gt; set RHOST 192.168.56.101
RHOST =&gt; 192.168.56.101
msf  exploit(ms08_067_netapi) &gt; exploit

[*] Automatically detecting the target...
[*] Fingerprint: Windows XP - Service Pack 3 - lang:English
[*] Selected Target: Windows XP SP3 English (AlwaysOn NX)
[*] Attempting to trigger the vulnerability...
[*] Exploit completed, but no session was created.
msf  exploit(ms08_067_netapi) &gt; 
</pre></div><p>
As you can see, the exploit completed. And, if you have sound on your
virtual machine, you will have heard something to the effect of &ldquo;pwnd&rdquo;.
If you take a look at the Windows machine, you will see that a service crashed
in this exploit&mdash;a rather typical side effect (Figure 12).
</p><div       class="mediaobject"><a href="11164f12.large.jpg"><img src="11164f12.jpg"></a><div class="caption"><p>
Figure 12. We broke the box.
</p></div></div><p>
You could try a few other exploits (actually quite a few),
but this gives you a good idea of how something simple like sending an
audible could cause an issue. Again, be careful, and always play on a
test box.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x1026580.0x15194c0"></a>Conclusion</h2></div></div><p>
As you can see,
these three tools, when used together, make for a powerful investigation
and the basis for a good report. Used wisely, these tools can help
defend your network against these very exploits. I often find myself
simply using Nmap to do random scans on my subnet for new computers,
Nessus to investigate further and find vulnerabilities, and Metasploit
to disable the device if necessary (it happens more than you think).
I also use these tools for generating reports, giving presentations
to management and keeping my network healthy in general. I learn
something new every time I run them, either about the tools themselves
or my network, thus keeping it interesting. Give the tools a try and
see what you think and enjoy!
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x1026580.0x15195c8"></a></h2></div></div><div class="sidebar"><p class="title"><b>
Resources</b></p><p>
Nmap: <a href="http://nmap.org" target="_self">nmap.org</a>
</p><p>
Metasploit: <a href="http://metasploit.com" target="_self">metasploit.com</a>
</p><p>
Nessus: <a href="http://www.nessus.org" target="_self">www.nessus.org</a>
</p></div></div></div>
<div class="authorblurb"><p>
Matthew Agle is a 30-year-old senior architect. When he's not focusing on
work, hacking, security, his blog or various other hobbies, he can be
found playing with his kids and generally annoying his wife. You can
reach him at <a href="mailto:matthew@impromptu-it.com">matthew@impromptu-it.com</a> or <a href="http://www.impromptu-it.com" target="_self">www.impromptu-it.com</a>.
</p></div>

  <div class="toclinks">
    <a class="link1" href="../tocindex.html">Archive Index</a>
    <a class="link2" href="../213/toc213.html">Issue Table of Contents</a>
    <a class="link3" href="../213/11164.html">Article</a>
  </div>
  <div class="bottomhrdiv">
  </div>
  
  <div id="bottom_search">
  <table class="page_search" summary="">
    <tr>
      <td valign="top" align="left">
        <p class="small_shutdown"><a href="/.exit">Shutdown Archive web server</a></p>
      </td>
      <td valign="top" align="right">
        <form method="get" action="/zoom/search.cgi">
          <input type="hidden" name="zoom_sort" value="0" />
          <input type="hidden" name="zoom_xml" value="0" />
          <input type="hidden" name="zoom_per_page" value="10" />
          <input type="hidden" name="zoom_and" value="1" />
          Search: <input type="text" name="zoom_query" size="20" value="" class="zoom_searchbox" />
          <input type="submit" value="Submit" />
        </form>
      </td>
    </tr>
  </table>
  </div>
  
  <div class="footerdiv">
    <a href="../../index.html">
      <img class="bottomimg" src="../../images/CD_FooterBanner.png" alt="LJ Archive"/>
    </a>
  </div>
  
  <div class="copyright">
    Copyright &copy; 1994 - 2018 <cite>Linux Journal</cite>.  All rights reserved.
  </div>
  </body></html>