<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"><html><head><META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>Smell of Fresh-Baked Kernels</title><link rel="stylesheet" href="../css/archive.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.57.0"><meta name="description" content="&#10;    With some tips from our French chef, and a glass of wine or two,&#10;    compiling is a manageable task.&#10;    "><meta name="keywords" content="kernel, dlkern, mirrors"><link rel="stylesheet" href="../../css/archive.css" type="text/css"><script type="text/javascript" src="../../js/archive.js"></script><script type="text/javascript" src="../../js/highlight.js"></script></head><body onload="search_highlight();">
  <div class="headerdiv">
    <a href="../../index.html">
      <img class="topimg" src="../../images/CD_HeaderBanner.png" alt="LJ Archive"/>
    </a>
  </div>
  
  <div class="tophrdiv">
  </div>
  
  <div id="top_search">
  <table class="page_search" summary="">
    <tr>
      <td valign="top" align="left">
        <p class="small_shutdown"><a href="/.exit">Shutdown Archive web server</a></p>
      </td>
      <td valign="top" align="right">
        <form method="get" action="/zoom/search.cgi">
          <input type="hidden" name="zoom_sort" value="0" />
          <input type="hidden" name="zoom_xml" value="0" />
          <input type="hidden" name="zoom_per_page" value="10" />
          <input type="hidden" name="zoom_and" value="1" />
          Search: <input type="text" name="zoom_query" size="20" value="" class="zoom_searchbox" />
          <input type="submit" value="Submit" />
        </form>
      </td>
    </tr>
  </table>
  </div>
  <div class="article" lang="en"><div class="titlepage"><div><h1 class="title"><a name="N0x1481580.0x1578ab0"></a>Smell of Fresh-Baked Kernels</h1></div><div><div class="author"><h3 class="author">Marcel Gagn&eacute;</h3></div><div class="issuemoyr">Issue #82, February 2001</div></div><div><p>
    With some tips from our French chef, and a glass of wine or two,
    compiling is a manageable task.
    </p></div></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x1481580.0x1579558"></a></h2></div></div><p> <span   class="emphasis"><em>Mon Dieu!
Fran&ccedil;ois!</em></span> Come out from under that table
<span   class="emphasis"><em>imm&eacute;diatement</em></span>! You are very lucky that
our customers have not yet arrived. To see you hiding from the
prospect of a kernel recompile. <span   class="emphasis"><em>Qu'est-ce que je vai
faire avec toi?</em></span> Sit down and let me pour you a glass of
wine to steady your nerves. There. Feeling better?
<span   class="emphasis"><em>Bien</em></span>.
</p><p>Log in and let me show you how easy it is. You know,
Fran&ccedil;ois, that I have been collecting from other open-source
chefs some wonderful recipes designed to make this whole kernel
process that much more attractive to the palate,
<span   class="emphasis"><em>non</em></span>? <span   class="emphasis"><em>Quoi</em></span>? <span   class="emphasis"><em>Ah,
mes amis</em></span>. Welcome! Fran&ccedil;ois, what are you doing
sitting there drinking? Show our guests to their seats. When you
are done, bring up the 1996 Meursault Genevrieres from the
cellar.</p><p><span   class="emphasis"><em>Pardon, mes amis</em></span>. Fran&ccedil;ois and I
were discussing the intricacies of Linux kernel builds. My faithful
waiter was about to build his first kernel and, I must tell you, he
is a little shy about the idea. It is for Fran&ccedil;ois and
others like him that I have sought out some of the items on
tonight's menu.</p><p>Building a kernel is not as much of an ordeal as it once was.
Part of the reason, I must admit, is that the
<span   class="emphasis"><em>need</em></span> to recompile your kernel is becoming less
and less of a requirement for the average user. Out of the box,
most modern distributions include support for more popular devices
either in the kernel or through a collection of compile loadable
modules. Still, there are times when the distributed kernel will
not support your hardware. You may also need specific features
that, while uncommon, are required in your environment.</p><p>This generally implies a requirement for the latest and
greatest Linux has to offer. If you want to know what the latest
version of the Linux kernel is, whether it is a stable release or a
development version, try out the following
<span   class="bold"><b>finger</b></span> command:</p><pre     class="programlisting">
finger @finger.kernel.org
</pre><p>A few seconds later, the system responds with something like
this:
<pre     class="programlisting">
[zeus.kernel.org]
The latest stable version of the Linux kernel is:
        2.2.17
The latest beta version of the Linux kernel is:
        2.4.0-test10
The latest prepatch (alpha) version *appears* to be:
        2.4.0-test11/pre5
</pre>


This assumes, of course, that you are
<span   class="emphasis"><em>currently</em></span> connected to the Internet. I see
that one of our diners is putting up their hands and mouthing the
word <span   class="emphasis"><em>always</em></span>. <span   class="emphasis"><em>Bravo, mon
ami</em></span>.
</p><p>Armed with the latest kernel information, you can now visit
your favorite kernel source mirrors and download what you need.
Notice that I said <span   class="emphasis"><em>mirrors</em></span>. Getting to your
local mirror is pretty simple. All you have to do is squeeze your
country code in between the &ldquo;ftp&rdquo; or &ldquo;www&rdquo; of kernel.org. For
instance, assume for a moment that I am in Canada (country code
&ldquo;ca&rdquo;). The addresses for the ftp and www sites would be as
follows:</p><pre     class="programlisting">
ftp.ca.kernel.org
www.ca.kernel.org
</pre><p>Similarly, if I were in France, I would use these mirrors:
<pre     class="programlisting">
ftp.fr.kernel.org
www.fr.kernel.org
</pre>


If you are unsure about any of these codes, visit
<a href="http://www.kernel.org/pub/mirrors" target="_self">www.kernel.org/pub/mirrors</a>
for a complete list.
</p><p>Staying on top of all this can be a chore as well. You may
have to follow kernel development quite closely (perhaps daily).
Pretend for a moment that you have a new card that lets you input
commands directly into your system via thought transmissions
(<span   class="emphasis"><em>Incroyable!</em></span>) and kernel support is currently
in development. Whatever your reasons, <span   class="emphasis"><em>Darxus</em></span>
provides you with a nice little Perl script to help you out. It is
called <span   class="bold"><b>dlkern</b></span> and is available
from his web site (see Resources). With dlkern, you simply tell the
script whether you want the stable version of the kernel (-s
option), the development or beta version (-b option), or the
pre-patch alpha version (-p option). That is all. Allow me to
demonstrate. In the next example, I retrieve the latest stable
kernel:</p><pre     class="programlisting">
./dlkern -s -w
</pre><p>You'll notice that I used a -w option as well. This tells
dlkern to use <span   class="bold"><b>wget</b></span> as the means of
downloading my new kernel. The default is
<span   class="bold"><b>ncftpget</b></span>. One or both of these
programs is likely already on your system or included in your
distribution. One quick note here; make sure you change the
permissions on the script to executable (<b  >chmod 755
dlkern[</b>). If you are indeed following the development of
a specific driver, one option is to put dlkern into a crontab entry
where the download can happen automatically (during the night or
whenever makes sense).
</p><p>So, now we have chosen and downloaded our kernel source
distribution. The next step, of course, is to build the kernel. I
realize that there are many documents explaining the steps to
kernel compilations (other writers in this fine publication have
and will, no doubt, cover it in the future). Nevertheless, to truly
appreciate the work of our next chef, we should review the process
briefly.</p><p>With source in hand, it is time to uncompress and extract
that source. The usual and preferred location tends to be /usr/src.
Kernels direct from any of the kernel.org mirrors tend to extract
into a hierarchy called &ldquo;Linux&rdquo;. This would mean that your kernel
sources lived in /usr/src/linux. However, you may find that
/usr/src/linux is actually a symbolic link to where the actual
kernel source lives. For instance, if I do an <b  >ls
-l</b> on one of my servers, I get something that looks like
this:</p><pre     class="programlisting">
# cd /usr/src
# ls -l linux
lrwxrwxrwx  1  1  root  11 Nov 14 1999 linux -&gt; linux-2.2.5
</pre><p>Notice that it points to a directory called &ldquo;linux-2.2.5&rdquo;.
If you want to extract directly from the source, start by renaming
the link to something else, then extract the kernel. The tree will
be called &ldquo;Linux&rdquo;. Now, change directory to the linux directory
and type <b  >make config</b>. Even before you type that
command, I should tell you that this is the old, one might even
say, <span   class="emphasis"><em>classic</em></span>, way of doing things. You will
get a line-by-line question and answer session designed to help you
through the configuration process for your new kernel. If you type
<b  >make menuconfig</b>, you will get a ncurses-based
screen that is a bit friendlier, what you might call a GUI for the
console set, <span   class="emphasis"><em>non</em></span>? The last option is
<b  >make xconfig</b>, which uses an X environment for
building.
</p><p>As I mentioned, this is the question and answer session. You
decide what you want in your kernel by answering &ldquo;Y&rdquo; for yes,
&ldquo;N&rdquo; for no and &ldquo;M&rdquo; for module. At any point in the process, you
can ask for help if you don't know what a specific thing does. The
kernel make process is pretty good at leading and helping out
through this. If it tells you that you should include it, then do
so.</p><p>Once this is done, you can actually go back and make some
modifications if you want to double-check. In the /usr/src/linux
directory, you will find a file called .config. Using
<span   class="bold"><b>pico</b></span>,
<span   class="bold"><b>vi</b></span> or whatever editor makes you
happy, you can still make changes. Listing 1 is a sample of the
.config file from a recent build.</p><p><a href="4470l1.html" target="_self">Listing 1. Sample config
File</a></p><p>The next step is to do a <b  >make depend</b>
(which handles all the dependencies and creates your Makefiles),
followed by a <b  >make clean</b>. If this is your first
build, you will see messages claiming to be cleaning up and
deleting files that aren't really there. Now, it's time to actually
compile your kernel. You do this by executing <b  >make
bzImage</b>. This next step may take a while, depending on
how fast your computer is, so consider sitting down with a nice
Beaujolais while you wait. When all is done, you'll find your new
kernel in the directory /usr/src/linux/arch/i386/boot. It is, as
you might expect, called bzImage since that is what we told the
system to make, <span   class="emphasis"><em>non</em></span>? Now, you want to include
your new kernel image in LILO's list of bootable kernels. For this
example, I built the 2.2.17 kernel directly from source. Once that
was done, I used my vi editor to modify my /etc/lilo.conf file.
Listing 2 shows what it looked like before I started.</p><p><a href="4470l2.html" target="_self">Listing 2. /ect/lilo.conf
File</a></p><p>You'll notice that I did not change anything else in this
example. My default boot is still
<b  >vmlinuz-2.2.14-5.0</b>, which is the stock kernel
that came with my system. The lines that start with
<b  >image=/boot/vmlinuz-2.2.17</b> are the ones I added
after the fact. I am now going to have my Linux system reread the
configuration file by running this command:</p><pre     class="programlisting">
/sbin/lilo
</pre><p>After LILO has worked its way through your /etc/lilo.conf
file, it should come back with something like this:
<pre     class="programlisting">
Added linux *
Added linux-2.2.17
</pre>


Here is a quick tip from the kitchen, <span   class="emphasis"><em>mes
amis</em></span>. From time to time, I have been known to say that
too much garlic in a Caesar salad is impossible. I joke, but you
understand, <span   class="emphasis"><em>non</em></span>? I tell you this so that you
will better understand the following statement.
</p><p>You can never run <b  >/sbin/lilo</b> too many
times, but you can run it too few. If you have made changes to your
kernel or your /etc/lilo.conf file and you forget to run
<b  >/sbin/lilo</b>, <span   class="bold"><b>your system
will not boot</b></span>. This is extremely important. If you are
not sure whether you have run LILO, then run it again. Sometimes, I
run it two or three times just to make sure. I joke, but only a
bit, <span   class="emphasis"><em>non</em></span>?</p><p>We have only a couple of things left to do. Since you have,
no doubt, defined several modules to include with your new kernel,
you need to make them as well. You do this with the <b  >make
modules</b> command which you then follow up with
<b  >make modules_install</b>.</p><p>There you have it. All in all, it's not that the whole
process is so complicated. It's just that there are quite a few
things to remember, and forgetting that all-important LILO step can
cost you a great deal of aggravation (not to mention that it could
put a real dent in your wine cellar).</p><p>No matter what, building a kernel, for many (including
Fran&ccedil;ois), is a daunting experience. This is where
<span   class="bold"><b>buildkernel</b></span> comes into play.
Written by William Stearns, this is a wonderful little (big) bourne
shell script that pretty much automates the entire process. If you
have local kernel source, it will use that, otherwise, buildkernel
will download the latest stable kernel for you. You can, if you
wish, ask the software to get the latest development version
instead. It then extracts it, creates the appropriate links and
starts the configuration process by launching <b  >make
xconfig</b>. Once you have decided what you want, your job is
pretty much done.</p><p>Sometime after building the kernel modules, buildkernel will
interrupt you and ask you to verify its changes to /etc/lilo.conf.
It does this by putting you into your default editor and allowing
you to make changes. Here's what it looks like at this point. This
is not the whole file, but simply the changes added by
buildkernel:</p><pre     class="programlisting">
#The following boot section was added by
#buildkernel on Wed Nov 8 13:06:21 EST 2000
#Please feel free to move this section, edit it
#and remove these comments.
image=/boot/bzImage-2.2.17-1
        label=2.2.17-1
        root=/dev/hda1
        read-only
#End of autoinstall
</pre><p>Once you are happy with this, exit the editor and let the
program continue. It will complete the installation of your new
kernel, run LILO and that will be that. No need to worry about
whether you forgot some steps. <span   class="emphasis"><em>Oui</em></span>, it is
true. Despite my assurances that I personally watched as
buildkernel ran LILO, I still ran it again.
</p><p>When you look at the resultant
<b  >/etc/lilo.conf</b> file, notice that the default
boot configuration is your old kernel&mdash;buildkernel has left that
intact. <span   class="emphasis"><em>Merci</em></span>. Now, to book your new kernel,
simply shut down your system and type (in the case of my example
above) <b  >2.2.17-1</b> at the LILO prompt.</p><p>There are some parameters that you may be wise to pre-set.
These are in a control (or config) file called /etc/bkrc, and they
allow you to select defaults such as your local mirror download
site (BKFTPSITE), the type of image (BKBUILDTYPE), or whether you
want to use the stable or development kernels
(BKKERNELTOBUILD).</p><p>It seems that closing time has arrived very quickly.
<span   class="emphasis"><em>Mon Dieu</em></span>! Once again, I want to thank you all
for visiting my restaurant. Fran&ccedil;ois, please, another glass
of wine for our friends. As you can see, working with the Linux
kernel need not be a frightening experience. With a little help
from dedicated open-source chefs around the world, anybody can
sample the Linux kernel up close and personal. Even
Fran&ccedil;ois.</p><p>Until next time, your table will always be waiting here at
<span   class="emphasis"><em>Chez Marcel</em></span>.</p><p>&Acirc; v&ocirc;tre sant&eacute;! Bon app&eacute;tit!</p><p><a href="4470s1.html" target="_self">Resources</a></p></div></div>
<div class="authorblurb"><p>
        <div       class="mediaobject"><img src="4470aa.jpg"></div>

        <span   class="bold"><b>Marcel
      Gag&eacute;</b></span> lives in Mississauga, Ontario. In real life,
      he is president of Salmar Consulting Inc., a systems integration
      and network consulting firm. He is also a pilot, writes science
      fiction and fantasy, and edits TransVersions, a science fiction,
      fantasy and horror magazine (now an anthology). He loves Linux and
      all flavors of UNIX and will even admit it in public. In fact, he
      has just finished writing <span   class="emphasis"><em>Linux System Administration: A
      User's Guide</em></span>, coming soon from Addison-Wesley Longman.
      He can be reached via e-mail at mggagne@salmar.com. You can
      discover a lot of other things from his web site at
      <a href="http://www.salmar.com/marcel" target="_self">http://www.salmar.com/marcel/</a>.</p></div>

  <div class="toclinks">
    <a class="link1" href="../tocindex.html">Archive Index</a>
    <a class="link2" href="../082/toc082.html">Issue Table of Contents</a>
  </div>
  <div class="bottomhrdiv">
  </div>
  
  <div id="bottom_search">
  <table class="page_search" summary="">
    <tr>
      <td valign="top" align="left">
        <p class="small_shutdown"><a href="/.exit">Shutdown Archive web server</a></p>
      </td>
      <td valign="top" align="right">
        <form method="get" action="/zoom/search.cgi">
          <input type="hidden" name="zoom_sort" value="0" />
          <input type="hidden" name="zoom_xml" value="0" />
          <input type="hidden" name="zoom_per_page" value="10" />
          <input type="hidden" name="zoom_and" value="1" />
          Search: <input type="text" name="zoom_query" size="20" value="" class="zoom_searchbox" />
          <input type="submit" value="Submit" />
        </form>
      </td>
    </tr>
  </table>
  </div>
  
  <div class="footerdiv">
    <a href="../../index.html">
      <img class="bottomimg" src="../../images/CD_FooterBanner.png" alt="LJ Archive"/>
    </a>
  </div>
  
  <div class="copyright">
    Copyright &copy; 1994 - 2018 <cite>Linux Journal</cite>.  All rights reserved.
  </div>
  </body></html>