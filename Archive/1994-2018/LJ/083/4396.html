<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"><html><head><META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>Maragda: Running Linux from CD</title><link rel="stylesheet" href="../css/archive.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.57.0"><meta name="description" content="&#10;    An overview of one man's DIY adventure in putting Linux on a&#10;    bootable CD-ROM.&#10;    "><meta name="keywords" content="Maragda, education, CD-ROM, boot, installation"><link rel="stylesheet" href="../../css/archive.css" type="text/css"><script type="text/javascript" src="../../js/archive.js"></script><script type="text/javascript" src="../../js/highlight.js"></script></head><body onload="search_highlight();">
  <div class="headerdiv">
    <a href="../../index.html">
      <img class="topimg" src="../../images/CD_HeaderBanner.png" alt="LJ Archive"/>
    </a>
  </div>
  
  <div class="tophrdiv">
  </div>
  
  <div id="top_search">
  <table class="page_search" summary="">
    <tr>
      <td valign="top" align="left">
        <p class="small_shutdown"><a href="/.exit">Shutdown Archive web server</a></p>
      </td>
      <td valign="top" align="right">
        <form method="get" action="/zoom/search.cgi">
          <input type="hidden" name="zoom_sort" value="0" />
          <input type="hidden" name="zoom_xml" value="0" />
          <input type="hidden" name="zoom_per_page" value="10" />
          <input type="hidden" name="zoom_and" value="1" />
          Search: <input type="text" name="zoom_query" size="20" value="" class="zoom_searchbox" />
          <input type="submit" value="Submit" />
        </form>
      </td>
    </tr>
  </table>
  </div>
  <div class="article" lang="en"><div class="titlepage"><div><h1 class="title"><a name="N0x176d580.0x1864ab0"></a>Maragda: Running Linux from CD</h1></div><div><div class="author"><h3 class="author">Jordi Bataller</h3></div><div class="issuemoyr">Issue #83, March 2001</div></div><div><p>
    An overview of one man's DIY adventure in putting Linux on a
    bootable CD-ROM.
    </p></div></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x176d580.0x1865558"></a></h2></div></div><p>The project described here is further
proof that Linux is a powerful and versatile system.
</p><p>My college has several trolleys that carry a computer (PC)
and a VCR, and both are connected to a video projector. They have
so many users that it's difficult to keep them working properly.
This is especially true in the case of the computer; you can't ever
be sure what software you will find on the hard disk.</p><p>I decided to use the projectors in the introductory
programming course to show my students source C programs and how to
run them step-by-step. I, of course, wanted to use Linux and its
programming tools so that my students learn that Windows is not the
only choice.</p><p>In this situation, I came to the conclusion that I needed
some sort of portable Linux system, and I didn't want to use my
notebook in the classroom.</p><p>My first idea was to try installing Linux on an Iomega Zip
250MB drive for parallel ports. After a few days of work I achieved
it. It needs a floppy to boot the system, and the run speed is not
too bad. Then I repeated the task, this time installing Linux on an
IDE hard disk contained in the IDE box adapter for parallel ports.
This configuration removes the limitation of 250MB disk space and
speeds up the running of Linux.</p><p>From the lessons learned from these tasks, I asked myself,
why not run Linux from a CD-ROM? That would be convenient and
easier to use. In addition, students could use it to start learning
Linux without having to install it on their computers. And so
Maragda was born.</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x176d580.0x1865818"></a>How to Use Maragda</h2></div></div><p>The final product is a bootable CD-ROM, so you must configure
your BIOS to boot from the CD drive. If your BIOS doesn't support
this, there is a solution: a bootable floppy that will also boot
Linux from the CD. In fact, a raw image of the floppy is what the
CD contains to boot itself.</p><p>The Linux software on the CD is installed from the Red Hat
6.2 distribution, and I prepared two arrangements. The first one is
a full installation. It contains the base system, printer support,
the X Window System, the VGA16 and framebuffer X servers, GNOME (or
you can edit .xinitrc and uncomment the line for the window manager
you like the most), network server workstation, authoring and
publishing tools (LaTeX, etc.),
<span   class="bold"><b>Emacs</b></span>, development tools
(<span   class="bold"><b>make</b></span>,
<span   class="bold"><b>egcs</b></span>, etc.), DOS/Windows
connectivity, mail, WWW and news tools, and other packages such as
<span   class="bold"><b>rhide</b></span>, ssh support and the JDK
1.2.</p><p>The second arrangement, which I call Maragda Teaching, is
only equipped with part of the packages of the base system and X
(to use <span   class="bold"><b>fvwm2</b></span>), with the complete
development tools and other tools such as
<span   class="bold"><b>gv</b></span> and rhide.</p><p>Full Maragda requires at least 64MB of RAM, while Maragda
Teaching (and its tools) runs with only 32MB. There's a second
arrangement of full Maragda that runs with 32MB but does not
include room for tools such as Emacs or Netscape, which require
more memory.</p><p>In both cases, the same kernel is used. It is version 2.2.14,
and it supports (among other things) the network, the framebuffer
device, the loop-back device, RAM disk and initial RAM disk.</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x176d580.0x1865c90"></a>Configuration</h2></div></div><p>One of the problems of any system intended for portability is
how to adapt to different hardware. At the very least, the mouse
and video (X) must be configured, and then the passwords, network
identity and others. In the case of Maragda, it should be
remembered that no change survives one session because the files on
the CD are read-only.</p><p>Full Maragda is configured by default to support a PS2 mouse
and the framebuffer device for video with a depth of 32. Network
uses the driver 3c59x (a 3Com card) with identity
maragda.gnd.upv.es (192.168.0.1).</p><p>However, full Maragda has an open door that allows you to
decide on the configuration yourself. Just after the main file
systems are mounted, the boot process stops and asks for an ext2
formatted floppy. Every file on the floppy will be merged into the
system before the programs and d&lt;\#230&gt;mons are
started.</p><p>Which files should be on the floppy? Consider the following
list as a guide:</p><p>/etc/passwd/etc/shadow/etc/hosts/etc/hosts.allow/etc/hosts.deny/etc/resolv.conf/etc/HOSTNAME/etc/sysconfig/network-scripts/ifcfg-eth0/etc/sysconfig/network/etc/X11/XF86Config/etc/X11/X/etc/conf.modules</p><p>If you know nothing about these files or other configuration
files, there is still hope for you. You must continue the boot and
log in as root (I hope this will always be possible). The CD will
be mounted in /mnt/cdrom. In /mnt/cdrom/system/config-touch you
will find two scripts. Running
<span   class="bold"><b>Touch_all</b></span> will touch all the files
in the system. Then run the configuration tool you need (setup,
xconfigurator or control-panel in X). Finally, run
<span   class="bold"><b>Find_newer</b></span>. It will find the files
updated by the configuration, and it will copy them to a directory
named config in the current directory. Put the files on a floppy
and you are done.</p><p>The configuration of Maragda Teaching is restricted. It does
not ask for a floppy, and prompts you to choose one of four
configurations already on the system:</p><div class="orderedlist"><ol type="1"><li><p>PS2 mouse and frame buffer</p></li><li><p>serial mouse and frame buffer</p></li><li><p>PS2 mouse and vga</p></li><li><p>serial mouse and vga</p></li></ol></div><p>In future versions of Maragda, I plan to detect the
environment where Maragda is booting and auto configure it.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x176d580.0x18663c8"></a>How to Build Maragda</h2></div></div><p>There are three things to do:</p><div class="orderedlist"><ol type="1"><li><p>Prepare a software installation containing all the
packages you want on Maragda; we'll call it source
installation.</p></li><li><p>Distribute the source installation between two big
files, ROOT.FS and WHOLE.FS; they both should fit inside an ext2
file system.</p></li><li><p>Develop a boot mechanism in charge of detecting the
CD-ROM drive and locating ROOT.FS on it. Then, it should load
ROOT.FS as a RAM disk, preparing it to be the root file system, and
finally it should leave the boot process to continue on the root
file system.</p></li></ol></div><p>All the necessary pieces that do the work (mainly shell
scripts) are arranged into two working directories:
<div class="orderedlist"><ol type="1"><li><p>boot: in charge of developing the boot
mechanism</p></li><li><p>system: contains the tools to create ROOT.FS and
WHOLE.FS from the source installation</p></li></ol></div>

You can find those directories on the CD (along with the doc
directory). They are a copy of my own working directories, and on
them you will find all that is needed to build Maragda. You must
copy them to a disk with at least 1GB of free space.
</p><p>I should mention that, perhaps, some device files (files
under /dev) might not be correct due to the copy from an ext2 file
system to a CD file system (iso9660). In this case, you should
replace those files by the corresponding /dev files from your
system.</p><p>Now, let's outline the relevant steps in the building process
and describe the purpose of each shell script as well as the main
configuration files. Minor details are left out of the explanation;
if you decide to build your own Maragda-like system, you should
consult doc/developer.html on the CD and carefully read each shell
script on the working directories.</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x176d580.0x18669f8"></a>Boot</h2></div></div><p>Figure 1 shows the main steps to be taken in the boot
process.</p><div       class="mediaobject"><a href="4396f1.large.jpg"><img src="4396f1.jpg"></a><div class="caption"><p>
Figure 1. Main Steps of Boot Process
</p></div></div><p>The target here is to create a bootable floppy disk that will
be merged into the CD to make it bootable.</p><p>The boot loader for setting up the floppy is
<span   class="bold"><b>syslinux</b></span>. It can boot a Linux
system from a DOS-formatted floppy containing a kernel and an
initial RAM disk file (compressed) with the root file system
inside.</p><p>So, we'll need a kernel along with its loadable modules.
(Only the kernel is required now.) I will not explain here how to
compile a kernel but will only remark that it should support</p><div class="itemizedlist"><ul type="disc"><li><p>framebuffer device</p></li><li><p>CD-ROM (iso9660 file system)</p></li><li><p>initial RAM disk</p></li><li><p>loop-back device</p></li></ul></div><p>(You can find my kernel configuration on doc/developer.html.)
</p><p>Now we have to build the initial RAM disk (initrd) holding
the root file system for the first-stage boot. The easiest way to
obtain one is to borrow it from a floppy rescue disk. But, I follow
the &ldquo;do it yourself&rdquo; philosophy. The directory boot/initrd is a
skeleton of the contents of my RAM disk. The script named
<span   class="bold"><b>Init_initrd</b></span> fills that directory
from scratch, copying files from the source installation. It
creates directories, copies a subset of dev-files onto initrd/dev
and populates initrd/bin. The size of an initrd must be kept small,
so you should leave only the essential binaries on initrd/bin. Then
you must run <span   class="bold"><b>Cp_lib</b></span>; it will copy
the libraries on initrd/lib for the binaries you left
before.</p><p>When you are finished, run
<span   class="bold"><b>Make_initrd_fs_gz</b></span>. It will create
a file (Minix formated), copying to it the files on boot/initrd and
then compress it.</p><p>Now you have a kernel and an initial RAM disk. Next, you
should generate the bootable floppy with syslinux. The syslinux
configuration file, SYSLINUX.CFG, is contained in
boot/syslinux_boot_floppy-20MB. The line:</p><pre     class="programlisting">
append initrd=initrd.gz ramdisk_size=20480 vga=0x315
</pre><p>instructs the boot loader to load the initial RAM disk file
on the floppy and passes two parameters to the kernel to inform it
of the size of the RAM disk and the framebuffer video mode. The RAM
disk size should be customized to the size of the ROOT.FS used.
</p><p>Finally, the bootable floppy is created by the
<span   class="bold"><b>Write_syslinux_boot_floppy</b></span> script.
It will also extract a raw image of the floppy to be merged onto
the CD.</p><p>The most relevant file here is boot/initrd/linuxrc (/linuxrc
on the initial RAM disk) because this script is executed at boot
up. It performs the main tasks intended for this stage:</p><div class="itemizedlist"><ul type="disc"><li><p>It searches for the device holding the
files:</p></li></ul></div><pre     class="programlisting">
/MARAGDA
/system/ROOT.FS
/system/WHOLE.FS
</pre><div class="itemizedlist"><ul type="disc"><li><p>If that is found, it then states which device will
be the new root file system:</p></li></ul></div><pre     class="programlisting">
mount -n /proc /proc -t proc
echo 0x101 &gt; /proc/sys/kernel/real-root-dev
(0x101 represents /dev/ram1)
</pre><div class="itemizedlist"><ul type="disc"><li><p>It dumps WHOLE.FS on /dev/ram1.</p></li><li><p>Finally, it writes on
<span   class="bold"><b>cdrom_dev</b></span> which device the .FS
files were found. This file will be consulted during the
second-stage boot.</p></li></ul></div><p>If everything goes okay, the boot process will continue by
executing <span   class="bold"><b>init</b></span>, already in the new
root file system. The old file system (initrd) will remain mounted
under /initrd on the new one.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x176d580.0x185e360"></a>ROOT.FS and WHOLE.FS</h2></div></div><p>These files are created by the scripts on the system working
directory and the files found there, starting with the source
installation.</p><p><span   class="bold"><b>Cp_root</b></span> is in charge of
creating ROOT.FS, while <span   class="bold"><b>Cp_whole</b></span>
will build WHOLE.FS. Both scripts use
<span   class="bold"><b>Make_fs</b></span> to create file systems
inside a file.</p><p>ROOT.FS should contain files and directories that need to be
written and cannot live on a read-only file system. Writing will be
possible since ROOT.FS will reside on a RAM disk. It is difficult
to find out exactly what is required to be in ROOT.FS. After
several attempts, I decided to copy at least the following
directories: bin, sbin, lib (including lib/modules), home, var,
etc.</p><p>For those directories notcopied, symbolic links are created,
pointing to where WHOLE.FS will be mounted once Maragda is running
(/mnt/whole_fs).</p><p>In addition, binaries and libraries are unstripped (symbols
removed) to reduce space.</p><p>The configuration files for ROOT.FS are kept under
system/config. Once ROOT.FS is populated from the source
installation, system/config files are written to ROOT.FS
overwriting existing files. Typical system/config files are:</p><div class="itemizedlist"><ul type="disc"><li><p>the /home/jordi directory</p></li><li><p>/etc/X11/X and /etc/X11/XF86Config for configuring
X</p></li><li><p>/etc/hosts* and /etc/sysconfig/network-scripts, for
setting up network</p></li><li><p>/etc/passwd, for users' accounts</p></li><li><p>/etc/rc.d/init.d/* files, to drive the startup
process</p></li></ul></div><p>Especially important is the script
system/config/etc/rc.d/rc.sysinit. It is run by init (in the
second-stage boot). I patched it to complete the Maragda system. It
adds some lines to Maragda's /etc/fstab to reflect where the CD is
and, therefore, where WHOLE.FS is. Remember that this was announced
by linuxrc (first-stage boot) on the file /initrd/cdrom_dev. Once
fstab is completed, rc.sysinit goes on with the &ldquo;side effect&rdquo;
that WHOLE.FS will be correctly mounted.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x176d580.0x185eb48"></a>Doing Tests</h2></div></div><p>Of course, to test your emerging system, you do not need to
record a CD. It can be booted easily by means of LILO, arranging
files this way:</p><pre     class="programlisting">
/system/MARAGDA
/system/ROOT.FS
/system/WHOLE.FS
/boot/bzImage-rd (the kernel)
/boot/1INITRD.GZ (the initial RAM disk for the first stage boot)
</pre><p>(System may be a symbolic link to the working directory.) You
should add the following entry to
<b  >/etc/lilo.conf</b>:
<pre     class="programlisting">
image=/boot/bzImage-rd
label=maragda
initrd=/boot/1INITRD.GZ
literal="ramdisk_size=20480" # size of ROOT.FS
read-only
vga=0x315
</pre>


and run LILO every time you make any change.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x176d580.0x185edb0"></a>The Source Installation</h2></div></div><p>As you have already learned, the source installation is a
directory containing a complete, installed Linux system. It can be
the source for copying the ROOT.FS and WHOLE.FS files or even for
installing Linux onto a hard-disk partition or onto a 250MB zip
floppy. The script <span   class="bold"><b>Prepare_install</b></span>
(under the system working directory) sets up a directory to receive
RPM packages. Then, you can use
<span   class="bold"><b>Install_rpm</b></span> to install those
packages onto the source-installation directory.</p><p><span   class="bold"><b>Install_rpm</b></span> installs
packages from the Red Hat's 6.2 distribution CD (or from another
place, if you change it). The names of packages to be installed are
grouped in files under system/RPM_lists. For instance, base_inst
lists the packages for the base-system installation. I created the
listing files starting with the file RedHat/base/comps on the Red
Hat CD.</p><p>If you install the packages in the right order (as it appears
on Install_rpm) they should be installed with no problem.
Install_rpm also reports which packages were not installed. In the
case of base_inst it creates base_inst_not_installed. This is the
only group of rpms that poses a problem. But, if you tell
Install_rpm to install packages on base_inst_not_installed, finally
all packages will be installed.</p><p>You may find all the scripts used on
http://navel.eugan.upv.es/maragda/doc, including raw CD images of
Maragda (and the instructions to record them).</p><p>Enjoy it.</p></div></div>
<div class="authorblurb"><p>
        <div       class="mediaobject"><img src="4396aa.jpg"></div>

        <span   class="bold"><b>Jordi Bataller</b></span>
      was born in Ador (a little town whose people cultivate orange
      trees) thirty years ago. He has been studying Linux since 1992 and
      hopes to do so for life. He works as a professor at the
      Polytechnical College of Gandia and as researcher at the
      Information Technology Institute, both at the Polytechnical
      University of Valencia (Spain) where he received his PhD. In his
      spare time he enjoys swimming and playing the clarinet.</p></div>

  <div class="toclinks">
    <a class="link1" href="../tocindex.html">Archive Index</a>
    <a class="link2" href="../083/toc083.html">Issue Table of Contents</a>
  </div>
  <div class="bottomhrdiv">
  </div>
  
  <div id="bottom_search">
  <table class="page_search" summary="">
    <tr>
      <td valign="top" align="left">
        <p class="small_shutdown"><a href="/.exit">Shutdown Archive web server</a></p>
      </td>
      <td valign="top" align="right">
        <form method="get" action="/zoom/search.cgi">
          <input type="hidden" name="zoom_sort" value="0" />
          <input type="hidden" name="zoom_xml" value="0" />
          <input type="hidden" name="zoom_per_page" value="10" />
          <input type="hidden" name="zoom_and" value="1" />
          Search: <input type="text" name="zoom_query" size="20" value="" class="zoom_searchbox" />
          <input type="submit" value="Submit" />
        </form>
      </td>
    </tr>
  </table>
  </div>
  
  <div class="footerdiv">
    <a href="../../index.html">
      <img class="bottomimg" src="../../images/CD_FooterBanner.png" alt="LJ Archive"/>
    </a>
  </div>
  
  <div class="copyright">
    Copyright &copy; 1994 - 2018 <cite>Linux Journal</cite>.  All rights reserved.
  </div>
  </body></html>