<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"><html><head><META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>Building a Web Weather Station</title><link rel="stylesheet" href="../css/archive.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.57.0"><meta name="description" content="&#10;    Mr. Howard tells us how he gathers and outputs weather&#10;    information to the Web using Linux, Perl and automated FTP.&#10;    "><meta name="keywords" content="Perl, WWW, weather, programming"><link rel="stylesheet" href="../../css/archive.css" type="text/css"><script type="text/javascript" src="../../js/archive.js"></script><script type="text/javascript" src="../../js/highlight.js"></script></head><body onload="search_highlight();">
  <div class="headerdiv">
    <a href="../../index.html">
      <img class="topimg" src="../../images/CD_HeaderBanner.png" alt="LJ Archive"/>
    </a>
  </div>
  
  <div class="tophrdiv">
  </div>
  
  <div id="top_search">
  <table class="page_search" summary="">
    <tr>
      <td valign="top" align="left">
        <p class="small_shutdown"><a href="/.exit">Shutdown Archive web server</a></p>
      </td>
      <td valign="top" align="right">
        <form method="get" action="/zoom/search.cgi">
          <input type="hidden" name="zoom_sort" value="0" />
          <input type="hidden" name="zoom_xml" value="0" />
          <input type="hidden" name="zoom_per_page" value="10" />
          <input type="hidden" name="zoom_and" value="1" />
          Search: <input type="text" name="zoom_query" size="20" value="" class="zoom_searchbox" />
          <input type="submit" value="Submit" />
        </form>
      </td>
    </tr>
  </table>
  </div>
  <div class="article" lang="en"><div class="titlepage"><div><h1 class="title"><a name="N0x26da580.0x27d1ab0"></a>Building a Web Weather Station</h1></div><div><div class="author"><h3 class="author">Chris Howard</h3></div><div class="issuemoyr">Issue #56, December 1998</div></div><div><p>
    Mr. Howard tells us how he gathers and outputs weather
    information to the Web using Linux, Perl and automated FTP.
    </p></div></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x26da580.0x27d2558"></a></h2></div></div><p>Last fall, my family and I moved from
central Iowa to the little mountain resort town of Estes Park,
Colorado. Estes Park is a beautiful town at the east entrance of
Rocky Mountain National Park. More than three million tourists
visit the park each summer.
</p><p>When we moved here, I brought along my fledgling consulting
business, Daylight Software, and set up web pages to drum up a
little work. In a flash of inspiration, I decided I would either
buy or build weather station equipment and offer weather data on
the Web. Visitors from around the nation&mdash;and the globe&mdash;would see
my web pages, and Daylight Software would be established as a Linux
consulting powerhouse. Well, maybe it wouldn't lead to global
domination, but it would surely be a good thing. I saw it as a
community service, since no public weather reporting service was
available, other than the time and temperature sign on one of the
local banks.</p><p>After some investigation, I decided that my hardware
development skills were not sufficient to design and build weather
sensors. I shopped around and eventually purchased a Texas Weather
Instruments &ldquo;Weather Report&rdquo; WRL-25 system from American Weather
Enterprises of Media, PA (http://www.americanweather.com/).</p><p>The WRL-25 is like many weather stations in that it includes
an RS-232 connection and comes with DOS/Windows software for
downloading and viewing the gathered data. It has sensors for wind
speed, wind direction, temperature, humidity, atmospheric pressure
and rainfall. Using a regular television antenna mast and fittings,
I mounted the weather station sensors on the roof of my house,
snaking the sensor cables through the attic space and down to my
office in the basement. I mounted the handsome display unit on a
shelf in the office.</p><p>Across the room from the weather display is my array of
computers, including my Linux workstation. I am running the Red Hat
4.0 Colgate release, 2.0.18 kernel, on my AMD 486DX-4 120MHz ISA
server. I built a cable and attached the weather display to the
Boca AT-66 serial card in the server. I then wrote some Perl
scripts to build HTML and GIF files and upload them to my ISP, and
to manage the data readings put out by the weather station.</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x26da580.0x27d27c0"></a>Equipment Installation</h2></div></div><p>The sensors are mounted on two ten-foot sections of steel TV
antenna mast, available in the U.S. from stores such as Radio
Shack. Approximately four feet are buried in the ground, and the
rest of the mast is vertical at the gable end of our single-story
house. The mast is attached with a TV mast bracket at the roof line
of the house. About six feet of mast projects above the roof
line.</p><p><a href="2538f1.jpg" target="_self"><span   class="bold"><b>Figure 1.
Weather Sensors on TV Antenna Mast</b></span></a></p><p>The sensors came supplied with clamps and hardware to attach
them to the mast. (See Figure 1.) I followed the installation
instructions and mounted the wind direction/speed sensor module
pointed north at the top of the mast. The temperature and humidity
sensors are in a &ldquo;pagoda&rdquo; enclosure to protect them from direct
sunlight, and the pagoda is mounted about three feet above the roof
line. The rain collector is mounted at the roof line; I used a
carpenter's level to mount it properly.</p><p><a href="2538f2.jpg" target="_self"><span   class="bold"><b>Figure 2. Wires
from Junction Box into House</b></span></a></p><p>Multi-wire cables from the sensor modules go into the bottom
of the junction box, where they are plugged into matching
connectors from 100-foot cables which run to the weather display
unit. (See Figure 2.) All excess cable is coiled up and attached
securely under the eave. Cables going into the junction box were
left drooping slightly, to encourage rain to drip off instead of
flowing into the junction box.</p><p>The 100-foot cables run through the attic and out through a
hole at the peak of the eave. The hole was later filled with
caulking to discourage squirrels and other pests from getting in.
From the attic, I drilled a hole in the top plate of an interior
wall and snaked the cables down to the basement. A fancy wooden
switchplate made for cable TV installations serves to mask the hole
where the cables come through the wall into my office/computer
area. The cables connect to the back of the WRL-25 display
unit.</p><p>I ended up crawling through the blown-in fiberglass
insulation in the attic more times than I care to remember. If you
do this, be careful&mdash;wear a dust mask or respirator and long
sleeves and trousers. The attic was hot. I considered this to be
the most difficult part of the installation.</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x26da580.0x27d2c38"></a>RS-232 Connection and WRL-25
Configuration</h2></div></div><p>I had to set the current time on the display unit and change
some of the option settings. Other than that, the sensors and other
features of the WRL-25 were all calibrated and ready to run.</p><p>On the back of the display unit is a 9-pin serial pigtail.
The WRL-25 came with a mix-and-match 4-ended 25 and 9 pin serial
cable for adapting to whatever connectors are available. I did not
use that particular cable. My Boca Io-AT-66 six-port serial card
uses RJ-45 sockets for its connections. So, I made a cable from a
ten-foot scrap of eight-wire twisted pair that already had an RJ-45
connector crimped on one end. Pin assignments and wiring
information were included in the Io-AT-66 documentation.</p><p>The WRL-25 can be programmed to periodically send a status
report over the serial line. This can be used to print directly on
a serial printer. I programmed my unit to send a reading every 5
minutes. I also changed an optional setting to allow the rainfall
rate report and to print a daily Max/Min report at the end of each
day. I set the serial line data rate to 9600bps.</p><p>The unit can also be directed using single-character commands
through the serial connection. I rarely use this feature. The PC
software that came with the unit can be used to set various options
and settings, as can the buttons on the display panel. So, more
sophisticated programming could be used to query the unit on demand
or change various features. I elected to use the simple logging
feature to gather my data.</p><p>I was able to run a quick test on my setup by using the
following command:</p><pre     class="programlisting">
cat &lt; /dev/ttyS19
</pre><p>This command takes any input appearing on the /dev/ttyS19
serial line and echoes it to the screen. Pushing the manual report
button on the WRL-25 produced a one-line report on the screen. I
was a happy camper!
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x26da580.0x27d2f50"></a>WRL-25 Data Report Format</h2></div></div><p>Reports that come down the serial line look like this:</p><pre     class="programlisting">
17:05 08/09/97 WSW 00MPH 460F 069F 057F 085% 23.42F 00.00"D
01.39"M 00.00"R
</pre><p>The first two fields are time and date. The current time and
date are maintained on the WRL-25 display unit. I have not noticed
any great drift in the time setting.
</p><p>The second two fields are wind direction (WSW&mdash;West by South
West) and speed (00 MPH&mdash;miles per hour).</p><p>Fields 5 through 7 are temperature readings in degrees
Fahrenheit. Field 5 is not connected to any sensor, so it should be
ignored. Field 6 is indoor temperature and field 7 is outdoor
temperature.</p><p>Field 8 is relative humidity, which in this example is 85%.
Field 9 is atmospheric pressure in inches of mercury accompanied by
a single character for falling (F), rising (R) or steady
(S).</p><p>The last three fields are daily rainfall and monthly
rainfall, both in inches, and rainfall rate in inches per
hour.</p><p>At the end of each day, two lines of daily minimum and
maximum readings are reported:</p><pre     class="programlisting">
Max 08/08/97 WSW 24MPH 460F 074F 081F 100% 23.42" 00.00"D
01.39"M 00.00"R
Min 08/08/97 SW 00MPH 460F 068F 044F 021% 23.28" 00.00"D
01.39"M 00.00"R
</pre><p>These lines are in the same format as the other reports,
except for the first field which marks these records as Max/Min
reports. The readings for daily min/max are independent. In the
above example, the high temperature for the day was 81 degrees F
and the highest humidity reading was 100%. These readings did not
occur at the same time and are unrelated, except that both are the
maximum for that particular statistic.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x26da580.0x27d3370"></a>Programming for Data Collection</h2></div></div><p>My first pass at a data collection script was a simple cat
command:</p><pre     class="programlisting">
cat /dev/ttyS19 &gt;&gt; data1
</pre><p>It worked&mdash;mainly by accident. The next time my machine was
rebooted, it didn't work at all. When I fired it up, the weather
station console started spitting out all sorts of long reports.
After a little head scratching, it became obvious that regular
character echoing was feeding back command characters&mdash;not at all
what I had in mind.
</p><p>My current script is called weatherd.pl and is shown in
<a href="2538l1.html" target="_self">Listing 1</a> with blank lines
removed. Line 8 sets the variable <b  >$TTY</b> to be the
first command-line argument. Line 10 resets the terminal to the
appropriate speed, parity and non-echoing. I used the
<span   class="bold"><b>stty</b></span> command to get the terminal
settings the way I wanted them, then saved the setup to a file.
This stty command reads from that file and sets the terminal to the
saved configuration.</p><p>Data is kept in a file, with the name of the file being the
current date. Each day's data goes into one file (lines 14-16). The
print statement on line 16 helps me feel confident things are
working right. Beginning with line 27, for each data line that
comes in from the tty, we check to see if it is a minimum or
maximum and that it is still today's data. Minimum and maximum data
go into separate files.</p><p>To start weatherd.pl, I added the following single line to my
/etc/inittab file:</p><pre     class="programlisting">
ws:2345:respawn:/home/weather/bin/weatherd.pl /dev/ttyS19
</pre><p>This line starts up weatherd.pl and respawns it if it should
die for any reason.
</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x26da580.0x27d37e8"></a>Programming for Data Display on WWW Page</h2></div></div><p>Now I had the data coming in from the weather station,
getting picked up by weatherd.pl and thrown into a file using the
date as its name.</p><p>The next step was to format the data into an HTML file for
display over the Web. I wrote a Perl script
<a href="2538l2.html" target="_self">(Listing 2)</a> that takes the last
line from the current data file, in combination with a template
HTML file, and fills in the weather information. It also calculates
the corrected atmospheric pressure and the dew point. (The dew
point calculation was given to me by John Kleist, Colorado Climate
Center, johnk@loki.atmos.colostate.edu.) Last of all, it looks in
yesterday's Max/Min files and puts those values in the output
HTML.</p><p>I also wrote a script, plotdays.pl
<a href="2538l3.html" target="_self">(Listing 3)</a>, that plots some of
the interesting statistics for the last few days.</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x26da580.0x27d3a50"></a>Programming for Reliable Periodic FTP
Upload</h2></div></div><p>Finally, I have a master program called loop.pl, which I
wrote to reliably connect to my ISP, set up my PPP connection,
transfer e-mail, set the system time and upload the weather
data.</p><p>First, we have to look at how to automate an FTP connection.
FTP is usually used for interactive network file transfer. To use
regular FTP, you need to have an account on the remote machine. In
this case, I use my ISP shell account with Front Range Internet
(frii.net). A user can set up an automated FTP session by using a
file called .netrc in their $HOME directory. I added to my system a
user called &ldquo;weather&rdquo; dedicated to owning the weather data files
and scripts. In the /home/weather/.netrc file, I have the following
lines:</p><pre     class="programlisting">
machine ftp.frii.net
login:
password:
macdef init
cd public_html
put /home/weather/WWW/wscurrent.html wscurrent.html
put /home/weather/WWW/wsplot.html wsplot.html
put /home/weather/WWW/temp.gif temp.gif
put /home/weather/WWW/pressure.gif pressure.gif
put /home/weather/WWW/raind.gif raind.gif
put /home/weather/WWW/winds.gif winds.gif
quit
</pre><p>The statements in this file define and execute a macro called
<span   class="bold"><b>init</b></span>. All I have to do is start
FTP and this script attempts to run the macro, uploading my HTML
and GIF files to the appropriate place on my ISP account.
</p><p>Both Listing 1 and Listing 3 are called from a short script
called doup, <a href="2538l4.html" target="_self">Listing 4</a>, which also
does the actual FTP call.</p><p>Last but not least, loop.pl <a href="2538l5.html" target="_self">(Listing
5)</a>, is executed continuously by the root user. The only
tricky part of loop.pl is the necessity to recover if a command
gets stuck due to a loss of connection with the ISP. I wrote a
replacement for the regular Perl &ldquo;system&rdquo; function which allows
me to specify a timeout for each command. If that command exceeds
the time alloted, it and all of its children are killed. Loop.pl
also has other jobs to do, like downloading and uploading my e-mail
and setting the system time using
<span   class="bold"><b>ntpdate</b></span>. While those jobs are
happening, I have a child process simultaneously running the doup
script. If the ancillary jobs finish first, they give doup a little
more time to complete. With a good connection, there is no problem
getting everything done in less than one minute.</p><p>I have two different dial-up scripts, because there are two
possible telephone numbers for the computer to try when dialing my
ISP. If the primary number fails, it tries the second number. If
both fail, it sleeps for 60 seconds and tries again. The goal of
the sleep statements in loop.pl is to have the connection occur
approximately every 15 minutes. Otherwise, the comments in the code
pretty much cover all of the details.</p></div><div class="simplesect" lang="en"><div class="titlepage"><div><h2 class="title"><a name="N0x26da580.0x2bcc118"></a>Unresolved Issues</h2></div></div><p>One of my main concerns is lightning. Fortunately, our site
is in a wooded area that is somewhat protected from direct
lightning strikes. Still, I would feel even better if the remote
weather sensors were electrically isolated from the display unit
and my Linux machine. Some sort of optical isolation would probably
work.</p><p>Also, I may have to develop an automated way to set the clock
on the weather display unit.</p><p>Otherwise, the system seems to be working pretty well. With
weatherd.pl running from the inittab, and with loop.pl in my
startup rc files, the weather station monitoring continues after a
reboot without manual intervention. Power loss or server failure
will interrupt the service, but neither of those are common
occurrences.</p><p><a href="2538f3.jpg" target="_self"><span   class="bold"><b>Figure 3.
Weather Web Page</b></span></a></p><p>My weather station web page (see Figure 3) can be found at
http://www.frii.net/~daylight/wscurrent.html. Please stop by and
check it out. If you have the opportunity, come to Estes Park and
see what a beautiful place it is.</p><p>All listings referred to in this article are available by
anonymous download in the file
<a href="../listings/056/2538.tgz" target="_self">ftp.linuxjournal.com/pub/lj/listings/issue56/2538.tgz</a>.</p></div></div>
<div class="authorblurb"><p>
        <div       class="mediaobject"><img src="2538aa.jpg"></div>
            <span   class="bold"><b>Chris Howard</b></span>
            (<a href="mailto:daylight@frii.net">daylight@frii.net</a>)
            noodles around with Linux stuff in
            Estes Park, Colorado, where the winters aren't too cold and the
            summers aren't too hot, and the view out the window is always
            beautiful.
          </p></div>

  <div class="toclinks">
    <a class="link1" href="../tocindex.html">Archive Index</a>
    <a class="link2" href="../056/toc056.html">Issue Table of Contents</a>
  </div>
  <div class="bottomhrdiv">
  </div>
  
  <div id="bottom_search">
  <table class="page_search" summary="">
    <tr>
      <td valign="top" align="left">
        <p class="small_shutdown"><a href="/.exit">Shutdown Archive web server</a></p>
      </td>
      <td valign="top" align="right">
        <form method="get" action="/zoom/search.cgi">
          <input type="hidden" name="zoom_sort" value="0" />
          <input type="hidden" name="zoom_xml" value="0" />
          <input type="hidden" name="zoom_per_page" value="10" />
          <input type="hidden" name="zoom_and" value="1" />
          Search: <input type="text" name="zoom_query" size="20" value="" class="zoom_searchbox" />
          <input type="submit" value="Submit" />
        </form>
      </td>
    </tr>
  </table>
  </div>
  
  <div class="footerdiv">
    <a href="../../index.html">
      <img class="bottomimg" src="../../images/CD_FooterBanner.png" alt="LJ Archive"/>
    </a>
  </div>
  
  <div class="copyright">
    Copyright &copy; 1994 - 2018 <cite>Linux Journal</cite>.  All rights reserved.
  </div>
  </body></html>